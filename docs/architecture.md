# AI Resume Localizer 系统架构

## 概述

AI Resume Localizer 是一个全栈应用，用于将中文简历转换为符合日本企业招聘标准的日文简历 PDF（履歴書 + 職務経歴書）。系统采用前后端分离架构，利用 Dify Cloud 工作流进行 LLM 处理，通过 Playwright 实现高保真 PDF 渲染。

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户界面层                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     React 19 + Vite + Tailwind CSS                   │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐ │   │
│  │  │UploadStep│→ │ReviewStep│→ │PreviewStep│→ │    PDF Download     │ │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────────────┘ │   │
│  │       ↓              ↓              ↓                               │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │              useResumeStore (Zustand 状态机)                 │   │   │
│  │  │   rawText → cnResumeData → jpResumeData → previewHtml       │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              后端服务层                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        FastAPI + Python 3.12                         │   │
│  │  ┌───────────────────┐  ┌───────────────────┐  ┌─────────────────┐  │   │
│  │  │ /upload-and-extract│  │    /translate     │  │ /preview,/download│  │   │
│  │  └─────────┬─────────┘  └─────────┬─────────┘  └────────┬────────┘  │   │
│  │            │                      │                      │           │   │
│  │  ┌─────────▼─────────┐  ┌─────────▼─────────┐  ┌────────▼────────┐  │   │
│  │  │   DifyClient      │  │   DifyClient      │  │ TemplateRenderer│  │   │
│  │  │ .extract_resume() │  │ .translate_resume()│  │  + PDFGenerator │  │   │
│  │  └─────────┬─────────┘  └─────────┬─────────┘  └─────────────────┘  │   │
│  └────────────┼─────────────────────────┼──────────────────────────────┘   │
└───────────────┼─────────────────────────┼──────────────────────────────────┘
                │                         │
                ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Dify Cloud 工作流层                                │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │   resume_extraction.yml     │  │      resume_translation.yml          │  │
│  │  ┌───────┐  ┌───────┐      │  │  ┌───────┐  ┌───────┐  ┌──────────┐  │  │
│  │  │ Start │→ │  LLM  │→ Code │  │  │ Start │→ │  LLM  │→ │  Code    │→ End│
│  │  └───────┘  └───────┘      │  │  └───────┘  └───────┘  └──────────┘  │  │
│  │       ↓                    │  │       ↓                             │  │
│  │  简历文本 → CnResumeData   │  │  CnResumeData → JpResumeData        │  │
│  └─────────────────────────────┘  └─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             LLM 提供商层                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    OpenRouter → Google Gemini 3 Flash                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流

```
用户上传简历
    │
    ▼
┌─────────────────┐
│   文件解析      │  PDF/图片 → 纯文本 (pdfplumber/OCR)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   结构化提取    │  纯文本 → CnResumeData JSON (Dify extraction workflow)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   人工审核      │  用户可编辑 CnResumeData 任意字段
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   日文翻译      │  CnResumeData → JpResumeData JSON (Dify translation workflow)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   预览确认      │  Jinja2 模板渲染 + Playwright PDF 预览
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   PDF 下载      │  履歴書.pdf + 職務経歴書.pdf
└─────────────────┘
```

## 架构设计原则

### 为什么不把所有逻辑放在 Dify 中？

Dify 是一个**工作流编排工具**，而非完整的应用平台。将所有逻辑放在 Dify 中存在以下问题：

| 方面 | Dify 单独使用 | 前后端分离架构 |
|------|--------------|--------------|
| 用户体验 | 页面跳转、无状态保持 | SPA 流畅体验、实时预览 |
| 状态管理 | 无内置状态管理 | Zustand 状态机，支持断点续传 |
| 离线编辑 | 不支持 | 本地状态持久化，可离线编辑 |
| 错误处理 | 基础错误提示 | 细粒度错误分类和用户友好提示 |
| UI 定制 | 受限于 Dify UI | 完全自定义的 React 组件 |

### 前后端分离的好处

1. **更好的用户体验**：React SPA 提供流畅的交互体验，无需页面刷新
2. **状态管理**：Zustand 状态机管理整个工作流程，支持断点续传
3. **API 编排模式**：后端作为 BFF（Backend for Frontend），隐藏 Dify 复杂性
4. **安全性**：敏感 API Key 只存在于后端，不暴露给前端
5. **可测试性**：前后端可独立测试

### 为什么将提取和翻译分为两个工作流？

1. **关注点分离**：提取（OCR → 结构化）和翻译（中文 → 日文）是独立的问题域
2. **独立调优**：可以单独调整每个工作流的 prompt 而不影响另一个
3. **人工审核**：在两个工作流之间插入审核步骤，用户可以修正提取错误
4. **可扩展性**：未来可以添加更多语言对，只需新增翻译工作流

### API 编排模式

后端作为 BFF（Backend for Frontend），负责：

```
Frontend  ←──→  FastAPI BFF  ←──→  Dify Cloud
                      │
                      ├── 调用 Dify API
                      ├── 处理超时和错误
                      ├── CoT 标签清理（安全网）
                      ├── JSON 验证和解析
                      └── PDF 生成（Playwright）
```

## 技术栈

| 层级 | 技术 | 职责 |
|------|------|------|
| **前端** | React 19 + Vite | 用户界面、向导流程 |
| **样式** | Tailwind CSS v4 | 响应式布局、主题 |
| **状态** | Zustand | 全局状态管理 |
| **国际化** | i18next | 中日双语支持 |
| **后端** | FastAPI | API 路由、业务逻辑 |
| **PDF** | Playwright (Chromium) | 高保真 PDF 渲染 |
| **模板** | Jinja2 | HTML 模板渲染 |
| **AI** | Dify Cloud + OpenRouter | LLM 工作流编排 |
| **部署** | Docker Compose + nginx | 容器化部署 |

## 组件架构

### 前端组件

```
frontend/src/
├── steps/                    # 向导步骤页面
│   ├── UploadStep.tsx       # 文件上传、OCR 回退
│   ├── ReviewStep.tsx       # CnResumeData 审核、字段编辑
│   └── PreviewStep.tsx      # JpResumeData 预览、照片上传、PDF 下载
├── components/
│   ├── ui/                  # 通用 UI 组件
│   ├── upload/              # 上传相关组件
│   ├── review/              # 审核相关组件（字段编辑器）
│   └── preview/             # 预览相关组件（PDF 查看器）
├── stores/
│   └── useResumeStore.ts    # Zustand 状态机
├── api/
│   └── client.ts            # API 客户端函数
└── types/
    └── resume.ts            # TypeScript 类型定义
```

### 后端组件

```
backend/app/
├── api/routes/              # API 端点
│   ├── upload.py           # /upload-and-extract
│   ├── translate.py        # /translate
│   └── preview.py          # /preview, /download
├── services/
│   ├── dify_client.py      # Dify Cloud API 异步封装
│   ├── pdf_generator.py    # Playwright PDF 生成
│   ├── template_renderer.py # Jinja2 渲染、和暦转换
│   └── text_extractor.py   # PDF/图片文本提取
├── models/
│   └── resume.py           # Pydantic 数据模型
└── templates/
    ├── rirekisho.html      # 履歴書模板
    ├── shokumukeirekisho.html # 職務経歴書模板
    └── base.css            # 共享样式
```

### Dify 工作流

| 工作流 | 输入 | 输出 | 职责 |
|--------|------|------|------|
| resume_extraction.yml | 简历纯文本 | CnResumeData JSON | 中文简历结构化提取 |
| resume_translation.yml | CnResumeData JSON | JpResumeData JSON | 日文翻译和本地化 |

## 部署架构

```
                    ┌─────────────┐
                    │   nginx     │ :3000
                    │ (反向代理)   │
                    └──────┬──────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  Frontend   │ │   Backend   │ │   Dify      │
    │  (React)    │ │  (FastAPI)  │ │   Cloud     │
    │   :5173     │ │    :8000    │ │  (External) │
    └─────────────┘ └─────────────┘ └─────────────┘
```

## 相关文档

- [模块说明](./modules.md) - 各模块职责和数据流
- [LLM 提示词策略](./llm-prompting.md) - Prompt 工程文档
- [技术挑战与解决方案](./technical-challenges.md) - 关键技术问题
