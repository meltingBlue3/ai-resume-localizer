---
phase: 10-work-project-separation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/resume.py
  - frontend/src/types/resume.ts
  - workflow/resume_translation.yml
autonomous: true
requirements: [RKTPL-04, SKTPL-01, EXTR-03, TRAN-02]

must_haves:
  truths:
    - "JpResumeData has a top-level projects field for personal/side projects"
    - "JpWorkEntry has an optional projects field for company-internal projects"
    - "Translation workflow routes personal projects to projects[] and company-internal projects to work_history[].projects"
    - "work_history contains ONLY employment entries (no merged project_experience)"
  artifacts:
    - path: "backend/app/models/resume.py"
      provides: "JpProjectEntry model, updated JpWorkEntry with projects field, updated JpResumeData with projects field"
      contains: "class JpProjectEntry"
    - path: "frontend/src/types/resume.ts"
      provides: "TypeScript types matching Pydantic models"
      contains: "interface JpProjectEntry"
    - path: "workflow/resume_translation.yml"
      provides: "Updated translation prompt with project classification rules"
      pattern: "プロジェクト分類"
  key_links:
    - from: "workflow/resume_translation.yml"
      to: "JpResumeData"
      via: "LLM output schema"
      pattern: "projects.*\\["
    - from: "JpWorkEntry.projects"
      to: "JpProjectEntry"
      via: "embedded array"
      pattern: "projects.*JpProjectEntry"
---

<objective>
Add project data models and update translation workflow to separate work history from project experience

Purpose: Enable clear separation of employment records from project experience in both resume templates
Output: Extended Pydantic/TypeScript models, updated translation workflow with project classification rules
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-work-project-separation/10-RESEARCH.md

@workflow/DESIGN_PRINCIPLES.md
@.planning/phases/09-workflow-data-cleanup/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JpProjectEntry model and update JpWorkEntry/JpResumeData</name>
  <files>backend/app/models/resume.py, frontend/src/types/resume.ts</files>
  <action>
Add JpProjectEntry class to Pydantic models and TypeScript types, then update JpWorkEntry and JpResumeData.

**Pydantic (backend/app/models/resume.py):**

1. Add new JpProjectEntry class BEFORE JpResumeData:
```python
class JpProjectEntry(BaseModel):
    name: str | None = None
    role: str | None = None
    start_date: str | None = None
    end_date: str | None = None
    description: str | None = None
    technologies: list[str] | None = None
```

2. Add `projects` field to JpWorkEntry (for company-internal projects):
```python
projects: list[JpProjectEntry] | None = None
```

3. Add `projects` field to JpResumeData (for personal/side projects):
```python
projects: list[JpProjectEntry] | None = None
```

**TypeScript (frontend/src/types/resume.ts):**

1. Add JpProjectEntry interface before JpResumeData:
```typescript
export interface JpProjectEntry {
  name?: string | null;
  role?: string | null;
  start_date?: string | null;
  end_date?: string | null;
  description?: string | null;
  technologies?: string[] | null;
}
```

2. Add `projects` field to JpWorkEntry:
```typescript
projects?: JpProjectEntry[] | null;
```

3. Add `projects` field to JpResumeData:
```typescript
projects?: JpProjectEntry[] | null;
```

**Important:**
- Keep all fields optional (nullable) for backward compatibility
- Follow existing naming conventions (snake_case for field names)
- Do NOT add any comments to the code
</action>
  <verify>
cd backend && python -c "from app.models.resume import JpProjectEntry, JpWorkEntry, JpResumeData; print('Pydantic OK')"
cd frontend && npx tsc --noEmit
</verify>
  <done>
Pydantic imports successfully, TypeScript compilation passes, all new fields are nullable
</done>
</task>

<task type="auto">
  <name>Task 2: Update translation workflow to classify and route projects</name>
  <files>workflow/resume_translation.yml</files>
  <action>
Update the LLM prompt in resume_translation.yml to classify project_experience and route appropriately.

**Remove the problematic rule (line ~223):**
```
- project_experience → work_history に統合（末尾に追加）
```

**Add new project classification rules in the 構造変換 section (after the existing rules):**

```yaml
### プロジェクト分類ルール

project_experience は以下のルールで分類・変換する：

1. **会社内プロジェクト**: project_experience[].company が work_experience[].company と一致する場合
   - 該当する work_history エントリの projects[] 配列に埋め込む
   - 変換: position → role, description → description
   - 技術用語が記述されていれば technologies[] に抽出

2. **個人プロジェクト**: project_experience[].company が null または work_experience に一致する会社がない場合
   - 親の projects[] 配列（JpResumeData レベル）に格納
   - 変換: position → role, description → description
   - 技術用語が記述されていれば technologies[] に抽出

3. **分類の原則**:
   - company フィールドが存在しない、または空の場合は個人プロジェクトとみなす
   - 会社名の一致判定は部分一致ではなく完全一致で行う
   - 原文にない情報を追加しない（DESIGN_PRINCIPLES 準拠）
```

**Update the output JSON schema example in the prompt** to show the new projects fields:

In the work_history example, add:
```json
      "projects": [
        {
          "name": "プロジェクト名",
          "role": "役割",
          "start_date": "YYYY-MM",
          "end_date": "YYYY-MM または null",
          "description": "プロジェクト概要",
          "technologies": ["技術1", "技術2"]
        }
      ]
```

After work_history array, add top-level projects example:
```json
  "projects": [
    {
      "name": "個人プロジェクト名",
      "role": "役割",
      "start_date": "YYYY-MM",
      "end_date": "YYYY-MM",
      "description": "概要",
      "technologies": ["技術"]
    }
  ]
```

**Follow DESIGN_PRINCIPLES.md:**
- LLM only restructures existing data, does not fabricate
- Classification is based on existing company field values
- No content addition
</action>
  <verify>grep -c "プロジェクト分類ルール" workflow/resume_translation.yml && grep -c "会社内プロジェクト" workflow/resume_translation.yml</verify>
  <done>Translation prompt contains project classification rules, old merge rule removed, output schema updated with projects fields</done>
</task>

<task type="auto">
  <name>Task 3: Verify frontend field editor handles new projects field</name>
  <files>frontend/src/components/review/JpResumeFieldEditor.tsx</files>
  <action>
Check if JpResumeFieldEditor.tsx needs updates for the new projects field.

1. Read the current JpResumeFieldEditor.tsx to understand its structure
2. If it iterates over work_history with editors, the new projects field within work_history entries will be handled automatically by existing patterns
3. If there's a top-level projects section editor needed, verify it exists or is not needed (projects typically edited within work_history context or as separate section)

Most likely NO changes needed - the component likely uses dynamic field rendering or explicit field lists. Just verify the component won't crash with new fields and document findings.

**Verification approach:**
- Check if component uses dynamic iteration (Object.keys, for-in) - will auto-handle new fields
- Check if component uses explicit field list - may need to add projects
- Check if projects is a top-level field or embedded in work_history - affects where UI is needed
</action>
  <verify>cd frontend && npx tsc --noEmit</verify>
  <done>TypeScript compilation passes, JpResumeFieldEditor handles new projects field gracefully (either dynamically or no changes needed)</done>
</task>

</tasks>

<verification>
1. Pydantic models import without error
2. TypeScript compilation passes with zero errors
3. Translation workflow YAML contains project classification rules
4. Old "project_experience → work_history に統合" rule removed
5. Output schema in prompt includes projects fields
</verification>

<success_criteria>
- JpProjectEntry model exists in both Pydantic and TypeScript
- JpWorkEntry has optional projects field
- JpResumeData has optional projects field
- Translation workflow routes projects based on company association
- Frontend TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-work-project-separation/10-01-SUMMARY.md`
</output>
