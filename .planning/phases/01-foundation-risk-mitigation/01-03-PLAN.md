---
phase: 01-foundation-risk-mitigation
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - backend/app/templates/shokumukeirekisho.html
  - backend/app/services/__init__.py
  - backend/app/services/pdf_generator.py
  - backend/app/main.py
  - backend/tests/__init__.py
  - backend/tests/test_pdf_generation.py
autonomous: false

must_haves:
  truths:
    - "Static 職務経歴書 HTML template renders correctly as an A4 PDF via WeasyPrint with proper chronological format"
    - "WeasyPrint generates 履歴書 PDF with embedded CJK fonts — all Japanese characters display correctly (no tofu glyphs)"
    - "WeasyPrint generates 職務経歴書 PDF with embedded CJK fonts — all Japanese characters display correctly"
    - "PDF generation tests validate both templates produce valid PDFs larger than 10KB (confirming font embedding)"
  artifacts:
    - path: "backend/app/templates/shokumukeirekisho.html"
      provides: "職務経歴書 HTML template with chronological format"
      min_lines: 80
      contains: "職務経歴書"
    - path: "backend/app/services/pdf_generator.py"
      provides: "WeasyPrint PDF generation service with FontConfiguration and bundled fonts"
      exports: ["generate_pdf"]
      contains: "FontConfiguration"
    - path: "backend/tests/test_pdf_generation.py"
      provides: "PDF rendering validation tests for both templates"
      contains: "test_rirekisho"
  key_links:
    - from: "backend/app/services/pdf_generator.py"
      to: "backend/app/fonts/"
      via: "@font-face url() with absolute file:// path to bundled .ttf files"
      pattern: "url.*file://"
    - from: "backend/app/services/pdf_generator.py"
      to: "FontConfiguration"
      via: "FontConfiguration instance passed to BOTH CSS() constructor and html.write_pdf()"
      pattern: "font_config"
    - from: "backend/tests/test_pdf_generation.py"
      to: "backend/app/services/pdf_generator.py"
      via: "Imports generate_pdf and calls it with template HTML"
      pattern: "generate_pdf"
    - from: "backend/app/main.py"
      to: "backend/app/services/pdf_generator.py"
      via: "API endpoint imports and calls generate_pdf for test generation"
      pattern: "generate_pdf"
---

<objective>
Build the 職務経歴書 template, create the WeasyPrint PDF generation service, and validate that BOTH resume templates render correctly as A4 PDFs with embedded CJK fonts.

Purpose: This is the definitive risk validation for the entire project. If both templates render correctly through WeasyPrint with proper CJK fonts and JIS-compliant layout, the highest technical risk is retired. The PDF generator service created here will be reused in Phase 4 for dynamic template rendering.
Output: A 職務経歴書 HTML template, a reusable PDF generation service, pytest validation, and a test API endpoint. Human verification of generated PDFs confirms visual correctness.
</objective>

<execution_context>
@.planning/phases/01-foundation-risk-mitigation/01-RESEARCH.md
@.planning/phases/01-foundation-risk-mitigation/01-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/templates/base.css
@backend/app/templates/rirekisho.html
@backend/app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build static 職務経歴書 HTML template</name>
  <files>
    backend/app/templates/shokumukeirekisho.html
  </files>
  <action>
    Create a complete static 職務経歴書 (Curriculum Vitae / Work History) HTML template. This is simpler than the 履歴書 — it's a chronological document without the rigid grid structure, more like a formatted Word document.

    **Template structure (1-2 pages, A4):**

    1. **Title**: 「職務経歴書」 centered, 18pt, bold
    2. **Date**: 「令和○年○月○日現在」 right-aligned below title
    3. **Personal info**: Name 「山田 太郎」 right-aligned

    4. **職務要約 (Career Summary)**:
       - Section header with bottom border or background
       - 3-5 line paragraph summarizing career trajectory
       - Example: "エンジニアとして約5年間、Webアプリケーション開発に従事。フロントエンドからバックエンドまで幅広い技術スタックを経験し、チームリーダーとしてプロジェクト管理も担当。"

    5. **職務経歴 (Work History)** — reverse chronological:
       - For each position, a structured block:
         - Company name + period: 「株式会社○○テクノロジー　2020年4月〜現在」
         - 事業内容 (Business): "Webサービスの企画・開発・運営"
         - 従業員数 (Employees): "約200名"
         - Role/Position: 「フロントエンドエンジニア → テックリーダー」
         - 業務内容 (Responsibilities) as bullet list
         - 実績・成果 (Achievements) as bullet list
       - Include 2 sample positions for template completeness

    6. **活かせる経験・知識・技術 (Skills)**:
       - Table format: カテゴリ | 詳細
       - Categories: プログラミング言語, フレームワーク, データベース, その他
       - Example data: TypeScript, React, Python, FastAPI, PostgreSQL, Docker, etc.

    7. **資格 (Certifications)**:
       - Simple list: 取得年月 | 資格名
       - Example: 2022年6月 | 基本情報技術者

    8. **自己PR (Self-PR)**:
       - 2-3 paragraph section highlighting strengths
       - Professional, keigo-appropriate language

    **CSS approach:**
    - Link to `base.css` for @page, font, and base table styles
    - Simpler layout than 履歴書 — can use single-column flow with tables for structured sections
    - Section headers: bold, slightly larger font (12pt), bottom border for visual separation
    - Use `<table>` for skills and certifications (they're naturally tabular)
    - Use `<p>` and `<ul>` for narrative sections (career summary, responsibilities, self-PR)
    - NO flexbox, NO CSS Grid

    **Fill with realistic Japanese sample data** — same person (山田 太郎) as the 履歴書 for consistency.
  </action>
  <verify>
    1. `shokumukeirekisho.html` opens in a browser showing a structured work history document
    2. All sections present: title, career summary, work history (2 positions), skills table, certifications, self-PR
    3. No `display: flex` or `display: grid` in the file
    4. File links to `base.css` for shared styles
    5. At least 80 lines — a complete template, not a stub
  </verify>
  <done>
    A complete 職務経歴書 HTML template exists with all standard sections filled with realistic Japanese sample data, using only WeasyPrint-safe CSS (tables, basic typography, no flexbox/grid).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WeasyPrint PDF generation service, validation tests, and test API endpoint</name>
  <files>
    backend/app/services/__init__.py
    backend/app/services/pdf_generator.py
    backend/app/main.py
    backend/tests/__init__.py
    backend/tests/test_pdf_generation.py
  </files>
  <action>
    **1. Create `app/services/pdf_generator.py`:**

    A reusable service that converts HTML content to PDF bytes using WeasyPrint with bundled CJK fonts.

    Key implementation details:
    - Import `FontConfiguration` from `weasyprint.text.fonts`
    - Import `HTML`, `CSS` from `weasyprint`
    - Resolve `FONTS_DIR` and `TEMPLATES_DIR` from config.py (or compute from `Path(__file__).parent.parent`)
    - Create a `generate_pdf(html_content: str) -> bytes` function:
      a. Create `FontConfiguration()` instance
      b. Create font CSS with `@font-face` declarations using `url('file://{absolute_path}')` for both Regular (400) and Bold (700) weights
         CRITICAL: Use `url()` NOT `local()` — WeasyPrint's local() is unreliable for CJK fonts
         CRITICAL: Use absolute file paths with forward slashes (even on Windows)
      c. Pass `font_config=font_config` to the `CSS()` constructor
      d. Create `HTML(string=html_content)` instance
      e. Call `html.write_pdf(stylesheets=[base_css, font_css], font_config=font_config)`
         CRITICAL: `font_config` must be passed to BOTH CSS() and write_pdf() — omitting either causes tofu glyphs
      f. Return the PDF bytes

    - Create a `generate_pdf_from_template(template_name: str) -> bytes` convenience function:
      a. Read the HTML file from `TEMPLATES_DIR / template_name`
      b. Read `base.css` from `TEMPLATES_DIR / "base.css"`
      c. Call `generate_pdf()` with the HTML content and base CSS

    - Handle Windows path normalization: convert backslashes to forward slashes in file:// URLs
    - Add proper error handling: catch WeasyPrint exceptions, log warnings

    **2. Create `tests/test_pdf_generation.py`:**

    Validation tests that prove both templates render correctly:

    ```python
    def test_rirekisho_pdf_generation():
        """Verify 履歴書 template generates a valid PDF with embedded fonts."""
        pdf_bytes = generate_pdf_from_template("rirekisho.html")
        assert pdf_bytes is not None
        assert len(pdf_bytes) > 10_000, f"PDF too small ({len(pdf_bytes)} bytes) — fonts likely not embedded"
        assert pdf_bytes[:5] == b'%PDF-', "Output is not a valid PDF"
        # Write to test output for manual inspection
        output_path = Path(__file__).parent / "output" / "rirekisho_test.pdf"
        output_path.parent.mkdir(exist_ok=True)
        output_path.write_bytes(pdf_bytes)

    def test_shokumukeirekisho_pdf_generation():
        """Verify 職務経歴書 template generates a valid PDF with embedded fonts."""
        pdf_bytes = generate_pdf_from_template("shokumukeirekisho.html")
        assert pdf_bytes is not None
        assert len(pdf_bytes) > 10_000, f"PDF too small ({len(pdf_bytes)} bytes) — fonts likely not embedded"
        assert pdf_bytes[:5] == b'%PDF-', "Output is not a valid PDF"
        output_path = Path(__file__).parent / "output" / "shokumukeirekisho_test.pdf"
        output_path.parent.mkdir(exist_ok=True)
        output_path.write_bytes(pdf_bytes)

    def test_pdf_contains_multiple_pages_rirekisho():
        """Verify 履歴書 PDF has exactly 2 pages (personal info + licenses/motivation)."""
        pdf_bytes = generate_pdf_from_template("rirekisho.html")
        # Count page markers in PDF (approximate check)
        page_count = pdf_bytes.count(b'/Type /Page') - pdf_bytes.count(b'/Type /Pages')
        assert page_count >= 2, f"Expected at least 2 pages, got {page_count}"
    ```

    **3. Add test API endpoint to `app/main.py`:**

    Add a `GET /api/test-pdf/{template_name}` endpoint that generates and returns a PDF for manual browser inspection:
    - `template_name` is "rirekisho" or "shokumukeirekisho"
    - Maps to the corresponding .html file
    - Returns `Response(content=pdf_bytes, media_type="application/pdf")`
    - This is a development/test endpoint — will be refined in Phase 4

    **4. Run the tests:**
    ```
    cd backend
    pip install pytest
    python -m pytest tests/ -v
    ```
    All tests must pass. If WeasyPrint fails on Windows, follow the fallback strategy from Plan 02 Task 1 (Docker or MSYS2).

    **5. Verify generated PDFs:**
    - Open `backend/tests/output/rirekisho_test.pdf` — check grid layout, borders, CJK text
    - Open `backend/tests/output/shokumukeirekisho_test.pdf` — check formatting, sections, CJK text
    - If CJK characters show as tofu (□), debug font loading:
      a. Check font file paths are absolute and use forward slashes
      b. Check FontConfiguration is passed to both CSS() and write_pdf()
      c. Check @font-face uses url() not local()
  </action>
  <verify>
    1. `python -m pytest tests/ -v` — all 3 tests pass
    2. `rirekisho_test.pdf` exists in `tests/output/`, file size > 10KB
    3. `shokumukeirekisho_test.pdf` exists in `tests/output/`, file size > 10KB
    4. Start server with `uvicorn app.main:app --port 8000`, visit `http://localhost:8000/api/test-pdf/rirekisho` — browser displays a PDF
    5. Visit `http://localhost:8000/api/test-pdf/shokumukeirekisho` — browser displays a PDF
  </verify>
  <done>
    PDF generator service produces valid PDFs from both templates. All 3 pytest tests pass. Test PDFs are written to `tests/output/` for inspection. API endpoint serves PDFs for browser viewing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify PDF output quality — JIS grid layout and CJK rendering</name>
  <what-built>
    Complete PDF generation pipeline: two HTML resume templates (履歴書 + 職務経歴書) rendered to A4 PDFs via WeasyPrint with embedded Noto Sans JP fonts. Generated test PDFs in `backend/tests/output/`.
  </what-built>
  <how-to-verify>
    1. Open `backend/tests/output/rirekisho_test.pdf` in a PDF viewer:
       - [ ] Title 「履歴書」 displays correctly at top
       - [ ] Grid layout has visible borders forming a table structure
       - [ ] Photo area (30×40mm dashed box) is visible in the top-right of personal info section
       - [ ] All Japanese characters render correctly (no □ tofu glyphs)
       - [ ] Page 2 exists with licenses and motivation sections
       - [ ] Font looks clean and professional (Noto Sans JP)

    2. Open `backend/tests/output/shokumukeirekisho_test.pdf` in a PDF viewer:
       - [ ] Title 「職務経歴書」 displays correctly
       - [ ] Career summary, work history, skills table, and self-PR sections are present
       - [ ] All Japanese characters render correctly (no □ tofu glyphs)
       - [ ] Layout looks like a professional document (not broken/overlapping)

    3. Alternatively, visit these URLs with the backend running (`uvicorn app.main:app --port 8000`):
       - http://localhost:8000/api/test-pdf/rirekisho
       - http://localhost:8000/api/test-pdf/shokumukeirekisho

    **What to check specifically:**
    - CJK characters: 漢字, ひらがな, カタカナ all display (not □)
    - Grid borders: single-line borders (not doubled)
    - Page size: A4 proportions (portrait)
    - Font: clean sans-serif (Noto Sans JP), not system default
  </how-to-verify>
  <resume-signal>Type "approved" if both PDFs look correct, or describe specific issues (e.g., "tofu glyphs on page 2", "borders are doubled", "layout is broken in skills section")</resume-signal>
</task>

</tasks>

<verification>
- 職務経歴書 HTML template has all standard sections with Japanese sample data
- PDF generator service uses FontConfiguration, url()-based @font-face, and passes font_config to both CSS() and write_pdf()
- All 3 pytest tests pass
- Generated PDFs are >10KB (fonts embedded) and start with %PDF- header
- Human has verified both PDFs render correctly with proper CJK characters and layout
</verification>

<success_criteria>
1. 職務経歴書 template is complete with all standard sections
2. Both 履歴書 and 職務経歴書 render as valid A4 PDFs through WeasyPrint
3. All CJK characters display correctly (no tofu glyphs) — confirmed by human inspection
4. 履歴書 grid layout has correct borders and structure — confirmed by human inspection
5. PDF generation tests pass programmatically
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-risk-mitigation/01-03-SUMMARY.md`
</output>
