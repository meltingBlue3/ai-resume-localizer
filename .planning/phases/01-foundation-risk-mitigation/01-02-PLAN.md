---
phase: 01-foundation-risk-mitigation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/.env.example
  - backend/app/__init__.py
  - backend/app/main.py
  - backend/app/config.py
  - backend/app/templates/base.css
  - backend/app/templates/rirekisho.html
  - backend/app/fonts/NotoSansJP-Regular.ttf
  - backend/app/fonts/NotoSansJP-Bold.ttf
autonomous: true

must_haves:
  truths:
    - "FastAPI backend starts and responds to /api/health with 200 OK"
    - "Noto Sans JP font files (Regular + Bold) are bundled in backend/app/fonts/"
    - "base.css defines @page A4, border-collapse: separate, and Noto Sans JP font-family"
    - "Static 履歴書 HTML template contains a complete MHLW-format grid layout using CSS tables with mm-based dimensions"
  artifacts:
    - path: "backend/app/main.py"
      provides: "FastAPI application with CORS and health endpoint"
      exports: ["app"]
      contains: "FastAPI"
    - path: "backend/requirements.txt"
      provides: "Python dependency manifest with pinned versions"
      contains: "weasyprint"
    - path: "backend/app/templates/base.css"
      provides: "Shared print styles for resume PDF templates"
      contains: "border-collapse: separate"
    - path: "backend/app/templates/rirekisho.html"
      provides: "JIS/MHLW-format 履歴書 HTML template with CSS tables"
      min_lines: 150
      contains: "table-layout"
    - path: "backend/app/fonts/NotoSansJP-Regular.ttf"
      provides: "CJK font file for PDF rendering (Regular weight)"
    - path: "backend/app/fonts/NotoSansJP-Bold.ttf"
      provides: "CJK font file for PDF rendering (Bold weight)"
  key_links:
    - from: "backend/app/templates/rirekisho.html"
      to: "backend/app/templates/base.css"
      via: "Stylesheet link in HTML head"
      pattern: "base\\.css"
    - from: "backend/app/templates/base.css"
      to: "Noto Sans JP"
      via: "font-family declaration referencing bundled font"
      pattern: "Noto Sans JP"
---

<objective>
Scaffold the Python/FastAPI backend and build the complete static 履歴書 (rirekisho) HTML template using WeasyPrint-compatible CSS — the highest-risk item in the entire project.

Purpose: De-risks the core technical challenge. The 履歴書 JIS/MHLW format is a rigid tabular grid with exact cell dimensions, merged cells, photo placement, and dense CJK text. If this template can render correctly through WeasyPrint, the rest of the project's PDF generation is straightforward. Also establishes the backend project structure and font bundling strategy.
Output: A FastAPI server, bundled CJK fonts, shared print CSS, and a complete static 履歴書 HTML template ready for WeasyPrint rendering.
</objective>

<execution_context>
@.planning/phases/01-foundation-risk-mitigation/01-RESEARCH.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold FastAPI backend with dependencies, CJK fonts, and shared print CSS</name>
  <files>
    backend/requirements.txt
    backend/.env.example
    backend/app/__init__.py
    backend/app/main.py
    backend/app/config.py
    backend/app/templates/base.css
    backend/app/fonts/NotoSansJP-Regular.ttf
    backend/app/fonts/NotoSansJP-Bold.ttf
  </files>
  <action>
    **1. Create backend directory structure:**
    ```
    backend/
    ├── app/
    │   ├── __init__.py
    │   ├── main.py
    │   ├── config.py
    │   ├── templates/
    │   ├── fonts/
    │   └── services/
    ├── tests/
    ├── requirements.txt
    └── .env.example
    ```

    **2. Create `requirements.txt` with pinned versions:**
    ```
    fastapi==0.115.8
    uvicorn[standard]==0.34.0
    jinja2==3.1.6
    weasyprint==63.1
    python-multipart==0.0.20
    ```
    Note: Use weasyprint 63.1 (stable, widely compatible). Version 68.1 from research may not be released yet — check PyPI and use the latest stable version available. If 63.1 is not available either, use whatever `pip install weasyprint` resolves to.

    **3. Create `app/main.py`:**
    - FastAPI app with title "AI Resume Localizer"
    - CORS middleware allowing `http://localhost:5173` (Vite dev server)
    - `GET /api/health` endpoint returning `{"status": "ok"}`

    **4. Create `app/config.py`:**
    - Use Pydantic BaseSettings (or simple module-level constants) for:
      - `FONTS_DIR`: Path to `app/fonts/`
      - `TEMPLATES_DIR`: Path to `app/templates/`
    - Resolve paths relative to the config file location using `Path(__file__).parent`

    **5. Create `.env.example`:**
    - Placeholder for future env vars (DIFY_API_KEY, etc.)
    - Comment explaining each variable's purpose

    **6. Download Noto Sans JP font files:**
    - Download Regular (400) and Bold (700) weight .ttf files for Noto Sans JP
    - Source: Google Fonts — download the font family zip from `https://fonts.google.com/download?family=Noto+Sans+JP` or use the GitHub noto-fonts repository
    - Place files in `backend/app/fonts/`:
      - `NotoSansJP-Regular.ttf`
      - `NotoSansJP-Bold.ttf`
    - If the download contains variable fonts instead of static weights, download static instances from `https://github.com/google/fonts/tree/main/ofl/notosansjp` or use the variable font file with appropriate @font-face weight declarations
    - Add `backend/app/fonts/*.ttf` pattern to `.gitignore` if font files are >5MB each (add a download script instead), OR commit them if reasonably sized (<5MB each)

    **7. Create `app/templates/base.css` — shared print styles:**
    CRITICAL WeasyPrint constraints (from research):
    - Use `border-collapse: separate; border-spacing: 0` — NOT `border-collapse: collapse` (WeasyPrint bugs #2333, #1278)
    - All dimensions in `mm` for print accuracy
    - Use `@page { size: A4; }` with explicit margins
    - Use `table-layout: fixed` for all tables
    - NO flexbox, NO CSS Grid in this file
    - Font reference via font-family name (actual @font-face with url() will be in the PDF generator service)

    CSS content should include:
    - `@page` rule: size A4, margins 15mm top/bottom, 15mm left/right
    - `body`: font-family 'Noto Sans JP', sans-serif; font-size 10.5pt; line-height 1.4; margin 0; padding 0
    - `table`: table-layout fixed, border-collapse separate, border-spacing 0, width 100%
    - `th, td`: border 0.5pt solid black, padding 2mm, vertical-align top, font-weight normal, text-align left
    - Adjacent border merging: `td + td { border-left: none }`, `tr + tr > td { border-top: none }` to create visual single-border grid
    - `.page`: width 180mm (A4 minus margins), position relative
    - `.page-break`: page-break-before always
    - Photo area: `.photo-cell` with width 30mm, height 40mm, text-align center, vertical-align middle
    - Ruby/furigana: `ruby { ruby-align: center }`, `rt { font-size: 0.5em }`
    - Helper classes: `.text-center`, `.text-right`, `.text-bold`, `.no-border { border: none }`, `.section-header` for section title rows

    **8. Set up Python virtual environment and install deps:**
    ```
    cd backend
    python -m venv .venv
    .venv/Scripts/activate  (Windows)
    pip install -r requirements.txt
    ```
    If WeasyPrint installation fails on Windows due to missing Pango/Cairo/GDK-Pixbuf:
    - First try: `pip install weasyprint` (may auto-resolve on modern Windows with MSYS2 or conda)
    - If that fails: install GTK3 runtime via MSYS2 or use `conda install -c conda-forge weasyprint`
    - Last resort: create a `Dockerfile` for the backend with `FROM python:3.12-slim` and `apt-get install -y libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf-2.0-0`

    **9. Verify FastAPI starts:**
    ```
    cd backend
    .venv/Scripts/activate
    uvicorn app.main:app --reload --port 8000
    ```
    Hit `http://localhost:8000/api/health` — should return `{"status":"ok"}`
  </action>
  <verify>
    1. `pip install -r requirements.txt` completes without errors (or WeasyPrint fallback is documented)
    2. `uvicorn app.main:app --port 8000` starts, `curl http://localhost:8000/api/health` returns `{"status":"ok"}`
    3. Font files exist: `backend/app/fonts/NotoSansJP-Regular.ttf` and `backend/app/fonts/NotoSansJP-Bold.ttf`
    4. `base.css` contains `border-collapse: separate`, `@page`, `table-layout: fixed`
  </verify>
  <done>
    FastAPI server runs on port 8000 with health endpoint. Noto Sans JP fonts are bundled. base.css contains WeasyPrint-compatible print styles with no flexbox/grid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build complete static 履歴書 HTML template with MHLW-format grid layout</name>
  <files>
    backend/app/templates/rirekisho.html
  </files>
  <action>
    Create a complete static 履歴書 HTML template following the 厚生労働省推奨様式 (MHLW recommended format, post-2020). This is the HIGHEST RISK item in the project — the template must render correctly through WeasyPrint, not just in a browser.

    **Template structure (2 pages, A4):**

    **Page 1:**
    1. **Title row**: 「履 歴 書」 (spaced kanji, 18pt) on left, date 「令和○年○月○日現在」 on right — use a 2-column table with no borders
    2. **Personal info section** (table with 3 columns: label ~15mm, content ~auto, photo ~30mm):
       - Row 1: ふりがな label | furigana text (ヤマダ タロウ) | photo area (rowspan=2, 30×40mm dashed border)
       - Row 2: 氏名 label | name (山田 太郎, 18pt font) | (covered by photo rowspan)
       - Row 3: 生年月日 label | birthdate (平成○年○月○日生 満○歳) spanning full width
    3. **Address section** (table):
       - Row 1: ふりがな | address furigana
       - Row 2: 現住所 (〒postal code) | full address
       - Row 3: ふりがな | second address furigana (連絡先)
       - Row 4: 連絡先 (〒postal code) | second address
    4. **Contact row**: 電話 | phone number | E-mail | email address
    5. **Education & Work History section** (the main grid — most complex):
       - 3-column table: 年 (18mm), 月 (12mm), 学歴・職歴 (remaining)
       - Header row with column titles
       - 「学歴」 centered bold label row
       - Education rows with year, month, description (e.g., ○○大学 入学/卒業)
       - 「職歴」 centered bold label row
       - Work history rows with year, month, description
       - Final row: blank, blank, 「以上」 right-aligned
       - Provide ~16 total rows for education + work history (standard count)

    **Page 2** (use `.page-break` class):
    6. **Licenses & Qualifications section**:
       - Same 3-column format: 年, 月, 免許・資格
       - ~6 rows for entries
    7. **Motivation /志望動機・特技・好きな学科・アピールポイントなど**:
       - Large cell (~40mm height) with sample motivation text
    8. **Commute / 通勤時間・扶養家族**:
       - 3-4 cells in a row: 通勤時間 (約○時間○分), 扶養家族(配偶者を除く) (○人), 配偶者 (有・無), 配偶者の扶養義務 (有・無)
    9. **希望記入欄 (Preferences section)**:
       - Single large cell for 本人希望記入欄 with sample text like 「貴社規定に従います。」

    **CRITICAL CSS rules for this template:**
    - Link to `base.css` in the head
    - All tables use `table-layout: fixed` (inherited from base.css)
    - Use `<colgroup>` and `<col style="width: Xmm">` for column widths
    - Use `rowspan` and `colspan` for merged cells (personal info section has photo spanning 2 rows)
    - All height specifications in `mm` via inline styles or CSS classes
    - NO flexbox, NO CSS Grid — tables and basic positioning only
    - Font sizes: title 18pt, name 18pt or 14pt, furigana 8pt, body 10.5pt
    - Fill with realistic sample data in Japanese (not Lorem ipsum) — this is a validation template

    **Sample data to use:**
    - Name: 山田 太郎 (ヤマダ タロウ)
    - DOB: 平成7年4月1日生（満30歳）
    - Address: 〒100-0001 東京都千代田区千代田1-1-1
    - Phone: 090-1234-5678
    - Email: yamada.taro@example.com
    - Education: 東京都立○○高等学校, 東京大学 工学部
    - Work: 株式会社○○テクノロジー
    - License: 普通自動車第一種運転免許, 基本情報技術者
    - Motivation: 貴社のグローバル展開に強い関心を持ち、これまでのエンジニアリング経験を活かして...

    **Testing approach:**
    After creating the template, open `rirekisho.html` directly in a browser to check basic structure. The definitive test (WeasyPrint rendering) will happen in Plan 03. The template should look reasonable in a browser even though the final target is WeasyPrint.
  </action>
  <verify>
    1. `rirekisho.html` opens in a browser showing a recognizable 履歴書 layout with: title, personal info with photo area, address, education/work history table, page 2 with licenses and motivation
    2. HTML contains NO `display: flex` or `display: grid` — verify with a text search
    3. All tables have `table-layout: fixed` (via base.css) and column widths specified in mm
    4. Template has 2 logical pages separated by `.page-break`
    5. File is at least 150 lines — a complete template, not a stub
  </verify>
  <done>
    A complete static 履歴書 HTML template exists at `backend/app/templates/rirekisho.html` with MHLW-format grid layout using only CSS tables with mm dimensions. All sections (personal info, education, work history, licenses, motivation, preferences) are present with realistic Japanese sample data. No flexbox or grid used.
  </done>
</task>

</tasks>

<verification>
- FastAPI runs on port 8000, health endpoint returns 200
- Noto Sans JP Regular + Bold .ttf files exist in `backend/app/fonts/`
- `base.css` uses `border-collapse: separate`, `@page { size: A4 }`, `table-layout: fixed`
- `rirekisho.html` renders a recognizable 履歴書 in browser with all standard sections
- No flexbox or CSS grid used in any template or CSS file
</verification>

<success_criteria>
1. FastAPI backend starts and serves /api/health successfully
2. Complete 履歴書 HTML template with MHLW format exists with realistic Japanese data
3. All CSS follows WeasyPrint-safe patterns (CSS tables, mm units, separate borders)
4. CJK font files are bundled and ready for PDF generation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-risk-mitigation/01-02-SUMMARY.md`
</output>
