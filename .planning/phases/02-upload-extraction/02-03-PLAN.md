---
phase: 02-upload-extraction
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - frontend/src/main.tsx
  - frontend/src/components/review/DocumentViewer.tsx
  - frontend/src/components/review/ResumeFieldEditor.tsx
  - frontend/src/steps/ReviewExtractionStep.tsx
  - frontend/src/i18n/locales/zh/wizard.json
  - frontend/src/i18n/locales/ja/wizard.json
  - frontend/package.json
autonomous: false

must_haves:
  truths:
    - "User sees the original uploaded document rendered on the left side of the review screen"
    - "User sees all extracted resume fields displayed in an editable form on the right side"
    - "User can edit any extracted field and changes persist in Zustand store"
    - "PDF files render with readable text via react-pdf"
    - "DOCX files render with preserved formatting via docx-preview"
    - "User can proceed to the next wizard step after reviewing extracted data"
  artifacts:
    - path: "frontend/src/components/review/DocumentViewer.tsx"
      provides: "Conditional PDF/DOCX document viewer"
      contains: "DocumentViewer"
      min_lines: 30
    - path: "frontend/src/components/review/ResumeFieldEditor.tsx"
      provides: "Editable form for all CnResumeData fields"
      contains: "ResumeFieldEditor"
      min_lines: 80
    - path: "frontend/src/steps/ReviewExtractionStep.tsx"
      provides: "Side-by-side layout replacing placeholder"
      min_lines: 30
  key_links:
    - from: "frontend/src/steps/ReviewExtractionStep.tsx"
      to: "frontend/src/stores/useResumeStore.ts"
      via: "reads resumeFile and cnResumeData from store"
      pattern: "useResumeStore"
    - from: "frontend/src/components/review/DocumentViewer.tsx"
      to: "react-pdf"
      via: "Document + Page components for PDF rendering"
      pattern: "Document|Page"
    - from: "frontend/src/components/review/ResumeFieldEditor.tsx"
      to: "frontend/src/stores/useResumeStore.ts"
      via: "onChange callback → store.setCnResumeData"
      pattern: "setCnResumeData"
---

<objective>
Build the side-by-side review experience: a document viewer displaying the original uploaded file (PDF or DOCX), an editable form showing all extracted resume fields, and the ReviewExtractionStep layout combining both in a dual-panel view.

Purpose: Enable users to visually cross-reference the original resume against extracted data and correct any extraction errors before proceeding to translation.
Output: Fully functional review step with original document preview (left) and editable structured form (right), replacing the Phase 1 placeholder.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-upload-extraction/02-RESEARCH.md
@.planning/phases/02-upload-extraction/02-02-SUMMARY.md

@frontend/src/stores/useResumeStore.ts
@frontend/src/types/resume.ts
@frontend/src/steps/ReviewExtractionStep.tsx
@frontend/src/main.tsx
@frontend/src/i18n/locales/zh/wizard.json
@frontend/src/i18n/locales/ja/wizard.json
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install viewer libraries & create DocumentViewer and ResumeFieldEditor</name>
  <files>
    frontend/package.json
    frontend/src/main.tsx
    frontend/src/components/review/DocumentViewer.tsx
    frontend/src/components/review/ResumeFieldEditor.tsx
    frontend/src/i18n/locales/zh/wizard.json
    frontend/src/i18n/locales/ja/wizard.json
  </files>
  <action>
    **1. Install frontend dependencies:** Run `npm install react-pdf docx-preview` in frontend/. Also install `@types/react-pdf` if available, otherwise the library ships its own types.

    **2. Configure react-pdf worker in frontend/src/main.tsx:**
    - Add at the top (before React rendering): `import { pdfjs } from 'react-pdf';`
    - Set worker as a single-line expression (Pitfall 1 — Vite 7.x regression): `pdfjs.GlobalWorkerOptions.workerSrc = new URL('pdfjs-dist/build/pdf.worker.min.mjs', import.meta.url).toString();`
    - Import required CSS: `import 'react-pdf/dist/Page/TextLayer.css';` and `import 'react-pdf/dist/Page/AnnotationLayer.css';`

    **3. Create frontend/src/components/review/DocumentViewer.tsx:**
    - Props: `file: File`.
    - For PDF (`file.type === 'application/pdf'`): Create blob URL via `URL.createObjectURL(file)`. Render using `<Document file={url}>` with multiple `<Page>` components (use `onDocumentLoadSuccess` to get `numPages`, then map over all pages). Revoke object URL on cleanup. Add scroll container with overflow-y-auto.
    - For DOCX: Use `useRef<HTMLDivElement>` for container. In useEffect, call `file.arrayBuffer().then(buf => renderAsync(buf, containerRef.current))`. Clear container innerHTML before each render (Pitfall 2 — memory leak). Cleanup on unmount by clearing container.
    - Memoize file reference check (only re-render when file changes).
    - Show a subtle loading spinner while document loads.

    **4. Create frontend/src/components/review/ResumeFieldEditor.tsx:**
    - Props: `data: CnResumeData`, `onChange: (data: CnResumeData) => void`.
    - Organize into collapsible sections with headers:
      - **Personal Info**: name, phone, email, date_of_birth, address, nationality, gender — each as a labeled text input. Use a 2-column grid for compact layout.
      - **Education** (`education` array): Each entry shows school, major, degree, start_date, end_date. Add/remove entry buttons. Render as card-like blocks.
      - **Work Experience** (`work_experience` array): Each entry shows company, position, department, start_date, end_date, description (textarea). Add/remove buttons.
      - **Skills** (`skills` array): name + level per entry. Compact layout.
      - **Certifications** (`certifications` array): name + date per entry.
      - **Languages** (`languages` string array): Simple list with add/remove.
      - **Other**: self_introduction (textarea), career_objective (textarea), project_experience (same shape as work_experience), awards (string list), hobbies (text input).
    - All field labels via `useTranslation('wizard')` under `steps.reviewExtraction.fields.*`.
    - On any field change, construct updated CnResumeData and call `onChange(updatedData)`.
    - Handle null arrays gracefully — show empty state with "add" button.
    - Use a helper function for immutable array updates (update item at index, add item, remove item).

    **5. Add i18n keys to both zh/wizard.json and ja/wizard.json:**
    - Section headers: `steps.reviewExtraction.sections.personalInfo` ("基本信息" / "基本情報"), `.education` ("教育经历" / "学歴"), `.workExperience` ("工作经历" / "職歴"), `.skills` ("技能" / "スキル"), `.certifications` ("证书/资格" / "資格・免許"), `.languages` ("语言" / "言語"), `.other` ("其他信息" / "その他")
    - Field labels: `steps.reviewExtraction.fields.name` ("姓名" / "氏名"), `.phone` ("电话" / "電話"), `.email` ("邮箱" / "メール"), `.dateOfBirth` ("出生日期" / "生年月日"), `.address` ("地址" / "住所"), `.nationality` ("国籍" / "国籍"), `.gender` ("性别" / "性別"), `.school` ("学校" / "学校"), `.major` ("专业" / "専攻"), `.degree` ("学位" / "学位"), `.startDate` ("开始日期" / "開始日"), `.endDate` ("结束日期" / "終了日"), `.company` ("公司" / "会社"), `.position` ("职位" / "役職"), `.department` ("部门" / "部署"), `.description` ("描述" / "説明"), `.skillName` ("技能名称" / "スキル名"), `.skillLevel` ("熟练程度" / "レベル"), `.certName` ("证书名称" / "資格名"), `.certDate` ("获取日期" / "取得日"), `.selfIntroduction` ("自我评价" / "自己PR"), `.careerObjective` ("求职意向" / "希望職種"), `.awards` ("获奖情况" / "受賞歴"), `.hobbies` ("兴趣爱好" / "趣味・特技")
    - Actions: `steps.reviewExtraction.addEntry` ("添加条目" / "項目を追加"), `.removeEntry` ("删除" / "削除"), `.noData` ("暂无数据，请返回上传步骤" / "データがありません。アップロードステップに戻ってください")
  </action>
  <verify>
    Run `npm run build` from frontend/ — TypeScript compilation succeeds with react-pdf, docx-preview, and new components.
    Verify no import errors: `grep -r "from 'react-pdf'" frontend/src/` should find DocumentViewer.
    Verify i18n keys exist in both zh and ja wizard.json files.
  </verify>
  <done>DocumentViewer renders both PDF (via react-pdf) and DOCX (via docx-preview) files. ResumeFieldEditor shows all CnResumeData fields as editable form with add/remove for arrays. All labels are bilingual. react-pdf worker configured in main.tsx.</done>
</task>

<task type="auto">
  <name>Task 2: Replace ReviewExtractionStep with side-by-side layout</name>
  <files>
    frontend/src/steps/ReviewExtractionStep.tsx
  </files>
  <action>
    **Replace frontend/src/steps/ReviewExtractionStep.tsx** (full rewrite, remove placeholder):

    - Import useResumeStore (for resumeFile, cnResumeData, setCnResumeData), useWizardStore (for navigation), DocumentViewer, ResumeFieldEditor, useTranslation.
    - **No-data guard**: If `resumeFile` is null or `cnResumeData` is null, show a centered message telling user to go back to upload step (use `steps.reviewExtraction.noData` i18n key). Include a "go back" button that calls `wizardStore.setStep(0)`.
    - **Main layout**: Step header (keep emerald icon style from placeholder). Below header, a dual-panel layout:
      - Use `grid grid-cols-1 lg:grid-cols-2 gap-4` with `h-[calc(100vh-20rem)]` for viewport-filling height.
      - **Left panel**: Rounded border container with `overflow-y-auto`. Panel header showing "原始简历" / "元の履歴書" (i18n key: `steps.reviewExtraction.originalDoc`). Contains `<DocumentViewer file={resumeFile} />`.
      - **Right panel**: Rounded border container with `overflow-y-auto`. Panel header showing "提取结果" / "抽出結果" (i18n key: `steps.reviewExtraction.extractedData`). Contains `<ResumeFieldEditor data={cnResumeData} onChange={setCnResumeData} />`.
    - Both panels scroll independently — critical for cross-referencing long documents against extracted fields.
    - Add i18n keys: `steps.reviewExtraction.originalDoc` ("原始简历" / "元の履歴書"), `steps.reviewExtraction.extractedData` ("提取结果" / "抽出結果").
  </action>
  <verify>
    Run `npm run build` — zero TypeScript errors.
    Start dev server, verify: If no extraction data exists, the no-data message appears with "go back" button. The side-by-side layout renders with correct grid on desktop (two columns) and stacked on mobile (one column).
  </verify>
  <done>ReviewExtractionStep shows side-by-side layout with original document on left and editable form on right. Both panels scroll independently. No-data guard redirects to upload step.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify full upload → extraction → review flow</name>
  <files>None (human verification only)</files>
  <action>
    Human verifies the complete Phase 2 upload and review pipeline: drag-and-drop file upload, optional photo, AI extraction via Dify, and side-by-side review with editable fields.

    **Prerequisites:** Backend running (`uvicorn app.main:app --reload` from backend/), frontend running (`npm run dev` from frontend/), Dify extraction workflow configured with DIFY_EXTRACTION_API_KEY in backend/.env.

    Steps to verify:
    1. Open http://localhost:5173 in browser
    2. **Upload step**: Drag a Chinese PDF resume onto the FileDropzone — verify it shows the filename
    3. Optionally upload a photo — verify thumbnail preview appears
    4. Click the extract button — verify loading spinner appears with "AI正在分析简历..." message
    5. Wait for extraction to complete — verify auto-advance to Review Extraction step
    6. **Review step (left panel)**: Verify the original PDF renders with readable Chinese text
    7. **Review step (right panel)**: Verify extracted fields appear in the editable form — name, phone, email, education entries, work experience entries, etc.
    8. Edit a field (e.g., change the phone number) — verify the change persists
    9. Navigate to a different step and back — verify edited data is preserved
    10. Switch language (中文 ↔ 日本語) — verify all labels switch correctly
    11. **Error case**: Try uploading a non-PDF/DOCX file — verify rejection message appears
    12. **Error case**: If Dify is not configured, verify a clear error message appears (not a crash)
  </action>
  <verify>User types "approved" or describes issues to fix</verify>
  <done>Human confirms: file upload works, extraction produces correct structured data, side-by-side review displays original document and editable fields, field edits persist, bilingual UI works.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with all new components
- DocumentViewer renders PDF files via react-pdf (all pages scrollable)
- DocumentViewer renders DOCX files via docx-preview (formatting preserved)
- ResumeFieldEditor displays all CnResumeData field types (text, textarea, arrays with add/remove)
- ReviewExtractionStep shows dual-panel layout on desktop, stacked on mobile
- Field edits persist in Zustand store across step navigation
- No-data guard shows message when navigating directly to review step
- All UI text bilingual (zh/ja) via i18n
- No memory leaks from DOCX re-rendering (container cleared before each render)
- react-pdf worker loads correctly in both dev and build modes
</verification>

<success_criteria>
Users can review AI-extracted data in a side-by-side view with the original document on the left and editable structured fields on the right. Field edits persist. Both PDF and DOCX formats display correctly. The complete upload → extract → review flow works end-to-end as verified by human testing.
</success_criteria>

<output>
After completion, create `.planning/phases/02-upload-extraction/02-03-SUMMARY.md`
</output>
