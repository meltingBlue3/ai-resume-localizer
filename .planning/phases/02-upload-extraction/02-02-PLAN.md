---
phase: 02-upload-extraction
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/stores/useResumeStore.ts
  - frontend/src/api/client.ts
  - frontend/src/components/upload/FileDropzone.tsx
  - frontend/src/components/upload/PhotoDropzone.tsx
  - frontend/src/steps/UploadStep.tsx
  - frontend/src/i18n/locales/zh/wizard.json
  - frontend/src/i18n/locales/ja/wizard.json
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "User can drag-and-drop or click to select a PDF or DOCX resume file"
    - "User can optionally upload a photo with image preview thumbnail"
    - "Clicking extract triggers backend API call with loading state visible"
    - "On extraction success, result is stored in typed Zustand state and wizard advances"
    - "On extraction failure, error message is displayed to user"
  artifacts:
    - path: "frontend/src/stores/useResumeStore.ts"
      provides: "Typed resume data store with file, extraction, and loading state"
      contains: "useResumeStore"
    - path: "frontend/src/api/client.ts"
      provides: "Typed API client for backend communication"
      exports: ["uploadAndExtract"]
    - path: "frontend/src/components/upload/FileDropzone.tsx"
      provides: "Drag-and-drop file upload for PDF/DOCX"
      contains: "useDropzone"
    - path: "frontend/src/components/upload/PhotoDropzone.tsx"
      provides: "Photo upload with image preview"
      contains: "useDropzone"
    - path: "frontend/src/steps/UploadStep.tsx"
      provides: "Complete upload step replacing placeholder"
      min_lines: 40
  key_links:
    - from: "frontend/src/components/upload/FileDropzone.tsx"
      to: "frontend/src/stores/useResumeStore.ts"
      via: "onFileAccepted → store.setResumeFile"
      pattern: "setResumeFile"
    - from: "frontend/src/steps/UploadStep.tsx"
      to: "frontend/src/api/client.ts"
      via: "uploadAndExtract() call on extract button click"
      pattern: "uploadAndExtract"
    - from: "frontend/src/steps/UploadStep.tsx"
      to: "frontend/src/stores/useResumeStore.ts"
      via: "setExtractionResult on API success, setExtractionError on failure"
      pattern: "setExtractionResult|setExtractionError"
---

<objective>
Build the frontend upload experience: a typed Zustand store for resume data, an API client for backend communication, drag-and-drop file and photo upload components, and a fully functional UploadStep replacing the Phase 1 placeholder.

Purpose: Enable users to upload a Chinese resume file (PDF/DOCX) with optional photo and trigger AI extraction, storing results in typed state for the review step to consume.
Output: Working UploadStep with file selection, photo attachment, extraction trigger, loading/error states, and auto-advance on success.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-upload-extraction/02-RESEARCH.md
@.planning/phases/02-upload-extraction/02-01-SUMMARY.md

@frontend/src/stores/useWizardStore.ts
@frontend/src/steps/UploadStep.tsx
@frontend/src/types/resume.ts
@frontend/src/i18n/locales/zh/wizard.json
@frontend/src/i18n/locales/ja/wizard.json
@frontend/package.json
@frontend/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create typed Zustand store & API client</name>
  <files>
    frontend/src/stores/useResumeStore.ts
    frontend/src/api/client.ts
    frontend/package.json
  </files>
  <action>
    **1. Install react-dropzone:** Run `npm install react-dropzone@14` in frontend/. This installs v14.4.x (not v15 — breaking isDragReject change per research).

    **2. Create frontend/src/stores/useResumeStore.ts:**
    - Import `create` from zustand and `CnResumeData` from types/resume.
    - Define `ResumeState` interface with:
      - Upload state: `resumeFile: File | null`, `photoFile: File | null`
      - Extraction state: `rawText: string | null`, `cnResumeData: CnResumeData | null`
      - UI state: `isExtracting: boolean`, `extractionError: string | null`
      - Actions: `setResumeFile(file: File | null)`, `setPhotoFile(file: File | null)`, `setExtractionResult(rawText: string, data: CnResumeData)` (sets both + clears error + sets isExtracting false), `setCnResumeData(data: CnResumeData)` (for field edits in review step), `setExtracting(loading: boolean)`, `setExtractionError(error: string | null)`, `resetUpload()` (clears all state back to initial)
    - Do NOT use persist middleware — File objects are not serializable (Pitfall 5).
    - Export `useResumeStore`.

    **3. Create frontend/src/api/client.ts:**
    - Import `CnResumeData` and `UploadAndExtractResponse` from types/resume.
    - `const API_BASE = '/api'` (Vite proxy handles forwarding to backend).
    - `export async function uploadAndExtract(file: File): Promise<UploadAndExtractResponse>`: Create FormData, append file, POST to `${API_BASE}/upload-and-extract`. On non-ok response, parse error JSON for `detail` field, throw Error with detail message. On success, return typed response.
  </action>
  <verify>
    Run `npm run build` from frontend/ — TypeScript compilation succeeds with new store and API client.
    Verify `useResumeStore` exports correctly: check that importing it in a test file has no type errors.
  </verify>
  <done>useResumeStore exists with typed resume data state and actions. API client exports uploadAndExtract with proper typing. react-dropzone v14 installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create dropzone components & replace UploadStep</name>
  <files>
    frontend/src/components/upload/FileDropzone.tsx
    frontend/src/components/upload/PhotoDropzone.tsx
    frontend/src/steps/UploadStep.tsx
    frontend/src/i18n/locales/zh/wizard.json
    frontend/src/i18n/locales/ja/wizard.json
  </files>
  <action>
    **1. Create frontend/src/components/upload/FileDropzone.tsx:**
    - Use `useDropzone` hook from react-dropzone.
    - Accept: `{'application/pdf': ['.pdf'], 'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx']}`.
    - `maxFiles: 1`, `maxSize: 10 * 1024 * 1024` (10MB).
    - Props: `onFileAccepted: (file: File) => void`, `currentFile: File | null`.
    - UI: Dashed border container. Show upload icon + instructional text when empty. Show file name + size + change button when file selected. Drag-active state with blue highlight. Show file rejection errors (wrong type, too large) below the dropzone.
    - All text via `useTranslation('wizard')` with keys under `steps.upload.*`.

    **2. Create frontend/src/components/upload/PhotoDropzone.tsx:**
    - Use `useDropzone` hook.
    - Accept: `{'image/jpeg': ['.jpg', '.jpeg'], 'image/png': ['.png']}`.
    - `maxFiles: 1`, `maxSize: 5 * 1024 * 1024` (5MB).
    - Props: `onPhotoAccepted: (file: File) => void`, `currentPhoto: File | null`.
    - UI: Smaller than FileDropzone. When photo selected, show thumbnail preview using `URL.createObjectURL()` (remember to revoke on cleanup). Camera icon when empty.
    - All text via `useTranslation('wizard')`.

    **3. Replace frontend/src/steps/UploadStep.tsx** (full rewrite, remove placeholder):
    - Import useResumeStore, useWizardStore, FileDropzone, PhotoDropzone, uploadAndExtract API client.
    - Layout: Step header (keep existing icon + title/description pattern), then two-column layout on lg (FileDropzone larger on left, PhotoDropzone smaller on right), stacked on mobile.
    - FileDropzone wired to `store.setResumeFile`.
    - PhotoDropzone wired to `store.setPhotoFile`.
    - Extract button: Enabled only when resumeFile is set. On click: call `store.setExtracting(true)`, then `uploadAndExtract(resumeFile)`. On success: call `store.setExtractionResult(response.raw_text, response.cn_resume_data)`, then `wizardStore.nextStep()` to auto-advance. On error: call `store.setExtractionError(error.message)`, `store.setExtracting(false)`.
    - Loading state: When `isExtracting`, show spinner on button + disable all inputs. Display message about AI processing.
    - Error state: When `extractionError`, show red error banner with the error message and a retry option.
    - Remove the old test input/stepData usage.

    **4. Add i18n keys to both zh/wizard.json and ja/wizard.json:**
    - `steps.upload.dropzone`: "将简历文件拖放到此处，或点击选择" / "履歴書ファイルをここにドラッグ＆ドロップ、またはクリックして選択"
    - `steps.upload.dropzoneActive`: "释放文件以上传" / "ファイルをドロップしてアップロード"
    - `steps.upload.fileAccepted`: "已选择文件" / "ファイル選択済み"
    - `steps.upload.changeFile`: "更换文件" / "ファイルを変更"
    - `steps.upload.supportedFormats`: "支持 PDF 和 DOCX 格式，最大 10MB" / "PDF・DOCX形式対応、最大10MB"
    - `steps.upload.photoLabel`: "证件照（可选）" / "証明写真（任意）"
    - `steps.upload.photoDropzone`: "点击上传照片" / "クリックして写真をアップロード"
    - `steps.upload.photoFormats`: "支持 JPG/PNG，最大 5MB" / "JPG/PNG対応、最大5MB"
    - `steps.upload.extractButton`: "提取简历信息" / "履歴書情報を抽出"
    - `steps.upload.extracting`: "AI 正在分析简历..." / "AIが履歴書を分析中..."
    - `steps.upload.extractError`: "提取失败" / "抽出に失敗しました"
    - `steps.upload.retry`: "重试" / "再試行"
    - `steps.upload.fileTooLarge`: "文件过大（最大{{max}}MB）" / "ファイルが大きすぎます（最大{{max}}MB）"
    - `steps.upload.invalidType`: "不支持的文件格式" / "対応していないファイル形式です"
    - Keep existing `steps.upload.title` and `steps.upload.description` unchanged.
  </action>
  <verify>
    Run `npm run build` from frontend/ — zero TypeScript errors.
    Start dev server with `npm run dev`, navigate to Upload step:
    - Verify FileDropzone renders with instructional text.
    - Verify drag-and-drop highlight appears when dragging a file over.
    - Verify clicking selects a file and shows the filename.
    - Verify PhotoDropzone shows camera icon and accepts images.
    - Verify extract button is disabled when no file selected.
    - Verify extract button is enabled when file is selected.
    - Verify UI text switches correctly between Chinese and Japanese.
  </verify>
  <done>Upload step shows drag-and-drop file zone (PDF/DOCX) + optional photo zone with preview. Extract button triggers API call with loading state. Error handling displays failure messages. All text is bilingual via i18n.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds in frontend/
- Upload step renders with FileDropzone and PhotoDropzone
- File selection works via click and drag-and-drop
- Photo upload shows thumbnail preview
- Extract button disabled without file, enabled with file
- Loading spinner appears during extraction
- Language switcher correctly toggles all upload step text
- No console errors in browser DevTools
</verification>

<success_criteria>
Users can drag-drop or select a Chinese resume file (PDF/DOCX), optionally attach a photo, and trigger AI extraction. The upload step shows appropriate loading/error feedback and stores the extraction result in typed Zustand state for the review step.
</success_criteria>

<output>
After completion, create `.planning/phases/02-upload-extraction/02-02-SUMMARY.md`
</output>
