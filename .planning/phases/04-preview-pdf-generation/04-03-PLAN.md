---
phase: 04-preview-pdf-generation
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - frontend/src/components/preview/PreviewPanel.tsx
  - frontend/src/components/preview/PreviewToolbar.tsx
  - frontend/src/steps/PreviewStep.tsx
  - frontend/src/steps/DownloadStep.tsx
  - frontend/src/i18n/locales/zh/wizard.json
  - frontend/src/i18n/locales/ja/wizard.json
autonomous: false

must_haves:
  truths:
    - "User can see 履歴書 and 職務経歴書 previews rendered with their actual data in browser"
    - "User can switch between 履歴書 and 職務経歴書 tabs"
    - "User can upload and crop a photo that appears in the 履歴書 preview"
    - "User can edit fields in the preview step and see changes reflected in the preview after a short delay"
    - "User can download both documents as PDF files"
    - "Null fields show 未記入 in the preview"
  artifacts:
    - path: "frontend/src/components/preview/PreviewPanel.tsx"
      provides: "iframe srcdoc viewer with A4 aspect ratio scaling"
      exports: ["default"]
    - path: "frontend/src/components/preview/PreviewToolbar.tsx"
      provides: "Tab switcher, download buttons, photo upload trigger"
      exports: ["default"]
    - path: "frontend/src/steps/PreviewStep.tsx"
      provides: "Full preview step replacing placeholder with editing + preview + download"
      exports: ["default"]
    - path: "frontend/src/steps/DownloadStep.tsx"
      provides: "Download step with PDF download buttons"
      exports: ["default"]
  key_links:
    - from: "frontend/src/steps/PreviewStep.tsx"
      to: "frontend/src/api/client.ts"
      via: "previewDocument() call on mount and data change"
      pattern: "previewDocument"
    - from: "frontend/src/steps/PreviewStep.tsx"
      to: "frontend/src/components/preview/PreviewPanel.tsx"
      via: "passes previewHtml as srcdoc prop"
      pattern: "PreviewPanel"
    - from: "frontend/src/components/preview/PreviewToolbar.tsx"
      to: "frontend/src/api/client.ts"
      via: "downloadPdf() call on button click"
      pattern: "downloadPdf"
    - from: "frontend/src/steps/PreviewStep.tsx"
      to: "frontend/src/components/preview/PhotoCropper.tsx"
      via: "renders PhotoCropper modal when showCropper state is true"
      pattern: "PhotoCropper"
    - from: "frontend/src/steps/PreviewStep.tsx"
      to: "frontend/src/components/review/JpResumeFieldEditor.tsx"
      via: "reuses JpResumeFieldEditor for inline preview editing"
      pattern: "JpResumeFieldEditor"
---

<objective>
Build the PreviewPanel and PreviewToolbar components, replace the PreviewStep placeholder with the full two-panel preview layout (editing + preview), update DownloadStep with download buttons, add all i18n translations, and verify the complete preview+PDF flow with human testing.

Purpose: This is the user-facing integration that completes Phase 4. Users can see their actual resume data rendered in browser, edit it inline, crop a photo, and download production-quality PDFs.

Output: Functional PreviewStep with preview, editing, photo crop, and download. Updated DownloadStep. Human-verified end-to-end flow.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-preview-pdf-generation/04-RESEARCH.md
@.planning/phases/04-preview-pdf-generation/04-01-SUMMARY.md
@.planning/phases/04-preview-pdf-generation/04-02-SUMMARY.md

@frontend/src/steps/PreviewStep.tsx
@frontend/src/steps/DownloadStep.tsx
@frontend/src/components/review/JpResumeFieldEditor.tsx
@frontend/src/stores/useResumeStore.ts
@frontend/src/api/client.ts
@frontend/src/i18n/locales/zh/wizard.json
@frontend/src/i18n/locales/ja/wizard.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PreviewPanel, PreviewToolbar, replace PreviewStep and DownloadStep, add i18n</name>
  <files>
    frontend/src/components/preview/PreviewPanel.tsx
    frontend/src/components/preview/PreviewToolbar.tsx
    frontend/src/steps/PreviewStep.tsx
    frontend/src/steps/DownloadStep.tsx
    frontend/src/i18n/locales/zh/wizard.json
    frontend/src/i18n/locales/ja/wizard.json
  </files>
  <action>
    **Create frontend/src/components/preview/PreviewPanel.tsx:**

    Props: `{ html: string | null; isLoading: boolean }`

    Structure:
    - Outer container with A4 aspect ratio styling and overflow-auto for scrolling
    - If `isLoading`: show centered spinner/skeleton with "Rendering..." text
    - If `html` is null and not loading: show empty state placeholder ("プレビューを生成中..." or similar)
    - If `html` is present: render `<iframe srcdoc={html} sandbox="allow-same-origin" />` with:
      - `style={{ width: '210mm', height: '297mm' }}` for A4 dimensions (the iframe content is A4-sized)
      - Container wrapper that scales the iframe to fit the available panel width using CSS `transform: scale()` — calculate scale as `containerWidth / 794` (794px ≈ 210mm at 96dpi)
      - Use a `useRef` + `useEffect` with ResizeObserver to track container width and compute scale dynamically
      - Set `pointer-events: none` on iframe to prevent interaction (it's a preview, not editable)
      - White background with subtle shadow to look like a paper sheet

    **Create frontend/src/components/preview/PreviewToolbar.tsx:**

    Props:
    ```typescript
    interface PreviewToolbarProps {
      activeTab: 'rirekisho' | 'shokumukeirekisho';
      onTabChange: (tab: 'rirekisho' | 'shokumukeirekisho') => void;
      onDownload: (docType: 'rirekisho' | 'shokumukeirekisho') => void;
      onUploadPhoto: () => void;
      hasPhoto: boolean;
      isDownloading: boolean;
    }
    ```

    Structure:
    - Flex row with items-center, justify-between
    - Left side: Two tab buttons (履歴書 / 職務経歴書) — active tab has indigo-600 bg, inactive has slate-100 bg. Use `t('preview.tabs.rirekisho')` and `t('preview.tabs.shokumukeirekisho')` for labels.
    - Right side: Three action buttons
      1. "Upload Photo" button (camera icon) — triggers onUploadPhoto. Show a green dot indicator if hasPhoto is true.
      2. "Download 履歴書" button — calls onDownload('rirekisho')
      3. "Download 職務経歴書" button — calls onDownload('shokumukeirekisho')
    - Download buttons show spinner when isDownloading is true, disabled during download
    - Style: Tailwind classes consistent with existing toolbar patterns in the app

    **Replace frontend/src/steps/PreviewStep.tsx:**

    Remove the existing placeholder content entirely. Build:

    1. **State and store:** Read from useResumeStore: `jpResumeData`, `croppedPhotoBase64`, `previewHtml`, `activeDocTab`, `isPreviewLoading`, `isDownloading`, and their setters. Also `setJpResumeData`.

    2. **Preview fetching with debounce:**
       - Create a `fetchPreview` async function that calls `previewDocument(activeDocTab, jpResumeData, croppedPhotoBase64)` and stores the result via `setPreviewHtml(html)`.
       - Use `useEffect` with a 500ms debounce timer: when `jpResumeData`, `croppedPhotoBase64`, or `activeDocTab` changes, clear previous timer, set new 500ms setTimeout, call fetchPreview. Set `isPreviewLoading` true on start, false on complete/error.
       - On initial mount (when jpResumeData exists), fetch preview immediately (no debounce for first render).
       - If `jpResumeData` is null, show a "no data" guard message directing user to complete previous steps.

    3. **Photo upload flow:**
       - Hidden `<input type="file" accept="image/*">` ref
       - `onUploadPhoto` callback: trigger file input click
       - `onFileSelected` callback: read selected file → create object URL → set `showCropper` state to true with the URL
       - When PhotoCropper calls `onCropComplete(base64)`: store base64 via `setCroppedPhotoBase64(base64)`, close modal, revoke object URL
       - When PhotoCropper calls `onCancel`: close modal, revoke object URL

    4. **Download flow:**
       - `handleDownload(docType)` async: set `isDownloading(true)`, call `downloadPdf(docType, jpResumeData, croppedPhotoBase64)`, create blob URL, trigger download via programmatic `<a>` click with `download` attribute set to filename (e.g. "履歴書.pdf" or "職務経歴書.pdf"), revoke URL, set `isDownloading(false)`.
       - Wrap in try/catch with error toast or inline error display.

    5. **Layout:**
       - Step header with icon (same style as ReviewTranslationStep — eye icon, amber theme)
       - PreviewToolbar (full width, above the panels)
       - Two-panel layout below toolbar (flex row, gap-6):
         - Left panel (w-2/5): JpResumeFieldEditor with current `jpResumeData` and `onChange={setJpResumeData}` — reuse the exact same component from Phase 3 for inline editing. Wrap in a scrollable container with max-height.
         - Right panel (w-3/5): PreviewPanel displaying `previewHtml` with `isLoading={isPreviewLoading}`
       - PhotoCropper modal: rendered conditionally when `showCropper` is true

    6. **Edge cases:**
       - If jpResumeData is null: show "No translation data" message with link back to previous step
       - Preview fetch errors: show error banner above panels (similar pattern to ReviewTranslationStep error display)
       - Download errors: show error toast or inline error below toolbar

    **Update frontend/src/steps/DownloadStep.tsx:**

    Replace placeholder with a simple completion page:
    - Success icon (green checkmark) and heading: "Documents Ready" / t('steps.download.ready')
    - Two download cards (rirekisho + shokumukeirekisho):
      - Each card shows document name, a download button, and a brief description
      - Download buttons call the same `downloadPdf()` API function
      - Cards styled with Tailwind (border, rounded-lg, p-4, hover state)
    - Read `jpResumeData` and `croppedPhotoBase64` from store for the download calls
    - Loading/error states same as PreviewStep download flow

    **Add i18n keys to frontend/src/i18n/locales/zh/wizard.json and ja/wizard.json:**

    Add under a `"preview"` section in both files:
    ```json
    "preview": {
      "tabs": {
        "rirekisho": "履歴書",
        "shokumukeirekisho": "職務経歴書"
      },
      "uploadPhoto": "上传照片" / "写真をアップロード",
      "removePhoto": "删除照片" / "写真を削除",
      "downloadRirekisho": "下载履历书PDF" / "履歴書PDFをダウンロード",
      "downloadShokumukeirekisho": "下载职务经历书PDF" / "職務経歴書PDFをダウンロード",
      "rendering": "正在渲染预览..." / "プレビューを生成中...",
      "noData": "请先完成翻译审核步骤" / "翻訳レビューを先に完了してください",
      "previewError": "预览生成失败" / "プレビュー生成に失敗しました",
      "downloadError": "下载失败" / "ダウンロードに失敗しました",
      "downloading": "正在生成PDF..." / "PDF生成中...",
      "photoCropper": {
        "title": "裁剪照片" / "写真をトリミング",
        "zoom": "缩放" / "ズーム",
        "confirm": "确认" / "確認",
        "cancel": "取消" / "キャンセル"
      }
    }
    ```

    Also add download step keys:
    ```json
    "steps": {
      "download": {
        "ready": "文件已准备就绪" / "書類の準備が完了しました",
        "readyDescription": "您的日文简历已生成完毕，点击下方按钮下载PDF文件" / "日本語の履歴書が作成されました。下のボタンからPDFをダウンロードしてください",
        "rirekishoCard": "履历书（JIS标准格式）" / "履歴書（JIS標準形式）",
        "shokumukeirekishoCard": "职务经历书（时间倒序格式）" / "職務経歴書（逆編年体形式）"
      }
    }
    ```
  </action>
  <verify>
    ```bash
    cd frontend && npx tsc --noEmit
    ```
    TypeScript compilation passes. Then start both servers:
    ```bash
    cd backend && python -m uvicorn app.main:app --port 8000 &
    cd frontend && npm run dev &
    ```
    Open http://localhost:5173, navigate through wizard to Preview step. Verify:
    1. Preview panel shows rendered HTML (even with minimal/empty data showing "未記入")
    2. Tab switching works between 履歴書 and 職務経歴書
    3. Editing a field in the left panel triggers preview update after ~500ms
    4. Download buttons trigger PDF download
    5. Photo upload opens file picker, then crop modal
  </verify>
  <done>
    PreviewStep shows two-panel layout with JpResumeFieldEditor (left) and iframe preview (right). Tab switching, photo crop, debounced preview updates, and PDF download all functional. DownloadStep shows download cards. All UI text uses i18n. TypeScript compiles cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of complete preview and PDF flow</name>
  <files>frontend/src/steps/PreviewStep.tsx</files>
  <action>
    Human verifies the complete Phase 4 preview and PDF generation pipeline:
    - Backend: Jinja2 templates rendering JpResumeData with null-field handling
    - Frontend: PreviewStep with tab-based document preview, inline editing, photo crop, PDF download
    - DownloadStep with PDF download buttons

    Start both servers if not running:
    ```bash
    cd backend && python -m uvicorn app.main:app --port 8000
    cd frontend && npm run dev
    ```
    Open http://localhost:5173 and navigate through the full wizard flow.

    **Test cases:**

    1. **Preview with data:** After completing extraction and translation steps (or with mock data in store), navigate to Preview step. Verify 履歴書 preview shows actual translated data in the iframe — names, dates, education, work history should be visible in the JIS table format.

    2. **Tab switching:** Click the 職務経歴書 tab. Verify the preview switches to show the 職務経歴書 format with career summary, work history details, skills table, certifications.

    3. **Null-field handling:** If any fields are null/empty in JpResumeData, verify they show "未記入" in the preview (not blank spaces or errors).

    4. **Inline editing:** Edit a field (e.g., name) in the left editing panel. After ~500ms, verify the preview updates to show the new value.

    5. **Photo crop:** Click "Upload Photo" → select an image → verify crop modal appears with 3:4 aspect ratio → adjust crop/zoom → confirm → verify photo appears in 履歴書 preview (in the photo area). Switch to 職務経歴書 tab — photo should NOT appear there (shokumukeirekisho has no photo).

    6. **PDF download:** Click download button for 履歴書. Verify a PDF file downloads. Open it — verify CJK text renders correctly (no □ tofu), layout matches preview, photo is embedded if uploaded.

    7. **Download step:** Navigate to the Download step. Verify download cards for both documents are shown. Click download — verify PDFs download successfully.

    8. **No-photo placeholder:** If no photo was uploaded, verify the 履歴書 preview shows "写真を貼る位置" placeholder text in the photo area.
  </action>
  <verify>Human confirms all 8 test cases pass visually</verify>
  <done>Complete Phase 4 flow verified: preview, editing, photo crop, download, null-field handling all working correctly</done>
</task>

</tasks>

<verification>
1. PreviewStep replaces placeholder with functional two-panel layout
2. iframe srcdoc shows rendered 履歴書 / 職務経歴書 with actual data
3. Tab switching loads different document previews
4. Editing fields triggers debounced preview re-render
5. Photo upload → crop → base64 → appears in preview
6. Download buttons produce valid PDF files with CJK fonts
7. Null fields show "未記入"
8. All UI text uses i18n (zh + ja)
9. Human verification confirms end-to-end flow
</verification>

<success_criteria>
Users can preview both 履歴書 and 職務経歴書 in the browser with their actual data. Users can crop a photo, edit fields inline with live preview updates, and download properly formatted A4 PDFs. Null fields display as "未記入". Human verification confirms all 8 test cases pass.
</success_criteria>

<output>
After completion, create `.planning/phases/04-preview-pdf-generation/04-03-SUMMARY.md`
</output>
