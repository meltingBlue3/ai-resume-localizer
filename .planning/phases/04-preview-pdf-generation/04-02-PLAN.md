---
phase: 04-preview-pdf-generation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/utils/cropImage.ts
  - frontend/src/components/preview/PhotoCropper.tsx
  - frontend/src/api/client.ts
  - frontend/src/stores/useResumeStore.ts
autonomous: true

must_haves:
  truths:
    - "Photo can be cropped to 3:4 ratio and converted to base64 JPEG"
    - "API client can request preview HTML for both document types"
    - "API client can download PDF bytes for both document types"
    - "Store holds croppedPhotoBase64 and previewHtml state"
  artifacts:
    - path: "frontend/src/utils/cropImage.ts"
      provides: "Canvas-based image crop to 354x472px JPEG"
      exports: ["getCroppedImg"]
    - path: "frontend/src/components/preview/PhotoCropper.tsx"
      provides: "react-easy-crop modal with 3:4 aspect ratio"
      exports: ["default"]
    - path: "frontend/src/api/client.ts"
      provides: "previewDocument and downloadPdf API functions"
      exports: ["previewDocument", "downloadPdf"]
    - path: "frontend/src/stores/useResumeStore.ts"
      provides: "Extended store with photo and preview state"
      contains: "croppedPhotoBase64"
  key_links:
    - from: "frontend/src/components/preview/PhotoCropper.tsx"
      to: "frontend/src/utils/cropImage.ts"
      via: "getCroppedImg import for canvas crop"
      pattern: "import.*getCroppedImg.*from.*cropImage"
    - from: "frontend/src/api/client.ts"
      to: "/api/preview/{doc_type}"
      via: "fetch POST with JpResumeData body"
      pattern: "fetch.*api/preview"
    - from: "frontend/src/api/client.ts"
      to: "/api/download/{doc_type}"
      via: "fetch POST returning blob"
      pattern: "fetch.*api/download"
---

<objective>
Install react-easy-crop, create the photo cropping utility and component, extend the API client with preview/download functions, and expand the Zustand store for preview state management.

Purpose: Builds the frontend data layer and photo handling that the PreviewStep UI (Plan 03) will consume. Separating this foundation from the UI integration keeps each plan focused and within context budget.

Output: cropImage utility, PhotoCropper component, extended API client, extended store
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-preview-pdf-generation/04-RESEARCH.md

@frontend/src/api/client.ts
@frontend/src/stores/useResumeStore.ts
@frontend/src/types/resume.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-easy-crop, extend store and API client</name>
  <files>
    frontend/src/api/client.ts
    frontend/src/stores/useResumeStore.ts
  </files>
  <action>
    **Install dependency:**
    ```bash
    cd frontend && npm install react-easy-crop
    ```

    **Extend frontend/src/stores/useResumeStore.ts:**

    Add these fields to the store interface and initial state:
    - `croppedPhotoBase64: string | null` — base64 JPEG string of cropped photo (no data URI prefix)
    - `previewHtml: string | null` — rendered HTML from backend for current preview tab
    - `activeDocTab: 'rirekisho' | 'shokumukeirekisho'` — which document tab is active (default: 'rirekisho')
    - `isPreviewLoading: boolean` — loading state for preview renders (default: false)
    - `isDownloading: boolean` — loading state for PDF downloads (default: false)

    Add these actions:
    - `setCroppedPhotoBase64: (base64: string | null) => void`
    - `setPreviewHtml: (html: string | null) => void`
    - `setActiveDocTab: (tab: 'rirekisho' | 'shokumukeirekisho') => void`
    - `setIsPreviewLoading: (loading: boolean) => void`
    - `setIsDownloading: (loading: boolean) => void`

    Add these to initialState (so resetUpload clears them):
    - `croppedPhotoBase64: null, previewHtml: null, activeDocTab: 'rirekisho' as const, isPreviewLoading: false, isDownloading: false`

    **Extend frontend/src/api/client.ts:**

    Add `previewDocument` function:
    ```typescript
    export async function previewDocument(
      docType: 'rirekisho' | 'shokumukeirekisho',
      jpResume: JpResumeData,
      photoBase64?: string | null,
    ): Promise<string> {
      const response = await fetch(`${API_BASE}/preview/${docType}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          jp_resume: jpResume,
          photo_base64: photoBase64 ?? null,
        }),
      });
      if (!response.ok) {
        const errorBody = await response.json().catch(() => null);
        throw new Error(errorBody?.detail ?? `Preview failed (${response.status})`);
      }
      const data = await response.json();
      return data.html as string;
    }
    ```

    Add `downloadPdf` function:
    ```typescript
    export async function downloadPdf(
      docType: 'rirekisho' | 'shokumukeirekisho',
      jpResume: JpResumeData,
      photoBase64?: string | null,
    ): Promise<Blob> {
      const response = await fetch(`${API_BASE}/download/${docType}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          jp_resume: jpResume,
          photo_base64: photoBase64 ?? null,
        }),
      });
      if (!response.ok) {
        const errorBody = await response.json().catch(() => null);
        throw new Error(errorBody?.detail ?? `Download failed (${response.status})`);
      }
      return response.blob();
    }
    ```

    Import JpResumeData type in client.ts (already imported).
  </action>
  <verify>
    ```bash
    cd frontend && npx tsc --noEmit
    ```
    TypeScript compilation succeeds with no errors. The store and API client types are consistent.
  </verify>
  <done>
    react-easy-crop installed. Store has croppedPhotoBase64, previewHtml, activeDocTab, isPreviewLoading, isDownloading fields with setters. API client has previewDocument() returning HTML string and downloadPdf() returning Blob. All type-safe with no compilation errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cropImage utility and PhotoCropper component</name>
  <files>
    frontend/src/utils/cropImage.ts
    frontend/src/components/preview/PhotoCropper.tsx
  </files>
  <action>
    **Create frontend/src/utils/cropImage.ts:**

    Export `getCroppedImg(imageSrc: string, pixelCrop: Area): Promise<Blob>`:
    - Import `Area` type from `react-easy-crop`
    - Define constants: `TARGET_WIDTH = 354` (30mm at 300 DPI), `TARGET_HEIGHT = 472` (40mm at 300 DPI)
    - Create helper `createImage(url: string): Promise<HTMLImageElement>` using `new Image()` with onload/onerror
    - Create canvas at TARGET_WIDTH × TARGET_HEIGHT dimensions
    - Draw source image region (pixelCrop.x, y, width, height) onto canvas (0, 0, TARGET_WIDTH, TARGET_HEIGHT)
    - Return `canvas.toBlob()` promise with type `image/jpeg` and quality `0.85`

    Export `blobToBase64(blob: Blob): Promise<string>`:
    - Use FileReader to read blob as data URL
    - Strip the `data:image/jpeg;base64,` prefix and return raw base64 string
    - This raw string is what gets sent to the backend (backend adds the data URI prefix in the template)

    **Create frontend/src/components/preview/PhotoCropper.tsx:**

    Props interface:
    ```typescript
    interface PhotoCropperProps {
      imageSrc: string;        // Object URL of selected image
      onCropComplete: (base64: string) => void;  // Raw base64 JPEG
      onCancel: () => void;
    }
    ```

    Component structure:
    - Modal overlay (fixed inset-0, bg-black/50, z-50, flex center)
    - White modal card (max-w-lg, rounded-xl, p-6)
    - Title: t('preview.photoCropper.title') — use i18n (add keys in Plan 03)
    - Cropper container: relative div with fixed height (~400px) for the react-easy-crop `<Cropper>` component
    - `<Cropper image={imageSrc} crop={crop} zoom={zoom} aspect={3/4} onCropChange={setCrop} onCropComplete={(_, pixels) => setCroppedPixels(pixels)} onZoomChange={setZoom} />`
    - Zoom slider: `<input type="range" min={1} max={3} step={0.1} value={zoom}>`
    - Two buttons: Cancel (calls onCancel) and Confirm (calls handleConfirm)
    - `handleConfirm` async: calls `getCroppedImg(imageSrc, croppedPixels)` → `blobToBase64(blob)` → `onCropComplete(base64)`
    - Use `useState` for crop ({x:0, y:0}), zoom (1), croppedPixels (Area | null)
    - Use `useCallback` for onCropComplete handler from Cropper

    Style with Tailwind classes (consistent with existing UI components). Use `useTranslation('wizard')` for button labels.
  </action>
  <verify>
    ```bash
    cd frontend && npx tsc --noEmit
    ```
    TypeScript compilation succeeds. Verify files exist:
    ```bash
    ls frontend/src/utils/cropImage.ts frontend/src/components/preview/PhotoCropper.tsx
    ```
  </verify>
  <done>
    getCroppedImg() crops to 354×472px JPEG at quality 85. blobToBase64() converts Blob to raw base64 string. PhotoCropper renders react-easy-crop in a modal with 3:4 aspect, zoom slider, confirm/cancel buttons. All TypeScript-clean.
  </done>
</task>

</tasks>

<verification>
1. `npm install` and `npx tsc --noEmit` pass with zero errors
2. react-easy-crop appears in package.json dependencies
3. Store has all 5 new fields and setters
4. API client exports previewDocument and downloadPdf functions
5. cropImage.ts exports getCroppedImg and blobToBase64
6. PhotoCropper.tsx renders without import errors
</verification>

<success_criteria>
All frontend foundation pieces compile without errors. react-easy-crop installed. Store, API client, crop utility, and PhotoCropper component are ready for Plan 03 integration.
</success_criteria>

<output>
After completion, create `.planning/phases/04-preview-pdf-generation/04-02-SUMMARY.md`
</output>
