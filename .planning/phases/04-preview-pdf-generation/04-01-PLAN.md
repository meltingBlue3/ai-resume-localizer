---
phase: 04-preview-pdf-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/templates/rirekisho.html
  - backend/app/templates/shokumukeirekisho.html
  - backend/app/services/template_renderer.py
  - backend/app/api/routes/preview.py
  - backend/app/models/api.py
  - backend/app/api/router.py
autonomous: true

must_haves:
  truths:
    - "Backend renders 履歴書 HTML from JpResumeData with all fields populated or showing 未記入"
    - "Backend renders 職務経歴書 HTML from JpResumeData with all fields populated or showing 未記入"
    - "POST /api/preview/{doc_type} returns rendered HTML string"
    - "POST /api/download/{doc_type} returns valid PDF bytes with embedded CJK fonts"
    - "Photo base64 conditionally embedded as img tag or placeholder shown"
  artifacts:
    - path: "backend/app/services/template_renderer.py"
      provides: "Jinja2 rendering service with prepare_context and render_document"
      exports: ["render_document", "render_document_for_preview"]
    - path: "backend/app/templates/rirekisho.html"
      provides: "Jinja2 template for 履歴書 with loops and default filters"
      contains: "{{ data."
    - path: "backend/app/templates/shokumukeirekisho.html"
      provides: "Jinja2 template for 職務経歴書 with loops and default filters"
      contains: "{{ data."
    - path: "backend/app/api/routes/preview.py"
      provides: "Preview HTML and PDF download endpoints"
      exports: ["router"]
  key_links:
    - from: "backend/app/api/routes/preview.py"
      to: "backend/app/services/template_renderer.py"
      via: "render_document / render_document_for_preview import"
      pattern: "from app\\.services\\.template_renderer import"
    - from: "backend/app/api/routes/preview.py"
      to: "backend/app/services/pdf_generator.py"
      via: "generate_pdf import for PDF download"
      pattern: "from app\\.services\\.pdf_generator import generate_pdf"
    - from: "backend/app/services/template_renderer.py"
      to: "backend/app/templates/rirekisho.html"
      via: "Jinja2 Environment get_template"
      pattern: "env\\.get_template"
---

<objective>
Convert static HTML templates to Jinja2 templates with dynamic data rendering and null-field handling, create the template renderer service, and build preview/download API endpoints.

Purpose: This is the backend rendering pipeline that connects translated JpResumeData (from Phase 3) to the validated HTML templates (from Phase 1) via Jinja2. Both preview (HTML) and download (PDF) share the same rendering pipeline, guaranteeing visual fidelity.

Output: Jinja2 templates, template_renderer.py service, preview/download API endpoints
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-preview-pdf-generation/04-RESEARCH.md

@backend/app/templates/rirekisho.html
@backend/app/templates/shokumukeirekisho.html
@backend/app/templates/base.css
@backend/app/services/pdf_generator.py
@backend/app/models/resume.py
@backend/app/models/api.py
@backend/app/api/router.py
@backend/app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert HTML templates to Jinja2 and create template_renderer.py</name>
  <files>
    backend/app/templates/rirekisho.html
    backend/app/templates/shokumukeirekisho.html
    backend/app/services/template_renderer.py
  </files>
  <action>
    **Create backend/app/services/template_renderer.py:**

    1. Create Jinja2 `Environment` at module level with `FileSystemLoader(str(TEMPLATES_DIR))` and `autoescape=True`. Import `TEMPLATES_DIR` from `app.config`.

    2. Implement `prepare_context(jp_resume: JpResumeData) -> dict`:
       - Call `jp_resume.model_dump()` to get dict
       - Normalize None sub-objects: if `personal_info` is None → empty dict, if `education` is None → empty list, same for `work_history`, `skills`, `certifications`
       - Process education entries: for each entry, parse `start_date`/`end_date` strings (e.g. "令和5年4月" or "2023年4月") to extract year and month components into `start_year`/`start_month`/`end_year`/`end_month` fields. Use regex like `r'(.+年)\s*(\d+)月?'` — if no match, put full string in year, leave month empty.
       - Process work_history entries similarly with year/month extraction
       - Process certifications with date splitting (year + month)
       - Generate `current_date_wareki` for the title date line using Python's `datetime.date.today()`. Format as "令和{year}年　{month}月　{day}日現在". Calculate wareki year = gregorian_year - 2018 for Reiwa era (sufficient for 2019-2099).
       - Return the processed dict

    3. Implement `render_document(template_name: str, jp_resume: JpResumeData, photo_base64: str | None = None) -> str`:
       - Call `prepare_context(jp_resume)` to get the data dict
       - Call `env.get_template(template_name).render(data=context, photo_base64=photo_base64)`
       - Return rendered HTML string

    4. Implement `render_document_for_preview(template_name: str, jp_resume: JpResumeData, photo_base64: str | None = None) -> str`:
       - Call `render_document()` first
       - Read base.css content from `TEMPLATES_DIR / "base.css"`
       - Replace `<link rel="stylesheet" href="base.css">` with `<style>{base_css_content}</style>` so iframe srcdoc has all styles inlined
       - Return the HTML with inlined CSS

    **Convert backend/app/templates/rirekisho.html to Jinja2:**

    Replace all hardcoded data with Jinja2 variables. Key mappings:

    - Title date: `{{ current_date_wareki }}` (from prepare_context)
    - Furigana: `{{ data.personal_info.name_katakana | default('', boolean=False) }}`
    - Name: `{{ data.personal_info.name | default('未記入', boolean=False) }}`
    - Birth date: `{{ data.personal_info.birth_date | default('未記入', boolean=False) }}`
    - Address: `{{ data.personal_info.address | default('未記入', boolean=False) }}`
    - Phone: `{{ data.personal_info.phone | default('未記入', boolean=False) }}`
    - Email: `{{ data.personal_info.email | default('未記入', boolean=False) }}`

    Photo area: conditional display
    ```
    {% if photo_base64 %}
    <td rowspan="3" class="photo-area" style="border: none; padding: 0;">
        <img src="data:image/jpeg;base64,{{ photo_base64 }}" style="width: 30mm; height: 40mm; object-fit: cover;">
    </td>
    {% else %}
    <td rowspan="3" class="photo-area">写真を貼る位置<br><br>縦40mm×横30mm<br><br>裏面に氏名を記入</td>
    {% endif %}
    ```

    Education entries: Jinja2 for-loop
    ```
    {% for entry in data.education_processed %}
    <tr class="history-row">
        <td class="year-cell">{{ entry.start_year }}</td>
        <td class="month-cell">{{ entry.start_month }}</td>
        <td>{{ entry.school | default('') }}{% if entry.degree %}　{{ entry.degree }}{% endif %}</td>
    </tr>
    {% endfor %}
    ```
    Similar loop pattern for work_history_processed and certifications_processed (with year/month cells).

    Use `{% for ... %}{% endfor %}` for repeating rows. Fill remaining empty rows up to a fixed count (e.g., 6 education rows total, pad with empty `<tr>` if fewer entries) to maintain JIS grid layout.

    End the education/work section with the "以上" row.

    Commute/dependents section: use `{{ data.other | default('貴社規定に従います。', boolean=False) }}` for preferences. Commute/dependents fields don't exist in JpResumeData — use static defaults ("約　時間　分", "0 人", "無", "無").

    Motivation section: `{{ data.motivation | default('未記入', boolean=False) }}`

    **Convert backend/app/templates/shokumukeirekisho.html to Jinja2:**

    - Title: static "職 務 経 歴 書"
    - Date: `{{ current_date_wareki }}` (without 現在 suffix or with — match existing format)
    - Name: `{{ data.personal_info.name | default('未記入', boolean=False) }}`
    - Career summary: `{{ data.summary | default('未記入', boolean=False) }}`

    Work history: loop over `data.work_history` (not processed — shokumukeirekisho uses full text, not year/month cells)
    ```
    {% for job in data.work_history %}
    <!-- Company header -->
    <table class="title-table">
        <tr class="company-header-row">
            <td>{{ job.company | default('未記入') }}　（{{ job.start_date | default('') }}〜{{ job.end_date | default('現在') }}）</td>
        </tr>
    </table>
    <!-- Responsibilities bullets -->
    {% if job.responsibilities %}
    {% for item in job.responsibilities %}
    <tr class="bullet-row"><td>・{{ item }}</td></tr>
    {% endfor %}
    {% endif %}
    <!-- Achievements bullets -->
    {% if job.achievements %}
    {% for item in job.achievements %}
    <tr class="bullet-row"><td>・{{ item }}</td></tr>
    {% endfor %}
    {% endif %}
    {% endfor %}
    ```

    Skills: loop over `data.skills`
    ```
    {% for skill in data.skills %}
    <tr>
        <td class="skills-category">{{ skill.category | default('') }}</td>
        <td>{{ skill.skills | join('、') if skill.skills else '' }}</td>
    </tr>
    {% endfor %}
    ```

    Certifications: loop over `data.certifications`
    Self-PR: `{{ data.strengths | default('未記入', boolean=False) }}` — use `| safe` only if you need `<br>` line breaks, otherwise let autoescape handle it. For multi-paragraph text, replace `\n` with `<br>` using a custom filter or `| replace('\n', '<br>') | safe`.

    **Critical rules:**
    - Use `| default('未記入', boolean=False)` on ALL leaf text fields — `boolean=False` catches None specifically
    - Use `| safe` ONLY on the photo `<img>` tag (trusted HTML) — never on user text fields
    - Keep ALL existing CSS classes and table structure intact — only replace data content
    - Preserve `<link rel="stylesheet" href="base.css">` in templates (render_document_for_preview handles inlining)
    - Do NOT use flexbox/grid — CSS tables only (prior decision [01-02])
  </action>
  <verify>
    Run Python import check:
    ```bash
    cd backend && python -c "from app.services.template_renderer import render_document, render_document_for_preview; print('OK')"
    ```
    Verify templates have Jinja2 syntax:
    ```bash
    grep -c "{{" backend/app/templates/rirekisho.html
    grep -c "{{" backend/app/templates/shokumukeirekisho.html
    ```
    Both should return counts > 10.
  </verify>
  <done>
    template_renderer.py exports render_document() and render_document_for_preview(). Both HTML templates use Jinja2 syntax with {{ data.* }} variables, {% for %} loops, and | default('未記入') filters. prepare_context() normalizes None sub-objects and processes dates for year/month splitting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create preview and download API endpoints</name>
  <files>
    backend/app/api/routes/preview.py
    backend/app/models/api.py
    backend/app/api/router.py
  </files>
  <action>
    **Add PreviewRequest model to backend/app/models/api.py:**
    ```python
    class PreviewRequest(BaseModel):
        jp_resume: JpResumeData
        photo_base64: str | None = None
    ```

    **Create backend/app/api/routes/preview.py:**

    1. Define `TEMPLATE_MAP = {"rirekisho": "rirekisho.html", "shokumukeirekisho": "shokumukeirekisho.html"}`

    2. `POST /api/preview/{doc_type}` endpoint:
       - Accept `PreviewRequest` body and `doc_type` path parameter
       - Validate doc_type against TEMPLATE_MAP, return 404 if unknown
       - Call `render_document_for_preview(filename, request.jp_resume, request.photo_base64)` — use the preview variant that inlines CSS
       - Return `{"html": rendered_html}`

    3. `POST /api/download/{doc_type}` endpoint:
       - Same request validation as preview
       - Call `render_document(filename, request.jp_resume, request.photo_base64)` — use the standard variant (WeasyPrint handles CSS separately)
       - Call `generate_pdf(html)` from `app.services.pdf_generator`
       - Return `Response(content=pdf_bytes, media_type="application/pdf")` with Content-Disposition header: `attachment; filename="{doc_type}.pdf"`

    4. Error handling: wrap template rendering in try/except, return 500 with detail message on Jinja2 errors. Wrap generate_pdf in try/except for WeasyPrint errors.

    **Register in backend/app/api/router.py:**
    ```python
    from app.api.routes.preview import router as preview_router
    api_router.include_router(preview_router)
    ```
  </action>
  <verify>
    Start the backend server and test with curl:
    ```bash
    cd backend && python -m uvicorn app.main:app --port 8000 &
    ```
    Test preview endpoint:
    ```bash
    curl -s -X POST http://localhost:8000/api/preview/rirekisho -H "Content-Type: application/json" -d '{"jp_resume": {"personal_info": {"name": "テスト太郎"}}}' | python -c "import sys,json; d=json.load(sys.stdin); print('OK' if 'html' in d and 'テスト太郎' in d['html'] else 'FAIL')"
    ```
    Test download endpoint returns PDF:
    ```bash
    curl -s -X POST http://localhost:8000/api/download/rirekisho -H "Content-Type: application/json" -d '{"jp_resume": {"personal_info": {"name": "テスト太郎"}}}' -o test.pdf && python -c "print('OK' if open('test.pdf','rb').read(4)==b'%PDF' else 'FAIL')"
    ```
    Test null-field handling (empty resume):
    ```bash
    curl -s -X POST http://localhost:8000/api/preview/rirekisho -H "Content-Type: application/json" -d '{"jp_resume": {}}' | python -c "import sys,json; d=json.load(sys.stdin); print('OK' if '未記入' in d['html'] else 'FAIL')"
    ```
  </verify>
  <done>
    POST /api/preview/rirekisho and /api/preview/shokumukeirekisho return rendered HTML with actual data. POST /api/download/* return valid PDF bytes. Empty JpResumeData renders with "未記入" defaults. Routes registered in api_router.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.template_renderer import render_document"` succeeds
2. POST /api/preview/rirekisho with sample data returns HTML containing the data
3. POST /api/preview/shokumukeirekisho with sample data returns HTML containing the data
4. POST /api/download/rirekisho returns valid PDF (starts with %PDF)
5. Empty JpResumeData shows "未記入" in rendered HTML
6. Photo base64 conditionally renders as img tag or placeholder text
</verification>

<success_criteria>
Both preview and download endpoints work for rirekisho and shokumukeirekisho. Rendered HTML contains actual JpResumeData values. Null fields display "未記入". PDF output has correct CJK fonts (no tofu). Photo conditionally displayed.
</success_criteria>

<output>
After completion, create `.planning/phases/04-preview-pdf-generation/04-01-SUMMARY.md`
</output>
