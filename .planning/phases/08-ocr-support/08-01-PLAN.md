---
phase: 08-ocr-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/ocr_service.py
  - backend/app/api/routes/upload.py
  - backend/requirements.txt
autonomous: true
requirements:
  - OCRR-01
  - OCRR-02
  - OCRR-03
user_setup:
  - service: Tesseract OCR
    why: "OCR engine for scanned PDF processing"
    env_vars: []
    dashboard_config:
      - task: "Install Tesseract OCR binary"
        location: "Windows: download from UB Mannheim (https://github.com/UB-Mannheim/tesseract/wiki); macOS: brew install tesseract; Linux: apt install tesseract-ocr"
      - task: "Install Poppler utilities"
        location: "Windows: download from poppler-windows (https://github.com/oschwartz10612/poppler-windows); macOS: brew install poppler; Linux: apt install poppler-utils"
      - task: "Install language data"
        location: "Download chi_sim, chi_tra, jpn, eng traineddata from tesseract-ocr/tessdata and place in tessdata directory"

must_haves:
  truths:
    - "User uploads a scanned PDF and backend correctly classifies it as image-based"
    - "User uploads a scanned PDF and text gets extracted via OCR"
    - "User uploads a scanned PDF and extraction succeeds with structured data flowing to Dify"
    - "OCR extraction takes longer than normal and user sees progress indication"
    - "OCR fails or times out and user sees a clear error message"
  artifacts:
    - path: "backend/app/services/ocr_service.py"
      provides: "Tesseract OCR service with detection and extraction"
      min_lines: 80
      contains: "class OCRService"
    - path: "backend/app/api/routes/upload.py"
      provides: "Upload endpoint with OCR integration"
      contains: "OCRService"
    - path: "backend/requirements.txt"
      provides: "Python dependencies for OCR"
      contains: "pytesseract"
  key_links:
    - from: "backend/app/api/routes/upload.py"
      to: "backend/app/services/ocr_service.py"
      via: "from app.services.ocr_service import OCRService"
      pattern: "OCRService"
    - from: "backend/app/api/routes/upload.py"
      to: "Dify extraction workflow"
      via: "DifyClient.extract_resume"
      pattern: "extract_resume"
---

<objective>
Integrate Tesseract OCR into the backend to detect and process image-based/scanned PDFs transparently before sending text to Dify.

Purpose: Users with scanned resumes can complete the full extraction flow without any special steps — OCR happens invisibly when needed.
Output: Working OCR service integrated into upload endpoint
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ocr-support/08-CONTEXT.md

## Existing Code Patterns

### Text Extraction (backend/app/services/text_extractor.py)
- PyMuPDF for PDF text extraction with reading-order sort
- Returns stripped text or empty string

### Upload Route (backend/app/api/routes/upload.py)
- Validates content-type and file size (10MB)
- Extracts text, returns 422 if no text found
- Uses DifyClient for extraction workflow

### DifyClient (backend/app/services/dify_client.py)
- 90s timeout with httpx
- Error handling via HTTPException in routes

### User Decisions (LOCKED from CONTEXT.md):
- OCR Provider: Tesseract (self-hosted) — no cloud services
- Detection: Text length threshold (100 characters)
- If extracted text < 100 chars, treat as image-based and run OCR
- Mixed PDF: Full OCR if any page triggers threshold
- Log classification results for debugging
- OCR failure: Fail with clear error message
- OCR timeout: 30 seconds
- File size limit for OCR: 5MB
- Language support: Chinese (Simplified/Traditional), Japanese, English
- Progress message: Keep generic — don't expose "OCR"
</context>

<tasks>

<task type="auto">
  <name>Create OCR service with Tesseract integration</name>
  <files>backend/app/services/ocr_service.py, backend/requirements.txt</files>
  <action>
Create `backend/app/services/ocr_service.py` with an `OCRService` class that:

1. **Detection logic:**
   - `is_image_based(text: str) -> bool` — returns True if text length < 100 chars
   - Log classification result (INFO level): "PDF classified as image-based: extracted {len} chars < 100 threshold"

2. **PDF-to-image conversion:**
   - Use `pdf2image` library (wraps poppler) to convert PDF pages to PIL images
   - `convert_from_bytes(content, dpi=200)` for reasonable quality/speed balance

3. **OCR execution:**
   - Use `pytesseract.image_to_string()` with language config: `chi_sim+chi_tra+jpn+eng`
   - Process all pages, concatenate with `\n\n` separator
   - Wrap in `asyncio.to_thread()` for non-blocking execution

4. **Timeout handling:**
   - 30-second timeout via `asyncio.wait_for()`
   - Raise `OCRError` with message "OCR processing timed out" on timeout

5. **File size validation:**
   - Reject files > 5MB with `OCRError("File exceeds 5MB limit for OCR processing")`

6. **Error handling:**
   - Catch `TesseractNotFoundError` → raise `OCRError("OCR engine not installed")`
   - Catch `PDFInfoNotInstalledError` → raise `OCRError("PDF utilities not installed")`
   - Catch generic exceptions → raise `OCRError(f"OCR failed: {detail}")`

7. **Custom exception:**
   ```python
   class OCRError(Exception):
       """Raised when OCR processing fails."""
   ```

8. **Main entrypoint:**
   ```python
   async def process_pdf(self, content: bytes, extracted_text: str) -> str:
       """Return OCR text if image-based, otherwise return original text."""
   ```

Add to `backend/requirements.txt`:
```
pytesseract==0.3.13
pdf2image==1.17.0
Pillow==11.1.0
```

Do NOT add progress indication in this task — that's frontend concern.
Do NOT expose "OCR" in any user-facing messages at this layer — error messages are for backend logging only.
</action>
  <verify>`python -c "from app.services.ocr_service import OCRService, OCRError; print('Import OK')"`</verify>
  <done>OCRService class exists with is_image_based(), process_pdf() methods, OCRError exception defined, dependencies added to requirements.txt</done>
</task>

<task type="auto">
  <name>Integrate OCR service into upload route</name>
  <files>backend/app/api/routes/upload.py</files>
  <action>
Modify `backend/app/api/routes/upload.py` to integrate OCR:

1. **Import OCRService:**
   ```python
   from app.services.ocr_service import OCRService, OCRError
   ```

2. **Add OCR-specific file size limit:**
   ```python
   MAX_OCR_FILE_SIZE = 5 * 1024 * 1024  # 5 MB for OCR
   ```

3. **After existing text extraction, add OCR detection and processing:**
   - If `len(raw_text.strip()) < 100`:
     - Check file size against MAX_OCR_FILE_SIZE (5MB) → raise 422 if exceeded
     - Instantiate `OCRService()` 
     - Call `ocr_text = await ocr_service.process_pdf(content, raw_text)`
     - Use `ocr_text` as the final text for Dify

4. **Error handling for OCR:**
   - Catch `OCRError` and convert to appropriate HTTPException:
     - "OCR engine not installed" → 503 (service unavailable)
     - "PDF utilities not installed" → 503
     - "timed out" → 504 (gateway timeout)
     - "exceeds 5MB limit" → 422 (validation error)
     - Other OCR failures → 422 with detail message

5. **Logging:**
   - Log INFO when OCR is triggered: "OCR processing triggered for image-based PDF"
   - Log INFO when OCR completes: "OCR completed, extracted {len} characters"

6. **Preserve existing behavior:**
   - Text-based PDFs (>= 100 chars) skip OCR entirely
   - Original error handling for Dify remains unchanged
   - Response format unchanged — same `UploadAndExtractResponse`

Do NOT change the frontend response handling — backend changes are transparent.
Do NOT modify the error messages to mention "OCR" — use generic terms like "processing failed".
</action>
  <verify>`grep -n "OCRService" backend/app/api/routes/upload.py`</verify>
  <done>Upload route detects image-based PDFs, runs OCR when needed, returns same response format, handles OCR errors appropriately</done>
</task>

</tasks>

<verification>
1. OCRService imports without error
2. Upload route imports OCRService
3. Backend starts without errors: `cd backend && python -m uvicorn app.main:app --reload`
4. Test with a small text-based PDF → should skip OCR
5. Test with a scanned PDF → should trigger OCR and extract text
</verification>

<success_criteria>
- OCRService class exists with process_pdf() method
- Upload route integrates OCR detection and processing
- Files > 5MB for OCR are rejected with 422
- OCR timeout (30s) returns 504
- OCR failures return appropriate error codes
- Text-based PDFs skip OCR entirely (no performance impact)
</success_criteria>

<output>
After completion, create `.planning/phases/08-ocr-support/08-01-SUMMARY.md`
</output>
