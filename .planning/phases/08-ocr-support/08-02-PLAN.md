---
phase: 08-ocr-support
plan: 02
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - frontend/src/utils/errorClassifier.ts
  - frontend/src/i18n/locales/ja/wizard.json
  - frontend/src/i18n/locales/zh/wizard.json
  - tests/test_ocr_service.py
autonomous: true
requirements:
  - OCRR-01
  - OCRR-02
must_haves:
  truths:
    - "OCR timeout shows user-friendly timeout message"
    - "OCR file size error shows clear validation message"
    - "OCR service not installed shows service unavailable message"
    - "OCR service is tested with unit tests covering all paths"
  artifacts:
    - path: "frontend/src/utils/errorClassifier.ts"
      provides: "Error classification including OCR errors"
      contains: "ocr"
    - path: "frontend/src/i18n/locales/ja/wizard.json"
      provides: "Japanese error messages"
      contains: "errors.ocr"
    - path: "tests/test_ocr_service.py"
      provides: "Unit tests for OCR service"
      min_lines: 60
  key_links:
    - from: "frontend/src/utils/errorClassifier.ts"
      to: "i18n keys"
      via: "titleKey/messageKey references"
      pattern: "errors\\.ocr"
---

<objective>
Add frontend error handling for OCR-specific errors and unit tests for the OCR service.

Purpose: Users see clear, actionable error messages when OCR fails, and the OCR service is verified by tests.
Output: Error classification with OCR support, i18n messages, unit tests
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ocr-support/08-01-PLAN.md

## Existing Error Classification Pattern

From `frontend/src/utils/errorClassifier.ts`:
- ClassifiedError interface with type, titleKey, messageKey, rawMessage, retryable
- classifyError() function maps error messages to types: network, timeout, server, validation, config
- Uses string matching on raw error messages

## User Decisions (LOCKED):
- OCR failure: Fail with clear error message to user
- Loading message: Keep generic — don't expose "OCR" to user
- Progress indication: Show progress bar or "Extracting text..." during OCR

## Backend Error Codes (from 08-01):
- 503: "OCR engine not installed" / "PDF utilities not installed"
- 504: OCR timeout
- 422: File size limit exceeded / OCR processing failed
</context>

<tasks>

<task type="auto">
  <name>Add OCR error classification and i18n messages</name>
  <files>frontend/src/utils/errorClassifier.ts, frontend/src/i18n/locales/ja/wizard.json, frontend/src/i18n/locales/zh/wizard.json</files>
  <action>
1. **Update ClassifiedError type** in `frontend/src/utils/errorClassifier.ts`:
   - Add `'ocr'` to the type union: `type: 'network' | 'timeout' | 'server' | 'validation' | 'config' | 'ocr'`

2. **Add OCR error detection** in `classifyError()` function:
   - Match "OCR" in message → type 'ocr'
   - Match "exceeds 5MB limit" → type 'validation' (existing, but ensure caught)
   - Match "timed out" already handled by timeout type
   
   Add before the default fallback:
   ```typescript
   // OCR-specific errors
   if (rawMessage.includes('OCR') || rawMessage.includes('503')) {
     return {
       type: 'ocr',
       titleKey: 'errors.ocr.title',
       messageKey: 'errors.ocr.message',
       rawMessage,
       retryable: false,
     };
   }
   ```

3. **Add i18n keys for OCR errors** in `frontend/src/i18n/locales/ja/wizard.json`:
   Under `errors` section, add:
   ```json
   "ocr": {
     "title": "処理エラー",
     "message": "ファイルの処理に失敗しました。スキャンしたPDFの場合は、より鮮明な画像で再度お試しください"
   }
   ```

4. **Add i18n keys for OCR errors** in `frontend/src/i18n/locales/zh/wizard.json`:
   Under `errors` section, add:
   ```json
   "ocr": {
     "title": "处理错误",
     "message": "文件处理失败。如果是扫描件PDF，请尝试使用更清晰的图像"
   }
   ```

5. **Update validation error message** to be more specific for file size:
   The existing validation error is sufficient — 422 for file size will use existing keys.

Do NOT mention "OCR" in user-facing messages — use generic terms like "processing" (処理/处理).
The progress indication is already handled by existing EXTRACTION_STAGES in UploadStep.tsx.
</action>
  <verify>`grep -A5 '"ocr":' frontend/src/i18n/locales/ja/wizard.json && grep "'ocr'" frontend/src/utils/errorClassifier.ts`</verify>
  <done>Error classifier handles OCR errors, both i18n files have OCR error messages, no "OCR" exposed to users</done>
</task>

<task type="auto">
  <name>Add unit tests for OCR service</name>
  <files>tests/test_ocr_service.py</files>
  <action>
Create `tests/test_ocr_service.py` with pytest tests for OCRService:

1. **Test is_image_based detection:**
   ```python
   def test_is_image_based_returns_true_for_short_text():
       service = OCRService()
       assert service.is_image_based("") == True
       assert service.is_image_based("short") == True
       assert service.is_image_based("a" * 99) == True
   
   def test_is_image_based_returns_false_for_long_text():
       service = OCRService()
       assert service.is_image_based("a" * 100) == False
       assert service.is_image_based("a" * 500) == False
   ```

2. **Test file size validation:**
   ```python
   @pytest.mark.asyncio
   async def test_process_pdf_rejects_oversized_file():
       service = OCRService()
       large_content = b"x" * (6 * 1024 * 1024)  # 6MB
       with pytest.raises(OCRError, match="exceeds 5MB"):
           await service.process_pdf(large_content, "")
   ```

3. **Test process_pdf returns original_text for text-based PDFs:**
   ```python
   @pytest.mark.asyncio
   async def test_process_pdf_returns_original_for_text_based():
       service = OCRService()
       long_text = "a" * 200
       result = await service.process_pdf(b"fake pdf", long_text)
       assert result == long_text
   ```

4. **Test OCRError exception:**
   ```python
   def test_ocr_error_message():
       error = OCRError("Test error message")
       assert str(error) == "Test error message"
   ```

5. **Skip actual OCR tests** (requires Tesseract installed):
   - Add pytest skip marker for tests that require actual Tesseract
   - Document that full OCR tests require local Tesseract installation

Use existing test patterns from `tests/` directory if any exist.
Use `pytest.mark.asyncio` decorator for async tests.
</action>
  <verify>`cd backend && python -m pytest tests/test_ocr_service.py -v`</verify>
  <done>Unit tests exist for OCRService covering detection, file size validation, and passthrough logic</done>
</task>

</tasks>

<verification>
1. Error classifier includes 'ocr' type
2. Both i18n files have errors.ocr keys
3. No "OCR" string in user-facing messages
4. Tests pass: `cd backend && python -m pytest tests/test_ocr_service.py -v`
</verification>

<success_criteria>
- classifyError() handles OCR-related errors with appropriate i18n keys
- Japanese and Chinese error messages added
- Unit tests cover detection logic, file size validation, and passthrough
- Tests pass without Tesseract installed (graceful skip for OCR-dependent tests)
</success_criteria>

<output>
After completion, create `.planning/phases/08-ocr-support/08-02-SUMMARY.md`
</output>
