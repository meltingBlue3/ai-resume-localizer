---
phase: 11-template-polish
plan: 02
type: execute
wave: 2
depends_on:
  - 11-01
files_modified:
  - backend/app/templates/rirekisho.html
autonomous: true
requirements:
  - RKTPL-01
  - RKTPL-02
  - RKTPL-03
  - RKTPL-05
  - RKTPL-06

must_haves:
  truths:
    - "Rirekisho displays full name with full-width space (U+3000) between family and given name"
    - "Rirekisho address section shows postal code (〒XXX-XXXX) before address text"
    - "Rirekisho work history shows position/title after company name"
    - "Rirekisho no longer has commute time, dependents, or spouse fields"
    - "Rirekisho preferences defaults to '貴社の規定に従います' when user has not entered preferences"
  artifacts:
    - path: "backend/app/templates/rirekisho.html"
      provides: "Polished rirekisho template with proper Japanese formatting"
      contains: "name_formatted"
  key_links:
    - from: "rirekisho.html"
      to: "prepare_context()"
      via: "data.personal_info.name_formatted"
      pattern: "name_formatted"
    - from: "rirekisho.html"
      to: "JpPersonalInfo"
      via: "data.personal_info.postal_code"
      pattern: "postal_code"
---

<objective>
Update rirekisho.html template to display formatted name, postal code, position in work history, remove unused fields, and fix default text.

Purpose: Ensure rirekisho (履歴書) PDF output follows proper Japanese formatting conventions.
Output: Updated rirekisho.html template with all Phase 11 rirekisho requirements addressed.
</objective>

<execution_context>
@/home/neukas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/neukas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-template-polish/11-RESEARCH.md

# Key files for this work
@backend/app/templates/rirekisho.html
</context>

<tasks>

<task type="auto">
  <name>Update name and address sections for proper Japanese formatting</name>
  <files>backend/app/templates/rirekisho.html</files>
  <action>
1. **Name formatting (RKTPL-01)** - Line 197:
   Change: `{{ data.personal_info.name | default('未記入', true) }}`
   To: `{{ data.personal_info.name_formatted | default(data.personal_info.name, true) | default('未記入', true) }}`
   
   This uses name_formatted (with U+3000) if available, falls back to original name.

2. **Postal code display (RKTPL-02)** - Lines 215-217:
   Change the address row from:
   ```html
   <tr class="address-row">
       <td style="vertical-align: middle;">現住所</td>
       <td>{{ data.personal_info.address | default('未記入', true) }}</td>
   </tr>
   ```
   To:
   ```html
   <tr class="address-row">
       <td style="vertical-align: middle;">現住所</td>
       <td>{% if data.personal_info.postal_code %}〒{{ data.personal_info.postal_code }}　{% endif %}{{ data.personal_info.address | default('未記入', true) }}</td>
   </tr>
   ```
   
   This displays postal code with 〒 prefix followed by full-width space before address.
   </action>
  <verify>
`grep -n "name_formatted\|postal_code" backend/app/templates/rirekisho.html` shows both fields used in template
  </verify>
  <done>Template uses name_formatted and displays postal code with 〒 prefix before address</done>
</task>

<task type="auto">
  <name>Add position/title to work history and remove unused fields</name>
  <files>backend/app/templates/rirekisho.html</files>
  <action>
1. **Position in work history (RKTPL-03)** - Lines 295-298 and 300-304:
   
   Change line 298 from:
   ```html
   <td>{{ entry.company | default('', true) }}　入社</td>
   ```
   To:
   ```html
   <td>{{ entry.company | default('', true) }}{% if entry.title %}　{{ entry.title }}{% endif %}　入社</td>
   ```
   
   Change line 304 from:
   ```html
   <td>{{ entry.company | default('', true) }}　退社</td>
   ```
   To:
   ```html
   <td>{{ entry.company | default('', true) }}{% if entry.title %}　{{ entry.title }}{% endif %}　退社</td>
   ```

2. **Remove commute/dependents table (RKTPL-05)** - Delete lines 383-409:
   Delete the entire `<table class="commute-table">` block including:
   - The commute-table CSS (lines 128-141) - also delete this from the style block
   - The entire commute-table HTML element (lines 383-409)

3. **Update preferences default text (RKTPL-06)** - Line 420:
   Change: `{{ data.other | default('貴社規定に従います。', true) }}`
   To: `{{ data.other | default('貴社の規定に従います', true) }}`
   
   Changes: add "の" after "貴社", remove trailing period "。"
  </action>
  <verify>
1. `grep -n "entry.title" backend/app/templates/rirekisho.html` shows title in work history rows
2. `grep -c "commute-table" backend/app/templates/rirekisho.html` returns 0 (fully removed)
3. `grep "貴社の規定に従います" backend/app/templates/rirekisho.html` shows updated default text
  </verify>
  <done>Work history shows position, commute table removed, preferences default text updated to proper Japanese</done>
</task>

</tasks>

<verification>
1. Generate a test PDF with rirekisho template to verify:
   - Name displays with full-width space
   - Postal code appears before address
   - Work history shows position after company
   - No commute/dependents/spouse section on page 2
   - Preferences shows correct default text
2. Run backend tests if available: `pytest backend/tests/ -v`
</verification>

<success_criteria>
- Rirekisho uses name_formatted with U+3000 separator
- Postal code displayed as 〒XXX-XXXX before address
- Work history entries show position/title after company name
- Commute time, dependents, and spouse fields completely removed
- Preferences defaults to "貴社の規定に従います" (with の, no period)
</success_criteria>

<output>
After completion, create `.planning/phases/11-template-polish/11-02-SUMMARY.md`
</output>
