---
phase: 11-template-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/resume.py
  - workflow/resume_translation.yml
  - backend/app/services/template_renderer.py
  - backend/app/templates/shokumukeirekisho.html
autonomous: true
requirements:
  - RKTPL-01
  - RKTPL-02
  - SKTPL-02

must_haves:
  truths:
    - "JpPersonalInfo model has a postal_code field"
    - "Dify translation workflow outputs postal_code in personal_info"
    - "prepare_context() formats name with U+3000 separator"
    - "Shokumukeirekisho displays 現在 for ongoing positions"
  artifacts:
    - path: "backend/app/models/resume.py"
      provides: "JpPersonalInfo with postal_code field"
      contains: "postal_code"
    - path: "workflow/resume_translation.yml"
      provides: "Updated LLM prompt with postal_code extraction"
      contains: "postal_code"
    - path: "backend/app/services/template_renderer.py"
      provides: "Name formatting and end_date normalization"
    - path: "backend/app/templates/shokumukeirekisho.html"
      provides: "Displays 現在 for ongoing positions"
      contains: "現在"
  key_links:
    - from: "Dify workflow"
      to: "JpPersonalInfo"
      via: "JSON output parsing"
      pattern: "postal_code.*field"
    - from: "prepare_context()"
      to: "rirekisho.html"
      via: "name_formatted field"
    - from: "prepare_context()"
      to: "shokumukeirekisho.html"
      via: "end_date normalization"
      pattern: "end_date.*None"
---

<objective>
Add postal_code field to data model and Dify workflow; update prepare_context() for name formatting (U+3000) and end_date normalization ("none" → null).

Purpose: Enable proper Japanese name display and postal code rendering in templates; fix "none" string appearing instead of "現在" for ongoing positions.
Output: Updated model, workflow, and renderer with proper data transformations.
</objective>

<execution_context>
@/home/neukas/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/neukas/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-template-polish/11-RESEARCH.md

# Key files for this work
@backend/app/models/resume.py
@backend/app/services/template_renderer.py
@workflow/resume_translation.yml
@workflow/DESIGN_PRINCIPLES.md
</context>

<tasks>

<task type="auto">
  <name>Add postal_code field to JpPersonalInfo model</name>
  <files>backend/app/models/resume.py</files>
  <action>
Add `postal_code: str | None = None` field to the JpPersonalInfo class (line 59-67).
Insert after the `address` field (line 65) for logical grouping with address information.
  </action>
  <verify>`grep -n "postal_code" backend/app/models/resume.py` shows the new field in JpPersonalInfo</verify>
  <done>JpPersonalInfo model has postal_code field matching other optional string fields pattern</done>
</task>

<task type="auto">
  <name>Update Dify translation workflow to extract postal_code</name>
  <files>workflow/resume_translation.yml</files>
  <action>
Update the LLM system prompt in resume_translation.yml to include postal_code extraction:

1. In the 出力形式（JpResumeData）section, add postal_code to personal_info block (after address):
```
"postal_code": "郵便番号（住所から抽出。例：123-4567。不明な場合はnull）",
```

2. In the 個人情報 section of 入力形式（CnResumeData）, note that address may contain postal code.

3. In the 翻訳・変換ルール section, add:
```
### 郵便番号
- address フィールドに含まれる郵便番号を抽出し、postal_code に出力
- 形式：XXX-XXXX（ハイフン区切り）
- 郵便番号が不明な場合は null とする
```

Follow DESIGN_PRINCIPLES.md: extract only what exists in source, use null if unknown.
  </action>
  <verify>`grep -A2 "postal_code" workflow/resume_translation.yml` shows the field in both the output schema and extraction rules</verify>
  <done>Dify workflow LLM prompt instructs extraction of postal_code from address into separate field</done>
</task>

<task type="auto">
  <name>Update prepare_context() for name formatting and end_date normalization</name>
  <files>backend/app/services/template_renderer.py</files>
  <action>
Modify the `prepare_context()` function to add two transformations:

1. **Name formatting (RKTPL-01)**: After normalizing personal_info (line 97-98), add:
```python
# Format name with full-width space (U+3000) separator
if data.get("personal_info") and data["personal_info"].get("name"):
    parts = data["personal_info"]["name"].split()
    if len(parts) >= 2:
        data["personal_info"]["name_formatted"] = "\u3000".join(parts[:2])
    else:
        data["personal_info"]["name_formatted"] = data["personal_info"]["name"]
```

2. **End date normalization (SKTPL-02)**: After normalizing work_history (line 101-102), add:
```python
# Normalize "none"/"null" strings to None for end_date
for entry in data["work_history"]:
    if entry.get("end_date"):
        end_val = entry["end_date"]
        if isinstance(end_val, str) and end_val.lower() in ("none", "null", ""):
            entry["end_date"] = None
```

This must happen BEFORE the work_history_processed loop so both raw and processed entries have normalized end_date.
  </action>
  <verify>
`grep -n "name_formatted\|end_date.*None" backend/app/services/template_renderer.py` shows both transformations in prepare_context()
  </verify>
  <done>prepare_context() creates name_formatted field and normalizes string "none"/"null" to None for end_date</done>
</task>

<task type="auto">
  <name>Update shokumukeirekisho.html to display 現在 for ongoing positions</name>
  <files>backend/app/templates/shokumukeirekisho.html</files>
  <action>
Update the template to display '現在' (present) when end_date is None or empty, indicating an ongoing position.

Find the work history section that displays end dates and change from:
```html
{{ entry.end_date | default('', true) }}
```
To:
```html
{{ entry.end_date if entry.end_date else '現在' }}
```

Or if using a different pattern, ensure that when end_date is falsy (None, empty string), the template displays '現在' instead of blank or 'none'.

This completes SKTPL-02 by making the user-observable behavior: ongoing positions show "現在" in the shokumukeirekisho PDF.
  </action>
  <verify>
`grep -n "現在" backend/app/templates/shokumukeirekisho.html` shows the template displays 現在 for empty end_date
  </verify>
  <done>Shokumukeirekisho template displays '現在' for positions where end_date is None or empty</done>
</task>

</tasks>

<verification>
1. Run `python -c "from app.models.resume import JpPersonalInfo; print(JpPersonalInfo.model_fields)"` to verify postal_code field exists
2. Run backend tests if available: `pytest backend/tests/ -v`
3. Verify workflow YML is valid YAML syntax
</verification>

<success_criteria>
- JpPersonalInfo has postal_code field
- Dify workflow prompt includes postal_code extraction instructions
- prepare_context() creates name_formatted with U+3000 separator
- prepare_context() normalizes "none"/"null" strings to None
- Shokumukeirekisho displays "現在" for positions with no end_date
</success_criteria>

<output>
After completion, create `.planning/phases/11-template-polish/11-01-SUMMARY.md`
</output>
