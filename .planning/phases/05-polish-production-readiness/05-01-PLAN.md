---
phase: 05-polish-production-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/utils/errorClassifier.ts
  - frontend/src/utils/completeness.ts
  - frontend/src/components/ui/CompletenessIndicator.tsx
  - frontend/src/components/ui/ErrorBanner.tsx
  - frontend/src/i18n/locales/zh/wizard.json
  - frontend/src/i18n/locales/ja/wizard.json
autonomous: true

must_haves:
  truths:
    - "Error classifier maps HTTP status codes and fetch failures to user-friendly i18n keys with retryable flag"
    - "Completeness utility counts filled vs total fields for both CnResumeData and JpResumeData"
    - "CompletenessIndicator renders a progress bar with filled/total label"
    - "ErrorBanner renders classified errors with type-specific styling, retry button, and dismiss button"
    - "All new UI text has both zh and ja i18n keys including progress stages, error messages, and completeness labels"
  artifacts:
    - path: "frontend/src/utils/errorClassifier.ts"
      provides: "classifyError function and ClassifiedError type"
      exports: ["classifyError", "ClassifiedError"]
    - path: "frontend/src/utils/completeness.ts"
      provides: "computeCompleteness function and CompletenessResult type"
      exports: ["computeCompleteness", "CompletenessResult"]
    - path: "frontend/src/components/ui/CompletenessIndicator.tsx"
      provides: "Reusable completeness bar component"
      exports: ["CompletenessIndicator"]
    - path: "frontend/src/components/ui/ErrorBanner.tsx"
      provides: "Reusable classified error banner component"
      exports: ["ErrorBanner"]
  key_links:
    - from: "frontend/src/utils/errorClassifier.ts"
      to: "frontend/src/i18n/locales/zh/wizard.json"
      via: "i18n key references in ClassifiedError titleKey/messageKey"
      pattern: "errors\\.(network|timeout|server|validation|config)"
    - from: "frontend/src/utils/completeness.ts"
      to: "frontend/src/types/resume.ts"
      via: "imports JpResumeData and CnResumeData types"
      pattern: "import.*from.*types/resume"
---

<objective>
Create the foundational utility modules and reusable UI components for Phase 5 polish: error classification, completeness calculation, and their corresponding React components. Add all i18n keys (progress stages, error messages, completeness labels) to both zh and ja locale files.

Purpose: These utilities and components are consumed by Plan 02 which integrates them into all step components. Building them first ensures clean separation of logic from presentation and prevents Plan 02 from becoming too large.

Output: 4 new files (errorClassifier.ts, completeness.ts, CompletenessIndicator.tsx, ErrorBanner.tsx) + 2 modified i18n files with all new keys.
</objective>

<execution_context>
@C:/Users/zhang/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-polish-production-readiness/05-RESEARCH.md
@frontend/src/types/resume.ts
@frontend/src/i18n/locales/zh/wizard.json
@frontend/src/i18n/locales/ja/wizard.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create utility modules and reusable components</name>
  <files>
    frontend/src/utils/errorClassifier.ts
    frontend/src/utils/completeness.ts
    frontend/src/components/ui/CompletenessIndicator.tsx
    frontend/src/components/ui/ErrorBanner.tsx
  </files>
  <action>
Create four new files:

**1. `frontend/src/utils/errorClassifier.ts`**

Export a `ClassifiedError` interface:
```typescript
export interface ClassifiedError {
  type: 'network' | 'timeout' | 'server' | 'validation' | 'config';
  titleKey: string;     // i18n key for error title
  messageKey: string;   // i18n key for user-facing guidance
  rawMessage: string;   // original error string for "show details"
  retryable: boolean;
}
```

Export a `classifyError(error: unknown): ClassifiedError` function that classifies errors:
- `TypeError` with message "Failed to fetch" or "NetworkError" => type: 'network', retryable: true
- Error message containing '504' or 'timed out' or 'timeout' => type: 'timeout', retryable: true
- Error message containing '503' or 'not configured' or 'API key' => type: 'config', retryable: false
- Error message containing '502' or 'Dify' or '500' => type: 'server', retryable: true
- Error message containing '422' or 'validation' => type: 'validation', retryable: false
- Default fallback => type: 'server', retryable: true

i18n key pattern: `errors.{type}.title` and `errors.{type}.message`. Also include `errors.unknown.title` / `errors.unknown.message` for the default fallback.

**2. `frontend/src/utils/completeness.ts`**

Export a `CompletenessResult` interface:
```typescript
export interface CompletenessResult {
  filled: number;
  total: number;
  percentage: number;
}
```

Export `computeCompleteness(data: JpResumeData | CnResumeData | null): CompletenessResult`.

Create a helper `isFilled(value: unknown): boolean` that returns false for null, undefined, empty string (after trim), and empty arrays; true otherwise.

For **JpResumeData**, count these top-level/flat fields:
- personal_info: name, name_katakana, birth_date, gender, address, phone, email (7 fields)
- summary (1 field)
- motivation (1 field)
- strengths (1 field)
- work_history: count as 1 field "has at least one entry" (not individual sub-fields)
- education: count as 1 field "has at least one entry"
- skills: count as 1 field "has at least one entry"
- certifications: count as 1 field "has at least one entry"
- other (1 field)
Total: 15 fields

For **CnResumeData**, count:
- name, phone, email, date_of_birth, address, nationality, gender (7 fields)
- education: 1 field (has entries)
- work_experience: 1 field (has entries)
- skills: 1 field (has entries)
- certifications: 1 field (has entries)
- languages: 1 field (has entries)
- self_introduction, career_objective, hobbies (3 fields)
Total: 15 fields

Use a type guard or duck-typing check to distinguish between JpResumeData and CnResumeData: if the data has `personal_info` property, treat as JpResumeData; otherwise treat as CnResumeData.

**3. `frontend/src/components/ui/CompletenessIndicator.tsx`**

A functional component accepting `{ filled: number; total: number; percentage: number }` props.

Uses `useTranslation('wizard')` to render the label text via `t('completeness.label', { filled, total, percentage })`.

Renders:
- A flex row with a progress bar (h-2 rounded-full bg-slate-200, inner div with transition-all duration-300) and a text label.
- Color: bg-green-500 if percentage >= 80, bg-amber-500 if >= 50, bg-red-400 otherwise.
- Label: compact text like "12/15 fields (80%)" using i18n interpolation.

**4. `frontend/src/components/ui/ErrorBanner.tsx`**

A functional component accepting `{ error: ClassifiedError; onRetry?: () => void; onDismiss?: () => void }` props.

Uses `useTranslation('wizard')`.

Renders a styled banner with:
- Type-specific border/background colors: network=orange, timeout=amber, server=red, validation=red, config=purple
- Title from `t(error.titleKey)`, message from `t(error.messageKey)`
- A "show details" toggle (useState boolean) that reveals `error.rawMessage` in a monospace text block
- Retry button (only if error.retryable AND onRetry provided) using `t('errors.retry')`
- Dismiss button (only if onDismiss provided) using `t('errors.dismiss')`

Do NOT use any new npm packages. All styling via Tailwind classes.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to confirm no type errors. Verify each file exports the expected symbols by checking the import resolution.
  </verify>
  <done>
All four files exist with correct TypeScript types, no compilation errors, and exports match the specification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add all Phase 5 i18n keys to both locale files</name>
  <files>
    frontend/src/i18n/locales/zh/wizard.json
    frontend/src/i18n/locales/ja/wizard.json
  </files>
  <action>
Add the following new key groups to BOTH zh/wizard.json and ja/wizard.json. Place them as top-level keys in the JSON (sibling to "steps", "reviewTranslation", "preview", etc.).

**1. Progress stage keys** (under `"progress"` object):

Chinese (zh):
```json
"progress": {
  "uploading": "正在上传文件...",
  "extractingText": "正在提取文本内容...",
  "aiAnalyzing": "AI 正在分析简历结构...",
  "almostDone": "即将完成，请稍候...",
  "translating": "正在翻译为日文...",
  "aiTranslating": "AI 正在进行专业翻译...",
  "localizing": "正在进行日本本地化处理...",
  "translationAlmostDone": "翻译即将完成..."
}
```

Japanese (ja):
```json
"progress": {
  "uploading": "ファイルをアップロード中...",
  "extractingText": "テキストを抽出中...",
  "aiAnalyzing": "AIが履歴書を分析中...",
  "almostDone": "まもなく完了します...",
  "translating": "日本語に翻訳中...",
  "aiTranslating": "AIが翻訳を処理中...",
  "localizing": "日本語ローカライズ処理中...",
  "translationAlmostDone": "翻訳がまもなく完了します..."
}
```

**2. Error keys** (under `"errors"` object):

Chinese (zh):
```json
"errors": {
  "network": {
    "title": "网络连接失败",
    "message": "无法连接到服务器，请检查网络连接后重试"
  },
  "timeout": {
    "title": "请求超时",
    "message": "AI处理时间较长，请稍后重试。如持续超时，可能需要简化简历内容"
  },
  "server": {
    "title": "服务器错误",
    "message": "AI服务暂时不可用，请稍后重试"
  },
  "validation": {
    "title": "数据验证失败",
    "message": "提交的数据格式有误，请检查简历文件是否正确"
  },
  "config": {
    "title": "服务未配置",
    "message": "AI服务尚未正确配置，请联系管理员"
  },
  "unknown": {
    "title": "未知错误",
    "message": "发生意外错误，请重试或刷新页面"
  },
  "retry": "重试",
  "dismiss": "关闭",
  "showDetails": "查看详情",
  "hideDetails": "隐藏详情"
}
```

Japanese (ja):
```json
"errors": {
  "network": {
    "title": "ネットワーク接続エラー",
    "message": "サーバーに接続できません。ネットワーク接続を確認して再試行してください"
  },
  "timeout": {
    "title": "リクエストタイムアウト",
    "message": "AI処理に時間がかかっています。しばらくしてから再試行してください"
  },
  "server": {
    "title": "サーバーエラー",
    "message": "AIサービスが一時的に利用できません。しばらくしてから再試行してください"
  },
  "validation": {
    "title": "データ検証エラー",
    "message": "送信されたデータの形式に問題があります。履歴書ファイルを確認してください"
  },
  "config": {
    "title": "サービス未設定",
    "message": "AIサービスが正しく設定されていません。管理者に連絡してください"
  },
  "unknown": {
    "title": "不明なエラー",
    "message": "予期しないエラーが発生しました。再試行するかページを更新してください"
  },
  "retry": "再試行",
  "dismiss": "閉じる",
  "showDetails": "詳細を表示",
  "hideDetails": "詳細を非表示"
}
```

**3. Completeness keys** (under `"completeness"` object):

Chinese (zh):
```json
"completeness": {
  "label": "已填写 {{filled}}/{{total}} 项（{{percentage}}%）"
}
```

Japanese (ja):
```json
"completeness": {
  "label": "{{filled}}/{{total}} 項目入力済み（{{percentage}}%）"
}
```

IMPORTANT: Preserve all existing keys. Only add the new top-level objects. Ensure valid JSON after editing (no trailing commas, proper nesting).
  </action>
  <verify>
Run `cd frontend && node -e "JSON.parse(require('fs').readFileSync('src/i18n/locales/zh/wizard.json','utf8')); console.log('zh OK')"` and same for ja to verify valid JSON. Manually confirm that "progress", "errors", and "completeness" keys exist in both files. Then run `npx tsc --noEmit` to verify no import/type breakage.
  </verify>
  <done>
Both zh/wizard.json and ja/wizard.json contain all new i18n keys (progress stages, error messages, completeness label) alongside all existing keys, with valid JSON syntax.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes with zero errors
2. All 4 new TypeScript files exist and export their named symbols
3. Both locale JSON files parse without error
4. New i18n keys cover: 8 progress stage keys, 6 error types (each with title+message), 4 error action keys, 1 completeness label key
</verification>

<success_criteria>
- errorClassifier.ts correctly maps all HTTP error patterns to ClassifiedError objects with i18n keys
- completeness.ts counts 15 fields for JpResumeData and 15 for CnResumeData, handling null/empty correctly
- CompletenessIndicator.tsx renders a color-coded progress bar with i18n label
- ErrorBanner.tsx renders type-specific colored banners with retry/dismiss/show-details
- All new UI text has matching keys in both zh and ja locale files
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-production-readiness/05-01-SUMMARY.md`
</output>
