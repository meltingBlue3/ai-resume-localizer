---
phase: 05-polish-production-readiness
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/steps/UploadStep.tsx
  - frontend/src/steps/ReviewTranslationStep.tsx
  - frontend/src/steps/PreviewStep.tsx
  - frontend/src/steps/DownloadStep.tsx
  - frontend/src/steps/ReviewExtractionStep.tsx
autonomous: false

must_haves:
  truths:
    - "User sees stage-specific progress messages that change over time during extraction (uploading -> extracting text -> AI analyzing -> almost done)"
    - "User sees stage-specific progress messages that change over time during translation (translating -> AI translating -> localizing -> almost done)"
    - "User sees classified error banners with actionable guidance (not raw backend messages) when any API call fails"
    - "User sees a completeness indicator showing filled field count on ReviewExtractionStep (CnResumeData) and ReviewTranslationStep/PreviewStep (JpResumeData)"
    - "Error banners offer retry for retryable errors and show-details toggle for technical info"
  artifacts:
    - path: "frontend/src/steps/UploadStep.tsx"
      provides: "Stage-specific extraction progress + classified error banner + no completeness (upload step)"
      contains: "useProgressStages|ErrorBanner|classifyError"
    - path: "frontend/src/steps/ReviewTranslationStep.tsx"
      provides: "Stage-specific translation progress + classified error banner + JpResumeData completeness"
      contains: "useProgressStages|ErrorBanner|CompletenessIndicator"
    - path: "frontend/src/steps/PreviewStep.tsx"
      provides: "Classified error banners for preview/download + JpResumeData completeness"
      contains: "ErrorBanner|CompletenessIndicator"
    - path: "frontend/src/steps/DownloadStep.tsx"
      provides: "Classified error banner for download failures"
      contains: "ErrorBanner|classifyError"
    - path: "frontend/src/steps/ReviewExtractionStep.tsx"
      provides: "CnResumeData completeness indicator"
      contains: "CompletenessIndicator|computeCompleteness"
  key_links:
    - from: "frontend/src/steps/UploadStep.tsx"
      to: "frontend/src/utils/errorClassifier.ts"
      via: "import classifyError"
      pattern: "import.*classifyError.*from.*errorClassifier"
    - from: "frontend/src/steps/ReviewTranslationStep.tsx"
      to: "frontend/src/components/ui/CompletenessIndicator.tsx"
      via: "import CompletenessIndicator"
      pattern: "import.*CompletenessIndicator"
    - from: "frontend/src/steps/PreviewStep.tsx"
      to: "frontend/src/components/ui/ErrorBanner.tsx"
      via: "import ErrorBanner"
      pattern: "import.*ErrorBanner"
---

<objective>
Integrate the utility modules and components from Plan 01 into all step components: add time-based progress stages to extraction and translation flows, replace raw error banners with classified ErrorBanner components, and display completeness indicators on review/preview steps. Then human-verify the full experience.

Purpose: This completes all three Phase 5 requirements (UXUI-06, UXUI-07, UXUI-08) by wiring the foundational pieces into the actual user-facing wizard steps.

Output: 5 modified step components with production-quality loading, error, and completeness UX.
</objective>

<execution_context>
@C:/Users/zhang/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-polish-production-readiness/05-RESEARCH.md
@.planning/phases/05-polish-production-readiness/05-01-SUMMARY.md
@frontend/src/steps/UploadStep.tsx
@frontend/src/steps/ReviewTranslationStep.tsx
@frontend/src/steps/PreviewStep.tsx
@frontend/src/steps/DownloadStep.tsx
@frontend/src/steps/ReviewExtractionStep.tsx
@frontend/src/utils/errorClassifier.ts
@frontend/src/utils/completeness.ts
@frontend/src/components/ui/CompletenessIndicator.tsx
@frontend/src/components/ui/ErrorBanner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stage-specific loading progress and classified errors to UploadStep and ReviewTranslationStep</name>
  <files>
    frontend/src/steps/UploadStep.tsx
    frontend/src/steps/ReviewTranslationStep.tsx
  </files>
  <action>
**UploadStep.tsx changes:**

1. Add imports: `{ useState, useEffect, useRef }` from react, `classifyError` from `../utils/errorClassifier`, `ErrorBanner` from `../components/ui/ErrorBanner`.

2. Create a `useProgressStages` custom hook (define inline in the file or as a module-level function) that accepts `(isActive: boolean, stages: { delay: number; key: string }[])` and returns `string | null`. Implementation:
   - Uses useState for currentStage, useRef for timer IDs
   - When isActive becomes true: sets first stage immediately, schedules remaining stages via setTimeout
   - When isActive becomes false or on cleanup: clears all timers and sets currentStage to null
   - CRITICAL: Return cleanup function from useEffect to clear timers on unmount

3. Define extraction stages array (outside component, stable reference):
```typescript
const EXTRACTION_STAGES = [
  { delay: 0, key: 'progress.uploading' },
  { delay: 2000, key: 'progress.extractingText' },
  { delay: 5000, key: 'progress.aiAnalyzing' },
  { delay: 15000, key: 'progress.almostDone' },
];
```

4. In the component: call `const currentStage = useProgressStages(isExtracting, EXTRACTION_STAGES);`

5. Replace the extracting button text: instead of `{t('steps.upload.extracting')}`, use `{t(currentStage ?? 'steps.upload.extracting')}`.

6. Add a `classifiedError` state: `const [classifiedError, setClassifiedError] = useState<ClassifiedError | null>(null)`.

7. In handleExtract catch block: instead of `setExtractionError(message)`, also call `setClassifiedError(classifyError(err))`. Keep setting extractionError too (for backward compat with store).

8. Replace the existing error banner JSX with:
```tsx
{classifiedError && (
  <ErrorBanner
    error={classifiedError}
    onRetry={handleExtract}
    onDismiss={() => { setClassifiedError(null); setExtractionError(null); }}
  />
)}
```

9. In handleExtract, at the start (before try): `setClassifiedError(null); setExtractionError(null);`

**ReviewTranslationStep.tsx changes:**

1. Add imports: `{ useState, useEffect, useRef }` from react, `classifyError` and `ClassifiedError` from `../utils/errorClassifier`, `ErrorBanner` from `../components/ui/ErrorBanner`, `computeCompleteness` from `../utils/completeness`, `CompletenessIndicator` from `../components/ui/CompletenessIndicator`.

2. Copy the same `useProgressStages` hook (or import from UploadStep if extracted to a shared file — preferred approach: create it as a named export in a new file `frontend/src/hooks/useProgressStages.ts` and import in both). If creating the hook file, add it to the files list.

   Actually, to keep within the 3-file scope, define `useProgressStages` inline in each component OR create a single shared hook file. Preferred: create `frontend/src/hooks/useProgressStages.ts` as a shared hook. This is a small addition (the file list in frontmatter is indicative, not exhaustive).

3. Define translation stages:
```typescript
const TRANSLATION_STAGES = [
  { delay: 0, key: 'progress.translating' },
  { delay: 2000, key: 'progress.aiTranslating' },
  { delay: 8000, key: 'progress.localizing' },
  { delay: 20000, key: 'progress.translationAlmostDone' },
];
```

4. Call `const currentStage = useProgressStages(isTranslating, TRANSLATION_STAGES);`

5. Replace the translating text in the button: use `{t(currentStage ?? 'reviewTranslation.translating')}` when isTranslating.

6. Also show stage text in the right panel placeholder when isTranslating (where it currently shows `t('reviewTranslation.translating')`).

7. Add `classifiedError` state. In handleTranslate catch: `setClassifiedError(classifyError(err))`. Clear at start of handleTranslate.

8. Replace the error banner with `<ErrorBanner error={classifiedError} onRetry={handleTranslate} onDismiss={...} />`.

9. Add completeness indicator for JpResumeData: compute `const completeness = computeCompleteness(jpResumeData);` and render `<CompletenessIndicator {...completeness} />` below the step title area (inside the header div, after the editHint paragraph), only when jpResumeData exists.

Create the shared hook file:

**`frontend/src/hooks/useProgressStages.ts`** (NEW):
```typescript
import { useState, useEffect, useRef } from 'react';

export function useProgressStages(
  isActive: boolean,
  stages: readonly { delay: number; key: string }[]
): string | null {
  const [currentStage, setCurrentStage] = useState<string | null>(null);
  const timersRef = useRef<ReturnType<typeof setTimeout>[]>([]);

  useEffect(() => {
    if (!isActive) {
      setCurrentStage(null);
      return;
    }

    setCurrentStage(stages[0]?.key ?? null);

    timersRef.current = stages.slice(1).map(({ delay, key }) =>
      setTimeout(() => setCurrentStage(key), delay)
    );

    return () => {
      timersRef.current.forEach(clearTimeout);
      timersRef.current = [];
    };
  }, [isActive, stages]);

  return currentStage;
}
```
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to verify no type errors. Run `npm run dev` and test:
1. Upload a file and click extract — observe the button text changing through 4 stages over ~15 seconds
2. Disconnect network (or use browser DevTools offline mode) and click extract — observe the classified error banner with orange "network" styling
3. On ReviewTranslationStep, click translate — observe stage progression in button text
4. After translation completes, observe the completeness indicator below the title
  </verify>
  <done>
UploadStep shows time-based progress stages during extraction and classified error banners on failure. ReviewTranslationStep shows progress stages during translation, classified errors, and a completeness indicator for JpResumeData. Timer cleanup prevents memory leaks on unmount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add classified errors and completeness to PreviewStep, DownloadStep, and ReviewExtractionStep</name>
  <files>
    frontend/src/steps/PreviewStep.tsx
    frontend/src/steps/DownloadStep.tsx
    frontend/src/steps/ReviewExtractionStep.tsx
  </files>
  <action>
**PreviewStep.tsx changes:**

1. Add imports: `classifyError`, `ClassifiedError`, `ErrorBanner`, `computeCompleteness`, `CompletenessIndicator`.

2. Replace `const [previewError, setPreviewError] = useState<string | null>(null)` with `const [previewError, setPreviewError] = useState<ClassifiedError | null>(null)`.

3. Replace `const [downloadError, setDownloadError] = useState<string | null>(null)` with `const [downloadError, setDownloadError] = useState<ClassifiedError | null>(null)`.

4. In `fetchPreview` catch: `setPreviewError(classifyError(err))` instead of raw message.

5. In `handleDownload` catch: `setDownloadError(classifyError(err))` instead of raw message.

6. In `fetchPreview` and `handleDownload` at start: clear error to null.

7. Replace both error banner JSX blocks with:
```tsx
{previewError && (
  <ErrorBanner
    error={previewError}
    onRetry={() => fetchPreview(activeDocTab, jpResumeData, croppedPhotoBase64)}
    onDismiss={() => setPreviewError(null)}
  />
)}
{downloadError && (
  <ErrorBanner
    error={downloadError}
    onRetry={() => handleDownload(activeDocTab)}
    onDismiss={() => setDownloadError(null)}
  />
)}
```

8. Add JpResumeData completeness indicator in the header area (below the description paragraph):
```tsx
{jpResumeData && (
  <CompletenessIndicator {...computeCompleteness(jpResumeData)} />
)}
```
Place it after the header div, before the error banners.

**DownloadStep.tsx changes:**

1. Add imports: `classifyError`, `ClassifiedError`, `ErrorBanner`.

2. Replace `const [downloadError, setDownloadError] = useState<string | null>(null)` with `const [downloadError, setDownloadError] = useState<ClassifiedError | null>(null)`.

3. In `handleDownload` catch: `setDownloadError(classifyError(err))`.

4. Replace the error banner JSX with:
```tsx
{downloadError && (
  <ErrorBanner
    error={downloadError}
    onRetry={() => handleDownload(downloadError.type === 'server' ? 'rirekisho' : 'rirekisho')}
    onDismiss={() => setDownloadError(null)}
  />
)}
```

Actually, since we don't know which docType failed, a simpler approach: store the last attempted docType in a ref or state, and retry that. Or just show the error without retry since the user can click the download button again. Better approach:

- Add `const lastDocType = useRef<'rirekisho' | 'shokumukeirekisho'>('rirekisho');`
- In handleDownload, set `lastDocType.current = docType;` at start
- In ErrorBanner onRetry: `() => handleDownload(lastDocType.current)`

5. Clear downloadError at start of handleDownload.

**ReviewExtractionStep.tsx changes:**

1. Add imports: `computeCompleteness` from `../utils/completeness`, `CompletenessIndicator` from `../components/ui/CompletenessIndicator`.

2. Read the existing component structure to find where cnResumeData is used. The component should already have access to cnResumeData from the store.

3. Add completeness for CnResumeData. Compute: `const completeness = computeCompleteness(cnResumeData);`

4. Render `<CompletenessIndicator {...completeness} />` in the header area — find the step title/description section and add it after the description text, only when cnResumeData exists. Place it below the "extractedData" panel header or below the step title area, whichever reads best.

Note: ReviewExtractionStep has a two-panel layout (original doc left, extracted data right). Place the completeness indicator at the top of the right panel (extracted data side), just above or below the panel header "提取结果".
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to verify no type errors. Run `npm run dev` and test:
1. PreviewStep: trigger a preview error (e.g., stop backend) — see classified error banner with retry
2. DownloadStep: trigger a download error — see classified error banner
3. ReviewExtractionStep: see completeness indicator showing CnResumeData field count
4. PreviewStep: see completeness indicator showing JpResumeData field count
  </verify>
  <done>
All five step components use classified error banners instead of raw error strings. ReviewExtractionStep shows CnResumeData completeness. PreviewStep shows JpResumeData completeness. All error banners offer retry for retryable errors and show-details for technical info.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 5 experience</name>
  <files>frontend/src/steps/UploadStep.tsx</files>
  <action>
Human verifies the complete Phase 5 polish — loading states, error handling, and completeness indicators across all wizard steps:
- UXUI-06: Multi-stage progress messages during extraction (4 stages over 15s) and translation (4 stages over 20s)
- UXUI-07: Classified error banners with type-specific colors, actionable messages, retry buttons, and show-details toggles
- UXUI-08: Completeness indicators on ReviewExtractionStep (CnResumeData), ReviewTranslationStep (JpResumeData), and PreviewStep (JpResumeData)

Start the dev servers if not running:
```bash
cd backend && python -m uvicorn app.main:app --port 8000
cd frontend && npm run dev
```
Open http://localhost:5173

**Test 1 - Loading stages (UXUI-06):**
1. Upload a resume file and click "提取简历信息"
2. Watch the button text — it should cycle through: "正在上传文件..." -> "正在提取文本内容..." -> "AI 正在分析简历结构..." -> "即将完成，请稍候..."
3. Go to ReviewTranslation step and click "开始翻译"
4. Watch the button text cycle through 4 translation stages
5. Expected: Messages change at ~2s, ~5s, ~15s intervals (extraction) and ~2s, ~8s, ~20s (translation)

**Test 2 - Error handling (UXUI-07):**
1. Stop the backend server, then try to extract a resume
2. Expected: Orange "网络连接失败" banner appears with retry button
3. Click "查看详情" — should show raw error message
4. Click retry — error should clear and attempt again
5. Click "关闭" — banner should dismiss
6. Switch language to Japanese — error text should be in Japanese

**Test 3 - Completeness indicator (UXUI-08):**
1. Complete extraction, go to ReviewExtractionStep
2. Expected: A progress bar showing "已填写 X/15 项 (Y%)" near the extracted data panel
3. Edit a field to empty — percentage should decrease
4. Go to ReviewTranslation after translation
5. Expected: Progress bar showing JpResumeData completeness
6. Go to PreviewStep
7. Expected: Same JpResumeData completeness indicator visible

**Test 4 - Language switching:**
1. Switch between Chinese and Japanese at any step
2. Expected: All progress stages, error messages, and completeness labels switch language correctly

**Test 5 - No regressions:**
1. Complete full flow: upload -> extract -> review -> translate -> review -> preview -> download
2. Expected: All existing functionality still works correctly
  </action>
  <verify>All 5 test categories pass. No console errors. No regressions in existing flow.</verify>
  <done>Phase 5 complete — all three requirements (UXUI-06, UXUI-07, UXUI-08) verified by human testing.</done>
</task>

</tasks>

<verification>
Phase-level verification:
1. `cd frontend && npx tsc --noEmit` passes
2. Full wizard flow works end-to-end without regressions
3. Loading stages cycle through 4 messages during extraction and 4 during translation
4. All error banners show classified messages (not raw backend strings) with appropriate colors
5. Completeness indicators appear on ReviewExtraction, ReviewTranslation, and Preview steps
6. All new text displays correctly in both Chinese and Japanese
7. Timer cleanup works — no console warnings about state updates on unmounted components
</verification>

<success_criteria>
- UXUI-06: User sees descriptive loading states with stage-specific progress messages during AI extraction and translation processing
- UXUI-07: System displays clear, actionable error messages when Dify API calls or other operations fail, without crashing or losing user data
- UXUI-08: User can see a completeness indicator showing what percentage of resume fields are filled at any point in the workflow
- No regressions in existing Phase 1-4 functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-production-readiness/05-02-SUMMARY.md`
</output>
