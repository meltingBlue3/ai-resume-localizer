---
phase: 07-workflow-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - workflow/resume_extraction.yml
  - workflow/resume_translation.yml
autonomous: false
requirements: [WKFL-01, WKFL-02, WKFL-03]

must_haves:
  truths:
    - "The Dify extraction workflow code node strips <think>...</think> tags before JSON validation"
    - "The extraction prompt distinguishes project_experience from work_experience and never classifies personal projects as employment"
    - "The extraction prompt enforces chronological ordering (earliest first) for work and education entries"
    - "The extraction prompt outputs 'null' for ongoing end_date fields, never the string 'None'"
    - "The extraction prompt captures certifications like CET-6 from the languages field"
    - "The translation prompt produces varied sentence endings, not repetitive ~しました throughout"
    - "The translation prompt uses standard business keigo (丁寧語 + 謙譲語) adapted to Japanese resume conventions"
    - "The translation workflow code node strips <think>...</think> tags before JSON validation"
  artifacts:
    - path: "workflow/resume_extraction.yml"
      provides: "Updated extraction workflow with CoT stripping and improved prompt"
      contains: "<think>"
    - path: "workflow/resume_translation.yml"
      provides: "Updated translation workflow with CoT stripping and improved prompt"
      contains: "<think>"
  key_links:
    - from: "workflow/resume_extraction.yml (code node)"
      to: "backend DifyClient.extract_resume()"
      via: "structured_resume output variable"
      pattern: "structured_resume"
    - from: "workflow/resume_translation.yml (code node)"
      to: "backend DifyClient.translate_resume()"
      via: "jp_resume_json output variable"
      pattern: "jp_resume_json"
---

<objective>
Update the Dify extraction and translation workflow YML files to strip CoT `<think>` tags in the code nodes and improve prompts for better field coverage, chronological accuracy, and natural business Japanese.

Purpose: The current Dify workflows leak `<think>...</think>` chain-of-thought tokens that break JSON parsing, produce phantom job entries from project experience, output "None" literals instead of null, miss extractable certifications, and generate mechanical repetitive Japanese phrasing.

Output: Updated `workflow/resume_extraction.yml` and `workflow/resume_translation.yml` ready for re-import into Dify Cloud.
</objective>

<execution_context>
@C:/Users/zhang/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-workflow-quality/07-CONTEXT.md

# Current workflow files (primary modification targets)
@workflow/resume_extraction.yml
@workflow/resume_translation.yml

# Backend models (reference for field structure)
@backend/app/models/resume.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update extraction workflow — CoT stripping and improved prompt</name>
  <files>workflow/resume_extraction.yml</files>
  <action>
Two changes to the extraction workflow YML:

**A) Code node (Node 3 "清洗 JSON 输出") — add CoT stripping before markdown removal:**

Add a regex line to strip `<think>...</think>` blocks (including multiline) BEFORE the existing markdown stripping. Use `re.DOTALL` flag so `.` matches newlines:

```python
# Strip chain-of-thought tags (some models wrap reasoning in <think>...</think>)
text = re.sub(r'<think>.*?</think>', '', text, flags=re.DOTALL)
text = text.strip()
```

This goes right after `text = llm_text.strip()` and before the markdown code block stripping.

**B) LLM prompt (Node 2 system prompt) — improve extraction quality:**

Update the system prompt to address the specific issues identified. Key changes to the extraction rules section:

1. **Distinguish project vs work experience explicitly:**
   Add a rule: "个人项目、课程项目、开源项目等归入 project_experience，不得出现在 work_experience 中。work_experience 仅包含有公司/雇主名称的正式雇佣关系（含实习）。"

2. **Chronological ordering — earliest first:**
   Change rule 4 from "按时间倒序排列（最近的在前）" to "按时间正序排列（最早的在前），即入学/入职时间较早的排在数组前面。这是日本履歴書的标准顺序。"

3. **Null handling for ongoing dates:**
   Add a rule: "在职/在读的结束日期 end_date 必须填 null（JSON null），不得填字符串 'None'、'现在'、'至今' 等。"

4. **Certification extraction from languages:**
   Add a rule: "语言能力中包含的证书信息（如 CET-4、CET-6、JLPT N1、TOEIC 等）应同时提取到 certifications 数组中，包含 name（证书全称）和 date（如简历中提到获得时间）。"

5. **Date of birth extraction:**
   Add a rule: "出生日期 date_of_birth 必须尽力提取。如简历中有年龄信息，可据此推算。"

6. **Add explicit instruction not to output `<think>` tags:**
   Append to the rules: "不要输出任何思考过程，不要使用 <think> 标签，只输出纯 JSON。"

Keep the existing rules that are still valid (null for missing fields, date format YYYY-MM, skills preservation, JSON-only output).
  </action>
  <verify>
1. Open `workflow/resume_extraction.yml` and verify the code node contains the `re.sub(r'<think>.*?</think>'...)` line
2. Verify the system prompt contains rules about project_experience vs work_experience distinction
3. Verify chronological ordering is specified as earliest-first (正序)
4. Verify the null/None end_date rule is present
5. Verify CET-6 certification extraction rule is present
6. Verify the anti-think-tag instruction is in the prompt
7. Validate YAML is syntactically correct: `python -c "import yaml; yaml.safe_load(open('workflow/resume_extraction.yml', encoding='utf-8'))"`
  </verify>
  <done>
The extraction workflow YML has CoT stripping in the code node and all 6 prompt improvements addressing phantom jobs, chronology, None literals, certification extraction, birth date extraction, and explicit no-think-tag instruction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update translation workflow — CoT stripping and improved prompts</name>
  <files>workflow/resume_translation.yml</files>
  <action>
Three changes to the translation workflow YML:

**A) Code node (Node 4 "清洗 JSON 输出") — add CoT stripping:**

Same as extraction workflow — add `re.sub(r'<think>.*?</think>', '', text, flags=re.DOTALL)` after `text = llm_text.strip()` and before the markdown stripping.

**B) LLM 核心翻訳 prompt (Node 2) — improve translation quality:**

Update the translation rules section to address identified issues:

1. **end_date handling:**
   Change rule about null maintenance to explicitly state: "在職中の end_date は null を維持する。文字列 'None' は絶対に出力しないこと。"

2. **Chronological ordering for 履歴書:**
   Change rule 6 from "時間逆順（最新が先）" to "時間正順（最も古いものが先）— 日本の履歴書の標準記載順序に従う"

3. **project_experience handling:**
   Clarify rule about project_experience: "project_experience は work_history に統合しない。project_experience のアイテムはそのまま除外する（元の work_experience のみを work_history に変換する）。プロジェクト経験は other フィールドに簡潔に記載してもよい。"

4. **Add no-think-tag instruction:**
   Append: "思考過程を出力しないこと。`<think>` タグを使用しないこと。JSON のみを出力すること。"

**C) LLM 日本本地化 prompt (Node 3) — improve Japanese quality:**

Update the localization prompt to address mechanical phrasing:

1. **Varied sentence endings (key issue from CONTEXT.md):**
   Add a new section "### 8. 文末表現の多様化" with instructions:
   "responsibilities の各項目は、以下のような多様な文末パターンを使い分けること。同じ文末表現が3回以上連続しないようにする：
   - 「〜を担当しました」
   - 「〜に従事しました」
   - 「〜の設計・実装を行いました」
   - 「〜を推進しました」
   - 「〜に取り組みました」
   - 「〜を実現しました」
   - 「〜に貢献しました」

   同じ「〜しました」「〜を行いました」の繰り返しは避け、自然で読みやすい文章にすること。"

2. **Mixed language cleanup:**
   Add a section "### 9. 用語の統一" with instructions:
   "日本語と英語が不自然に混在する表現（例：「仕様開発Spec」）は避け、一貫した表記にすること。技術用語は日本のIT業界で一般的なカタカナ表記または英語表記のどちらかに統一する（例：「仕様書」または「Specification」、混在させない）。"

3. **Add no-think-tag instruction:**
   Append to output rules: "思考過程を出力しないこと。`<think>` タグを使用しないこと。JSON のみを出力すること。"
  </action>
  <verify>
1. Open `workflow/resume_translation.yml` and verify the code node contains CoT stripping regex
2. Verify Node 2 prompt has updated end_date null rule, chronological ordering, and project_experience exclusion
3. Verify Node 3 prompt has the new section 8 (文末表現の多様化) with varied sentence pattern examples
4. Verify Node 3 prompt has the new section 9 (用語の統一) about mixed language cleanup
5. Verify anti-think-tag instructions in both Node 2 and Node 3 prompts
6. Validate YAML: `python -c "import yaml; yaml.safe_load(open('workflow/resume_translation.yml', encoding='utf-8'))"`
  </verify>
  <done>
The translation workflow YML has CoT stripping in the code node and all prompt improvements addressing end_date None literals, chronological ordering, project_experience exclusion, varied sentence endings, mixed language cleanup, and explicit no-think-tag instructions.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Re-import updated workflows into Dify Cloud</name>
  <action>The updated YML files must be manually imported into the Dify Cloud dashboard since Claude cannot access the Dify UI.</action>
  <instructions>
1. Open Dify Cloud dashboard (https://cloud.dify.ai)
2. Navigate to the extraction workflow ("中文简历结构化提取")
3. Use the import/update feature to re-import `workflow/resume_extraction.yml`
4. If Dify doesn't support in-place import: create a new workflow from the YML, copy the API key from the old workflow, update `.env` with the new `DIFY_EXTRACTION_API_KEY` if the key changes
5. Repeat for the translation workflow ("日文简历翻译与本地化") with `workflow/resume_translation.yml` and `DIFY_TRANSLATION_API_KEY`
6. Verify both workflows are active and the model selection (gpt-4o / claude-3-5-sonnet) is correct in the Dify UI
  </instructions>
  <resume-signal>Type "imported" once both workflows are updated in Dify Cloud, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Both YML files parse as valid YAML without errors
2. Both code nodes contain `re.sub(r'<think>.*?</think>'...)` CoT stripping regex
3. Extraction prompt contains all 6 quality improvements (project vs work distinction, chronological ordering, null end_date, certification extraction, birth date extraction, no-think-tag)
4. Translation core prompt contains end_date null rule, chronological ordering, project_experience exclusion
5. Translation localization prompt contains varied sentence endings section and mixed language cleanup section
6. After Dify re-import: a test resume upload should produce clean JSON without `<think>` tags and with correct field coverage
</verification>

<success_criteria>
- workflow/resume_extraction.yml updated with CoT stripping and 6 prompt improvements
- workflow/resume_translation.yml updated with CoT stripping and 5 prompt improvements
- Both files are valid YAML
- Workflows re-imported into Dify Cloud and functional
</success_criteria>

<output>
After completion, create `.planning/phases/07-workflow-quality/07-01-SUMMARY.md`
</output>
