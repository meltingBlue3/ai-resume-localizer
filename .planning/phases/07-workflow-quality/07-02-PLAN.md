---
phase: 07-workflow-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/dify_client.py
  - backend/tests/test_dify_cot_stripping.py
autonomous: true
requirements:
  - WKFL-04

must_haves:
  truths:
    - "Backend strips <think>...</think> tags from Dify response strings before JSON parsing"
    - "Backend logs a warning when CoT stripping safety net activates"
    - "Clean JSON strings (no CoT tags) pass through stripping unchanged"
    - "JSON parsing does not fail on responses that originally contained CoT tags"
  artifacts:
    - path: "backend/app/services/dify_client.py"
      provides: "CoT stripping safety net in both extract_resume and translate_resume"
      contains: "strip_cot_tags"
    - path: "backend/tests/test_dify_cot_stripping.py"
      provides: "Unit tests for CoT stripping logic"
      contains: "test_strip"
  key_links:
    - from: "backend/app/services/dify_client.py"
      to: "json.loads"
      via: "strip_cot_tags called before json.loads"
      pattern: "strip_cot.*json\\.loads|re\\.sub.*think"
---

<objective>
Add a backend safety net that strips `<think>...</think>` CoT tags from Dify API responses before JSON parsing in DifyClient.

Purpose: Defense in depth — even if Dify workflow prompts instruct no CoT output, reasoning models may still emit `<think>` blocks. The backend must handle this gracefully rather than failing on JSON parse. Per user decision: two-layer CoT stripping (workflow + backend), and log when safety net activates.

Output: Updated `dify_client.py` with CoT stripping, plus unit tests.
</objective>

<execution_context>
@C:/Users/zhang/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-workflow-quality/07-CONTEXT.md
@backend/app/services/dify_client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CoT stripping safety net to DifyClient</name>
  <files>backend/app/services/dify_client.py</files>
  <action>
Add a private helper method `_strip_cot_tags(self, text: str) -> str` to DifyClient that:

1. Uses `re.sub(r'<think>[\s\S]*?</think>', '', text, flags=re.DOTALL)` to strip all `<think>...</think>` blocks
2. If any stripping occurred (original != result), logs a warning: `logger.warning("CoT safety net activated: stripped <think> tags from Dify response")`
3. Returns the stripped text (`.strip()` to remove leading/trailing whitespace left behind)

Import `re` at the top of the file (already has `import json` and `import logging`).

Then modify both `extract_resume()` and `translate_resume()` methods:

In `extract_resume()`, after getting `structured` from outputs and checking it's not None, but BEFORE the `isinstance(structured, str)` check and `json.loads()` call:
```python
if isinstance(structured, str):
    structured = self._strip_cot_tags(structured)
    try:
        structured = json.loads(structured)
    ...
```

In `translate_resume()`, same pattern for `jp_resume_json`:
```python
if isinstance(jp_resume_json, str):
    jp_resume_json = self._strip_cot_tags(jp_resume_json)
    try:
        jp_resume_json = json.loads(jp_resume_json)
    ...
```

The key change: insert `self._strip_cot_tags()` call before `json.loads()` in both methods. The existing `isinstance(structured, str)` block already handles the string case — just add the stripping call inside it before json.loads.
  </action>
  <verify>
    `python -c "import ast; ast.parse(open('backend/app/services/dify_client.py').read())"` — valid Python syntax.
    Grep for `_strip_cot_tags` — appears in class definition and is called in both extract_resume and translate_resume.
    Grep for `logger.warning` — confirms logging when safety net activates.
  </verify>
  <done>
    DifyClient._strip_cot_tags() exists and is called before json.loads() in both extract_resume() and translate_resume(). Logs a warning when CoT tags are found and stripped.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for CoT stripping</name>
  <files>backend/tests/test_dify_cot_stripping.py</files>
  <action>
Create `backend/tests/test_dify_cot_stripping.py` with pytest tests for the CoT stripping logic.

Tests:
1. `test_strip_cot_tags_removes_think_block` — Input with `<think>reasoning here</think>{"key": "value"}` → returns `{"key": "value"}`
2. `test_strip_cot_tags_multiline_think` — Input with multiline `<think>\nline1\nline2\n</think>{"key": "value"}` → returns `{"key": "value"}`
3. `test_strip_cot_tags_no_think_unchanged` — Input `{"key": "value"}` (no think tags) → returns same string unchanged
4. `test_strip_cot_tags_multiple_think_blocks` — Input with multiple `<think>...</think>` blocks → all stripped
5. `test_strip_cot_tags_logs_warning` — When think tags are stripped, verify logger.warning is called (use `caplog` or mock)

Instantiate DifyClient with a dummy API key for testing the method directly:
```python
from backend.app.services.dify_client import DifyClient

client = DifyClient(api_key="test-key")
result = client._strip_cot_tags(input_text)
```

Do NOT test extract_resume/translate_resume (those need HTTP mocking). Only test the _strip_cot_tags method in isolation.

Run tests with: `cd backend && python -m pytest tests/test_dify_cot_stripping.py -v`
  </action>
  <verify>
    `cd backend && python -m pytest tests/test_dify_cot_stripping.py -v` — all tests pass.
  </verify>
  <done>
    5 unit tests exist and pass, covering: single think block removal, multiline think block, clean passthrough, multiple blocks, and warning logging.
  </done>
</task>

</tasks>

<verification>
1. `python -c "import ast; ast.parse(open('backend/app/services/dify_client.py').read())"` succeeds
2. `cd backend && python -m pytest tests/test_dify_cot_stripping.py -v` — all 5 tests pass
3. Grep confirms _strip_cot_tags is called before json.loads in both extract_resume and translate_resume
4. Grep confirms logger.warning exists for CoT safety net activation
</verification>

<success_criteria>
- DifyClient strips CoT tags before JSON parsing in both methods
- Warning logged when safety net activates
- Clean strings pass through unchanged
- 5 unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-workflow-quality/07-02-SUMMARY.md`
</output>
