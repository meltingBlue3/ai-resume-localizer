---
phase: 07-workflow-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/dify_client.py
autonomous: true
requirements: [WKFL-04]

must_haves:
  truths:
    - "Any <think>...</think> tags in Dify API response text are stripped before JSON parsing"
    - "When CoT tags are stripped, the event is logged with the stripped content for monitoring"
    - "If JSON is still malformed after CoT stripping, a DifyWorkflowError is raised immediately with no retry"
    - "Clean JSON responses (no CoT tags) parse successfully without any behavior change"
  artifacts:
    - path: "backend/app/services/dify_client.py"
      provides: "CoT stripping safety net in both extract_resume and translate_resume"
      contains: "<think>"
  key_links:
    - from: "backend/app/services/dify_client.py"
      to: "backend/app/api/routes/upload.py"
      via: "extract_resume() return value"
      pattern: "client.extract_resume"
    - from: "backend/app/services/dify_client.py"
      to: "backend/app/api/routes/translate.py"
      via: "translate_resume() return value"
      pattern: "client.translate_resume"
---

<objective>
Add a backend safety net that strips residual `<think>...</think>` chain-of-thought tags from Dify API responses before JSON parsing, with logging for monitoring.

Purpose: Even with CoT stripping in the Dify workflow code nodes (WKFL-01), some models may still leak think tags. This defense-in-depth approach ensures the backend never fails due to CoT contamination, and logs when the safety net activates so we can monitor Dify workflow reliability.

Output: Updated `backend/app/services/dify_client.py` with CoT stripping in both `extract_resume` and `translate_resume` methods.
</objective>

<execution_context>
@C:/Users/zhang/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-workflow-quality/07-CONTEXT.md

# Primary modification target
@backend/app/services/dify_client.py

# Route files that consume dify_client (no changes needed, reference only)
@backend/app/api/routes/upload.py
@backend/app/api/routes/translate.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CoT stripping safety net to DifyClient</name>
  <files>backend/app/services/dify_client.py</files>
  <action>
Add a private helper method `_strip_cot_tags` to the `DifyClient` class and call it in both `extract_resume` and `translate_resume` before JSON parsing.

**1. Add `import re` at the top of the file** (alongside existing `import json`).

**2. Add the helper method to DifyClient:**

```python
def _strip_cot_tags(self, text: str, context: str) -> str:
    """Strip <think>...</think> chain-of-thought tags from LLM output.

    Args:
        text: Raw LLM output string.
        context: Description of which workflow produced this (for logging).

    Returns:
        Text with CoT tags removed. Unchanged if no tags found.
    """
    cleaned = re.sub(r'<think>.*?</think>', '', text, flags=re.DOTALL)
    if cleaned != text:
        stripped_content = text[:200]  # Log preview of what was stripped
        logger.warning(
            "CoT tags stripped from %s response (safety net activated). "
            "Preview: %s",
            context,
            stripped_content,
        )
        cleaned = cleaned.strip()
    return cleaned
```

**3. In `extract_resume`, call `_strip_cot_tags` before `json.loads`:**

After the line `if isinstance(structured, str):`, before the `try: structured = json.loads(structured)`, add:
```python
structured = self._strip_cot_tags(structured, "extraction")
```

**4. In `translate_resume`, call `_strip_cot_tags` before `json.loads`:**

After the line `if isinstance(jp_resume_json, str):`, before the `try: jp_resume_json = json.loads(jp_resume_json)`, add:
```python
jp_resume_json = self._strip_cot_tags(jp_resume_json, "translation")
```

**5. Error behavior:** No changes to the existing `json.JSONDecodeError` handling. Per user decision, if JSON is still malformed after stripping, the existing `DifyWorkflowError` is raised immediately with no automatic retries.
  </action>
  <verify>
1. Read `backend/app/services/dify_client.py` and verify:
   - `import re` is present
   - `_strip_cot_tags` method exists with logging
   - Both `extract_resume` and `translate_resume` call `_strip_cot_tags` before `json.loads`
2. Run a syntax check: `python -c "import ast; ast.parse(open('backend/app/services/dify_client.py').read()); print('OK')"`
3. Verify the existing error handling is preserved (DifyWorkflowError on bad JSON)
  </verify>
  <done>
The DifyClient has a `_strip_cot_tags` safety net method that strips `<think>...</think>` tags with logging, called before JSON parsing in both extract_resume and translate_resume. Clean responses pass through unchanged. Malformed JSON after stripping still raises DifyWorkflowError immediately.
  </done>
</task>

</tasks>

<verification>
1. `backend/app/services/dify_client.py` contains `import re` and `_strip_cot_tags` method
2. Both `extract_resume` and `translate_resume` call the stripping method before `json.loads`
3. Logger warning is emitted when CoT tags are actually stripped
4. Clean responses (no CoT tags) pass through with zero behavior change
5. Python syntax is valid
</verification>

<success_criteria>
- Backend DifyClient strips `<think>...</think>` tags from both extraction and translation responses as a safety net
- Stripping events are logged at WARNING level with a content preview
- Clean responses are unaffected
- Malformed JSON after stripping raises DifyWorkflowError immediately (no retry)
</success_criteria>

<output>
After completion, create `.planning/phases/07-workflow-quality/07-02-SUMMARY.md`
</output>
