---
phase: 03-translation-data-processing
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
  - 03-02
files_modified:
  - frontend/src/components/review/ResumeFieldEditor.tsx
  - frontend/src/components/review/JpResumeFieldEditor.tsx
  - frontend/src/components/ui/FieldTooltip.tsx
  - frontend/src/steps/ReviewTranslationStep.tsx
  - frontend/src/App.tsx
  - frontend/src/i18n/locales/zh/wizard.json
  - frontend/src/i18n/locales/ja/wizard.json
autonomous: false

must_haves:
  truths:
    - "User can trigger Japanese translation from the ReviewTranslation step by clicking a translate button"
    - "Chinese fields display read-only on the left panel; Japanese fields are editable on the right panel"
    - "Education degree fields in the right panel show the Japanese equivalent as helper text (mapDegreeToJapanese)"
    - "Date fields in the right panel show 和暦 format below the editable Gregorian input (toWareki)"
    - "Culture tip tooltips appear on relevant field labels (name_katakana, summary, motivation, degree)"
    - "User without cnResumeData is redirected to step 1 (no-data guard)"
    - "Edited Japanese fields persist in useResumeStore when navigating to the next step"
  artifacts:
    - path: "frontend/src/components/review/ResumeFieldEditor.tsx"
      provides: "readOnly prop — renders <p> instead of <input> when readOnly=true"
      contains: "readOnly"
    - path: "frontend/src/components/review/JpResumeFieldEditor.tsx"
      provides: "Editable form for JpResumeData with wareki display and degree mapping"
      contains: "JpResumeFieldEditor"
    - path: "frontend/src/components/ui/FieldTooltip.tsx"
      provides: "Radix Tooltip wrapper component for culture tips"
      contains: "FieldTooltip"
    - path: "frontend/src/steps/ReviewTranslationStep.tsx"
      provides: "Side-by-side review layout replacing placeholder"
      contains: "ReviewTranslationStep"
    - path: "frontend/src/App.tsx"
      provides: "TooltipProvider wrapping app root"
      contains: "TooltipProvider"
  key_links:
    - from: "frontend/src/steps/ReviewTranslationStep.tsx"
      to: "frontend/src/api/client.ts"
      via: "translateResume() called on button click, result passed to setJpResumeData"
      pattern: "translateResume"
    - from: "frontend/src/components/review/JpResumeFieldEditor.tsx"
      to: "frontend/src/utils/wareki.ts"
      via: "toWareki() called on date fields for 和暦 display text"
      pattern: "toWareki"
    - from: "frontend/src/components/review/JpResumeFieldEditor.tsx"
      to: "frontend/src/utils/credentials.ts"
      via: "mapDegreeToJapanese() called on education degree fields for helper text"
      pattern: "mapDegreeToJapanese"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/ui/FieldTooltip.tsx"
      via: "TooltipProvider at app root required for Radix tooltips to function"
      pattern: "TooltipProvider"
---

<objective>
Build the complete ReviewTranslation UI: add readOnly prop to ResumeFieldEditor, create JpResumeFieldEditor with wareki date display and credential mapping helper text, create FieldTooltip with culture tips, replace the ReviewTranslationStep placeholder with the real side-by-side layout, and add TooltipProvider to App.tsx. Ends with a human verification checkpoint confirming the complete Phase 3 flow works end-to-end.

Purpose: This is the user-facing deliverable of Phase 3. The extraction review established the left-panel/right-panel pattern (Phase 2). This plan mirrors that pattern but with read-only Chinese on the left and editable Japanese on the right.
Output: Functional ReviewTranslationStep with translation trigger, dual-panel review, wareki dates, degree helper text, and culture tip tooltips.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-translation-data-processing/03-RESEARCH.md
@.planning/phases/02-upload-extraction/02-03-SUMMARY.md
@.planning/phases/03-translation-data-processing/03-01-SUMMARY.md
@.planning/phases/03-translation-data-processing/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: readOnly prop on ResumeFieldEditor, JpResumeFieldEditor, FieldTooltip, App.tsx TooltipProvider, i18n keys</name>
  <files>
    frontend/src/components/review/ResumeFieldEditor.tsx
    frontend/src/components/review/JpResumeFieldEditor.tsx
    frontend/src/components/ui/FieldTooltip.tsx
    frontend/src/App.tsx
    frontend/src/i18n/locales/zh/wizard.json
    frontend/src/i18n/locales/ja/wizard.json
  </files>
  <action>
**ResumeFieldEditor.tsx** — Add `readOnly?: boolean` prop to the component props interface. When readOnly is true:
- Replace `<input>` elements with `<p className="text-sm text-gray-800 py-1">` (or similar read-only styling)
- Replace `<textarea>` with `<p className="text-sm text-gray-800 py-1 whitespace-pre-wrap">`
- Hide the add/remove array item buttons (conditional render: `{!readOnly && <button>...`)
- The component structure (collapsible sections, labels, layout) stays the same — only input elements change

**JpResumeFieldEditor.tsx** — Create new file. Mirrors ResumeFieldEditor structure but for JpResumeData (always editable). Key differences from ResumeFieldEditor:

1. Props: `data: JpResumeData; onChange: (updated: JpResumeData) => void`
2. Uses JpResumeData field names (personal_info, work_history, education, skills, certifications, summary, motivation, strengths, other)
3. personal_info section includes `name_katakana` field with FieldTooltip on its label
4. Education degree field: below the editable input, show `<p className="text-xs text-blue-600">{mapDegreeToJapanese(entry.degree)}</p>` as helper text when degree has a value and mapDegreeToJapanese returns a different string than input
5. Date fields (start_date, end_date, birth_date, certification date): below the editable input, show `<p className="text-xs text-gray-500">{toWareki(value)}</p>` as 和暦 helper text when value is non-empty
6. summary and motivation fields: add FieldTooltip on their labels
7. onChange pattern: use same immutable update helpers pattern as ResumeFieldEditor (spread for nested updates, map for array items)
8. Use `t()` for all labels — add keys to i18n JSONs in this task

Import: `import { toWareki } from '../../utils/wareki'` and `import { mapDegreeToJapanese } from '../../utils/credentials'`

**FieldTooltip.tsx** — Create new file at `frontend/src/components/ui/FieldTooltip.tsx`:

```typescript
import * as Tooltip from '@radix-ui/react-tooltip';

interface FieldTooltipProps {
  content: string;
  children: React.ReactNode;
}

export function FieldTooltip({ content, children }: FieldTooltipProps) {
  if (!content) return <>{children}</>;

  return (
    <Tooltip.Root>
      <Tooltip.Trigger asChild>
        <span className="inline-flex items-center gap-1 cursor-help">
          {children}
          <span className="text-blue-400 text-xs">ⓘ</span>
        </span>
      </Tooltip.Trigger>
      <Tooltip.Portal>
        <Tooltip.Content
          className="z-50 max-w-xs rounded-md bg-gray-900 px-3 py-2 text-xs text-white shadow-lg"
          sideOffset={4}
        >
          {content}
          <Tooltip.Arrow className="fill-gray-900" />
        </Tooltip.Content>
      </Tooltip.Portal>
    </Tooltip.Root>
  );
}
```

**App.tsx** — Wrap the app root (inside BrowserRouter, outside WizardShell) with `<Tooltip.Provider delayDuration={300}>`. Import: `import * as Tooltip from '@radix-ui/react-tooltip'`. The TooltipProvider MUST be an ancestor of all FieldTooltip instances — place it high in the tree. Do not place it inside individual components.

**i18n JSON (zh/wizard.json and ja/wizard.json)** — Add a `reviewTranslation` section and a `cultureTips` section. Required keys:

```json
// zh/wizard.json additions:
"reviewTranslation": {
  "title": "翻译审核",
  "chinesePanel": "中文原文",
  "japanesePanel": "日文翻译",
  "translateButton": "开始翻译",
  "retranslateButton": "重新翻译",
  "translating": "正在翻译...",
  "editHint": "您可以直接编辑日文字段",
  "proceedButton": "确认并继续"
},
"cultureTips": {
  "name_katakana": "日本简历必须填写姓名的片假名读音。中国人名通常按姓名顺序转写。",
  "summary": "职务概要应使用敬体（です・ます调），简洁概述经验和专长，3-5句话。",
  "motivation": "志望动机使用谦逊语气，避免以金钱或晋升为理由，强调对公司使命的认同。",
  "degree": "日本企业通常认可：学士→大学卒業，硕士→大学院修了（修士），博士→大学院修了（博士）。",
  "skills": "技能栏列出具体技术和工具名称，并尽量附上使用年数（例：Python 3年）。",
  "certifications": "日语能力考试（JLPT）等日本相关资质会显著增加竞争力，请在此列出。"
},

// ja/wizard.json additions (mirror with Japanese text):
"reviewTranslation": {
  "title": "翻訳レビュー",
  "chinesePanel": "中国語原文",
  "japanesePanel": "日本語翻訳",
  "translateButton": "翻訳を開始",
  "retranslateButton": "再翻訳",
  "translating": "翻訳中...",
  "editHint": "日本語フィールドは直接編集できます",
  "proceedButton": "確認して次へ"
},
"cultureTips": {
  "name_katakana": "日本の履歴書では氏名のフリガナ（カタカナ）が必須です。",
  "summary": "職務概要はです・ます調で、経験・専門スキルを3〜5文で簡潔に記述します。",
  "motivation": "志望動機は謙譲語を使い、給与や昇進ではなく企業理念への共感を示します。",
  "degree": "日本企業の基準：学士→大学卒業、修士→大学院修了（修士）、博士→大学院修了（博士）。",
  "skills": "具体的なツール・技術名を記載し、使用年数を添えると効果的です（例：Python 3年）。",
  "certifications": "JLPT等の日本関連資格は採用担当者に好印象を与えます。"
}
```

Add all JpResumeFieldEditor field labels to both i18n files — follow the existing reviewExtraction label naming convention in wizard.json. Labels needed: nameKatakana, birthDate, gender, nationality, summary, motivation, strengths, school, degree, major, startDate, endDate, company, title, responsibilities, achievements, category, skills, certName, issuer, date, score.
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` — no TypeScript errors in any new or modified files.
Run: `cd frontend && npm run build` — build succeeds (confirms @radix-ui/react-tooltip resolves correctly).
Visual check: App.tsx wraps root with TooltipProvider. FieldTooltip renders ⓘ icon in browser.
  </verify>
  <done>
ResumeFieldEditor accepts readOnly prop and renders non-editable content when set. JpResumeFieldEditor renders all JpResumeData fields with wareki helpers on date fields and degree mapping on education fields. FieldTooltip renders correctly with Radix portal. App.tsx has TooltipProvider. Both i18n files have reviewTranslation and cultureTips keys. TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace ReviewTranslationStep placeholder with side-by-side translation review layout</name>
  <files>
    frontend/src/steps/ReviewTranslationStep.tsx
  </files>
  <action>
Replace the placeholder ReviewTranslationStep with the real implementation. Use ReviewExtractionStep as the structural reference (same two-panel grid, same scrolling strategy):

**Layout structure:**
```
<div className="flex flex-col h-[calc(100vh-16rem)]">
  {/* Top bar: title + translate button */}
  <div className="flex items-center justify-between mb-4">
    <h2>{t('wizard:reviewTranslation.title')}</h2>
    <button onClick={handleTranslate} disabled={isTranslating}>
      {isTranslating ? t('wizard:reviewTranslation.translating') : (jpResumeData ? t('wizard:reviewTranslation.retranslateButton') : t('wizard:reviewTranslation.translateButton'))}
    </button>
  </div>

  {/* Error banner */}
  {translationError && <div className="...error banner...">{translationError}</div>}

  {/* Two-panel grid */}
  <div className="grid lg:grid-cols-2 gap-4 flex-1 overflow-hidden">
    {/* Left: Chinese read-only */}
    <div className="overflow-y-auto border rounded-lg p-4">
      <h3>{t('wizard:reviewTranslation.chinesePanel')}</h3>
      {cnResumeData && <ResumeFieldEditor data={cnResumeData} onChange={() => {}} readOnly={true} />}
    </div>

    {/* Right: Japanese editable */}
    <div className="overflow-y-auto border rounded-lg p-4">
      <h3>{t('wizard:reviewTranslation.japanesePanel')}</h3>
      {jpResumeData
        ? <JpResumeFieldEditor data={jpResumeData} onChange={setJpResumeData} />
        : <p className="text-gray-400 text-sm">{/* empty state: click translate */}</p>
      }
    </div>
  </div>
</div>
```

**handleTranslate function:**
```typescript
const handleTranslate = async () => {
  if (!cnResumeData) return;
  setIsTranslating(true);
  setTranslationError(null);
  try {
    const result = await translateResume(cnResumeData);
    setJpResumeData(result);
  } catch (err) {
    setTranslationError(err instanceof Error ? err.message : 'Translation failed');
  } finally {
    setIsTranslating(false);
  }
};
```

**No-data guard:** If `!cnResumeData`, render a message prompting the user to go back to the Upload step (same pattern as ReviewExtractionStep's no-data guard).

**Store reads:**
```typescript
const { cnResumeData, jpResumeData, setJpResumeData, isTranslating, setIsTranslating, translationError, setTranslationError } = useResumeStore();
```

**Navigation:** The existing StepNavigation component handles "Back" and "Next" buttons at the wizard shell level — do NOT add separate navigation buttons inside the step. The step only needs to handle the translate action.

**Culture tips on panels:** Add FieldTooltip to the "日語翻訳" panel header label and within JpResumeFieldEditor via the i18n keys (the tooltip content comes from t('wizard:cultureTips.name_katakana') etc., passed to JpResumeFieldEditor as props or used directly inside JpResumeFieldEditor).

Imports needed:
```typescript
import { useTranslation } from 'react-i18next';
import { useResumeStore } from '../stores/useResumeStore';
import { translateResume } from '../api/client';
import { ResumeFieldEditor } from '../components/review/ResumeFieldEditor';
import { JpResumeFieldEditor } from '../components/review/JpResumeFieldEditor';
```
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` — no TypeScript errors.
Run: `cd frontend && npm run dev` — dev server starts without errors.
Browser check: Navigate to step 3 (ReviewTranslation). Two panels visible. Without cnResumeData: shows no-data guard. With cnResumeData (from a previous extract): Chinese fields visible on left, translate button in top bar.
  </verify>
  <done>
ReviewTranslationStep renders two-panel layout. Chinese fields appear read-only on left. Translate button triggers handleTranslate() with loading state. Japanese fields appear in right panel after translation. Error banner shows if translation fails. No-data guard redirects if cnResumeData is absent.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification — complete Phase 3 translation flow</name>
  <what-built>
Complete Phase 3 translation flow:
- Backend POST /api/translate endpoint calling Dify translation workflow
- toWareki() utility converting Gregorian dates to 和暦 format
- mapDegreeToJapanese() utility for credential mapping
- JpResumeFieldEditor with wareki helper text and degree mapping
- FieldTooltip with culture tips on relevant fields
- ReviewTranslationStep side-by-side layout (read-only Chinese left, editable Japanese right)
  </what-built>
  <how-to-verify>
**Prerequisites:** DIFY_TRANSLATION_API_KEY must be set in backend/.env and the Dify translation workflow must exist.

1. Start backend: `cd backend && uvicorn app.main:app --reload`
2. Start frontend: `cd frontend && npm run dev`
3. Open http://localhost:5173 in browser

**Test 1 — Translation trigger:**
- Upload a Chinese resume PDF/DOCX (or use existing extraction from previous session)
- Navigate to step 3 "Review Translation"
- Click the "开始翻译" button
- Expected: loading spinner appears, then Japanese fields populate in the right panel

**Test 2 — Side-by-side review:**
- Verify: Chinese fields on left are read-only (cannot type in them)
- Verify: Japanese fields on right are editable (click a field and type)
- Verify: Both panels scroll independently

**Test 3 — 和暦 dates:**
- Look at date fields in the right Japanese panel (work history start/end dates, education dates)
- Expected: Below the editable date input (showing YYYY/MM), a gray helper text shows the 和暦 equivalent (e.g., "令和3年4月")
- If any date is around May 2019, verify it shows "令和元年" (not "令和1年")

**Test 4 — Degree mapping:**
- Look at an education entry in the right panel
- Expected: Below the degree input, blue helper text shows the Japanese equivalent (e.g., "大学卒業（学士）")

**Test 5 — Culture tips:**
- Hover over the ⓘ icon next to "フリガナ" / name_katakana label
- Expected: Tooltip appears with cultural context text
- Hover over ⓘ next to "職務概要" / summary label
- Expected: Tooltip appears explaining keigo usage

**Test 6 — Edit persistence:**
- Edit a Japanese field (e.g., change a work title)
- Navigate to step 4 and back to step 3
- Expected: Your edit is preserved

**Test 7 — Error handling:**
- Temporarily break DIFY_TRANSLATION_API_KEY (or use wrong key)
- Click translate
- Expected: Error banner appears with descriptive message, no crash
  </how-to-verify>
  <resume-signal>
Type "approved" to proceed to Phase 4 planning. Or describe any issues found during verification.
  </resume-signal>
  <action>Human verification — follow the how-to-verify steps above.</action>
  <verify>All 7 test cases pass as described in how-to-verify.</verify>
  <done>User types "approved" confirming the complete Phase 3 translation flow works end-to-end.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors across all modified files.
2. `npm run build` produces successful production build.
3. Human verification checkpoint confirms end-to-end flow: upload → extract → translate → review → edit Japanese fields.
4. 和暦 dates display correctly (gannen edge case: 2019/05 → 令和元年5月).
5. Degree mapping helper text appears on education entries.
6. Culture tip tooltips appear on name_katakana, summary, and motivation fields.
7. No-data guard sends user back to upload when cnResumeData is absent.
</verification>

<success_criteria>
- ResumeFieldEditor renders non-editable content when readOnly=true (Phase 2 editor reused safely)
- JpResumeFieldEditor covers all JpResumeData sections with wareki and degree helpers
- FieldTooltip renders Radix tooltip with correct portal (no clipping issues)
- App.tsx wraps root with TooltipProvider (required for all tooltips to function)
- ReviewTranslationStep: translation trigger, loading state, error banner, no-data guard, dual-panel scrolling
- Both i18n files have reviewTranslation and cultureTips keys
- Human verification: complete Phase 3 flow approved
</success_criteria>

<output>
After completion, create `.planning/phases/03-translation-data-processing/03-03-SUMMARY.md`
</output>
