---
phase: 12-replace-weasyprint-with-playwright
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/Dockerfile
  - backend/app/services/pdf_generator.py
autonomous: false
requirements: []
user_setup: []
must_haves:
  truths:
    - "generate_pdf() function returns valid PDF bytes when called"
    - "PDF output renders CJK characters correctly (Japanese text readable)"
    - "PDF output uses A4 page format with print_background enabled"
    - "Docker image builds successfully with Playwright chromium installed"
    - "No WeasyPrint dependencies remain in requirements.txt"
  artifacts:
    - path: "backend/requirements.txt"
      provides: "Python dependencies"
      contains: "playwright"
      not_contains: "weasyprint"
    - path: "backend/Dockerfile"
      provides: "Docker image with Playwright"
      contains: "playwright install chromium"
    - path: "backend/app/services/pdf_generator.py"
      provides: "PDF generation service"
      contains: "from playwright.sync_api import sync_playwright"
  key_links:
    - from: "backend/app/api/routes/preview.py"
      to: "backend/app/services/pdf_generator.py"
      via: "generate_pdf(html) call"
      pattern: "generate_pdf\\(html\\)"
    - from: "backend/app/services/pdf_generator.py"
      to: "Playwright sync API"
      via: "sync_playwright context manager"
      pattern: "sync_playwright\\(\\)"
---

<objective>
Replace WeasyPrint with Playwright for PDF generation, simplifying dependencies and improving rendering reliability.

Purpose: WeasyPrint requires complex GTK/Pango/Cairo dependencies (MSYS2 on Windows, many apt packages in Docker). Playwright uses headless Chrome for rendering - simpler setup, better CSS support, same HTML templates work.

Output: Working PDF generation using Playwright sync API with chromium browser.
</objective>

<execution_context>
@C:/Users/zhang/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/zhang/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Locked Technical Decisions (from planning context)

1. **Use Playwright sync API** (not async) - FastAPI endpoints are sync-compatible
2. **page.pdf() parameters**: `format='A4'`, `print_background=True`
3. **Fonts**: Install fonts-noto-cjk in Docker, rely on system font stack (no custom font loading)
4. **Browser**: Install only chromium (not firefox/webkit) to keep image small
5. **Templates unchanged**: Existing Jinja2 templates work with browser rendering

## Current Implementation (to be replaced)

@backend/app/services/pdf_generator.py - Uses WeasyPrint with:
- FontConfiguration for CJK fonts
- Noto Sans JP fonts loaded via file:// URLs
- Windows-specific MSYS2 DLL directory setup
- CSS string injection for @font-face rules

## API Contract (preserve)

```python
def generate_pdf(html_content: str, base_css_path: Path | None = None) -> bytes
```

Called by: `backend/app/api/routes/preview.py` line 88
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update requirements.txt</name>
  <files>backend/requirements.txt</files>
  <action>
Replace `weasyprint==63.1` with `playwright` (no version pin needed - uses latest stable).

Remove line:
```
weasyprint==63.1
```

Add line:
```
playwright
```

The rest of requirements.txt stays unchanged.
  </action>
  <verify>grep -q "playwright" backend/requirements.txt && ! grep -q "weasyprint" backend/requirements.txt</verify>
  <done>requirements.txt contains playwright, no weasyprint</done>
</task>

<task type="auto">
  <name>Task 2: Update Dockerfile</name>
  <files>backend/Dockerfile</files>
  <action>
Replace WeasyPrint system dependencies with Playwright chromium setup.

Remove these apt packages (WeasyPrint deps):
- libpango-1.0-0, libpangocairo-1.0-0, libpangoft2-1.0-0
- libgdk-pixbuf-2.0-0, libcairo2, libffi-dev, libglib2.0-0, libgobject-2.0-0
- shared-mime-info

Keep these (needed for other features):
- fonts-noto-cjk (CJK fonts for PDF rendering)
- gcc (for Python package compilation)
- tesseract-ocr, tesseract-ocr-jpn, tesseract-ocr-chi-sim (OCR)
- poppler-utils (PDF processing)

Add after pip install:
```dockerfile
RUN playwright install chromium --with-deps
```

The `--with-deps` flag installs required system libraries for chromium.

Final apt-get should be:
```
RUN apt-get update && apt-get install -y --no-install-recommends \
    fonts-noto-cjk \
    gcc \
    tesseract-ocr \
    tesseract-ocr-jpn \
    tesseract-ocr-chi-sim \
    poppler-utils \
    && rm -rf /var/lib/apt/lists/*
```

Remove the font download step since fonts-noto-cjk provides system fonts:
```dockerfile
RUN python -m app.fonts.download_fonts
```
This line should be removed.
  </action>
  <verify>grep -q "playwright install chromium" backend/Dockerfile && ! grep -q "libpango" backend/Dockerfile</verify>
  <done>Dockerfile installs playwright chromium with deps, removed WeasyPrint packages</done>
</task>

<task type="auto">
  <name>Task 3: Rewrite pdf_generator.py for Playwright</name>
  <files>backend/app/services/pdf_generator.py</files>
  <action>
Completely rewrite the file to use Playwright sync API instead of WeasyPrint.

New implementation:

```python
import logging
from pathlib import Path

from playwright.sync_api import sync_playwright

from app.config import TEMPLATES_DIR

logger = logging.getLogger(__name__)


def generate_pdf(html_content: str, base_css_path: Path | None = None) -> bytes:
    """Render HTML content to PDF bytes using Playwright headless Chrome.

    Args:
        html_content: The HTML string to render.
        base_css_path: Optional path to a base CSS file (ignored - CSS should be in HTML).

    Returns:
        PDF file contents as bytes.
    """
    if base_css_path is None:
        base_css_path = TEMPLATES_DIR / "base.css"
    
    if base_css_path.exists():
        css_content = base_css_path.read_text(encoding="utf-8")
        html_with_css = f"<style>{css_content}</style>{html_content}"
    else:
        html_with_css = html_content

    with sync_playwright() as p:
        browser = p.chromium.launch()
        page = browser.new_page()
        page.set_content(html_with_css)
        
        try:
            pdf_bytes = page.pdf(
                format="A4",
                print_background=True,
            )
        except Exception:
            logger.exception("Playwright PDF generation failed")
            raise
        finally:
            browser.close()

    return pdf_bytes


def generate_pdf_from_template(template_name: str) -> bytes:
    """Read an HTML template file and render it to PDF.

    Args:
        template_name: Filename of the template (e.g. "rirekisho.html").

    Returns:
        PDF file contents as bytes.
    """
    template_path = TEMPLATES_DIR / template_name
    html_content = template_path.read_text(encoding="utf-8")
    base_css_path = TEMPLATES_DIR / "base.css"
    return generate_pdf(html_content, base_css_path=base_css_path)
```

Key changes from WeasyPrint:
- Remove all Windows MSYS2 DLL setup code
- Remove FontConfiguration and @font-face CSS injection
- Use sync_playwright() context manager
- Launch chromium, create page, set content, call page.pdf()
- CSS is inlined into HTML before rendering
- System fonts (fonts-noto-cjk) handle CJK rendering
  </action>
  <verify>python -c "from app.services.pdf_generator import generate_pdf; print('import ok')"</verify>
  <done>pdf_generator.py uses Playwright sync API, same function signature</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify PDF generation works</name>
  <what-built>Complete Playwright PDF generation replacement:
- requirements.txt updated (playwright instead of weasyprint)
- Dockerfile updated (chromium install, removed GTK deps)
- pdf_generator.py rewritten (sync API, no font config)
  </what-built>
  <how-to-verify>
1. **Build Docker image:**
   ```bash
   docker-compose build backend
   ```
   Should succeed without errors.

2. **Start services:**
   ```bash
   docker-compose up
   ```

3. **Test PDF generation:**
   - Open the app at http://localhost:3000
   - Upload a resume, go through the wizard
   - Download both PDFs (履歴書 and 職務経歴書)
   - Verify PDFs open correctly and Japanese text renders properly
   - Check that layout/styling matches previous output

4. **Verify no WeasyPrint:**
   ```bash
   docker-compose exec backend pip list | grep -i weasy
   ```
   Should return nothing.
  </how-to-verify>
  <resume-signal>Type "approved" if PDFs render correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] requirements.txt has playwright, no weasyprint
- [ ] Dockerfile installs chromium with --with-deps
- [ ] Dockerfile removed GTK/Pango packages
- [ ] pdf_generator.py imports from playwright.sync_api
- [ ] pdf_generator.py preserves generate_pdf() signature
- [ ] Docker image builds successfully
- [ ] PDF downloads work with Japanese text rendering
</verification>

<success_criteria>
1. Docker image builds without WeasyPrint-related errors
2. `generate_pdf()` function works with same API contract
3. PDF output renders CJK characters correctly
4. PDF output is A4 format with backgrounds printed
5. No WeasyPrint packages in final Docker image
</success_criteria>

<output>
After completion, create `.planning/phases/12-replace-weasyprint-with-playwright/12-01-SUMMARY.md`
</output>
